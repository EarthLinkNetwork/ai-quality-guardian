# Quality Guardian ワークフロー

このドキュメントは、Quality Guardianプロジェクトでの開発・PR・デプロイワークフローを記載します。

---

## 1. 開発フロー

### 1.1 基本フロー

```
開発前:
1. 設計書の作成
2. テスト計画書の作成

開発中:
3. テストを先に書く（TDD）
4. 実装
5. テスト確認

開発後:
6. E2Eテストで動作確認
7. テストが通ることを確認
8. Commit
9. 次のタスクへ（確認を待たない）
```

### 1.2 Test First原則

**必ずテストを先に書く:**

```
1. テスト作成（失敗することを確認）
2. 実装
3. テスト成功を確認
```

---

## 2. PRレビュー対応ワークフロー

### 2.1 PRレビュー指摘への完全対応義務

**Pull Requestのレビュー指摘を受けた場合、全ての指摘に対応する。一部だけ対応して終わることを禁止。**

### 2.2 対応フロー

```
1. 全ての指摘を一覧化
2. 各指摘に対する対応方針を決定
3. 対応を実施（全て）
4. 対応完了を報告（全指摘の対応状況を含める）
5. 再レビューを依頼
```

### 2.3 PR内容の完全把握・まとめ義務

**Pull Requestの実装内容をまとめる際、全ての実装項目を確認し、漏れなく記載する。**

```
# PRまとめテンプレート

## 実装内容
- [ ] 機能A: 説明
- [ ] 機能B: 説明
- [ ] 機能C: 説明

## テスト状況
- [ ] lint通過
- [ ] test通過
- [ ] typecheck通過
- [ ] build通過

## 動作確認
- [ ] ローカルで動作確認済み
- [ ] E2Eテスト通過
```

---

## 3. PR作業完了報告前の確認義務

**PR関連の作業完了後、必ず以下を確認してから「完了しました」と報告する。**

### 3.1 必須確認項目

```bash
# 1. ローカルコミットの確認
git log --oneline -1

# 2. PRの最新コミット確認
gh pr view <PR番号> --json commits --jq '.commits[-1].oid'

# 3. 両方が一致することを確認

# 4. 一致してから「完了しました」と報告
```

### 3.2 厳守事項

- git commitが失敗していないか確認（pre-commit hookエラー等）
- PRに実際にpushされたか確認
- ユーザーから「PRを確認してください」と言われたら必ず確認
- 確認せずに「完了した」と報告することは嘘

---

## 4. 完了報告前の全チェック実行義務

### 4.1 必須チェック項目

```bash
# 修正後は必ず全て実行
pnpm lint        # または npm run lint
pnpm test        # または npm test
pnpm typecheck   # TypeScriptの場合
pnpm build       # ビルド

# 全て通過してから「完了しました」と報告
```

### 4.2 厳守事項

- 実行せずに「テストした」と報告することは嘘
- 「おそらく大丈夫」と推測で完了報告することは絶対禁止
- CI/CDで失敗させることは金と時間の無駄
- pre-commit hookが成功しても、全チェックを手動で実行する

---

## 5. Git操作ワークフロー

### 5.1 コミット前の確認

```bash
# 1. 現在のブランチを確認
git branch --show-current

# 2. 重要ブランチ（main/master/develop）ではないことを確認
#    このプロジェクトではmainで直接作業可

# 3. 変更ファイルを確認
git status
git diff --cached

# 4. コミット
git commit -m "feat: Add feature X"
```

### 5.2 Push前の確認

```bash
# 1. テストを実行
bash -n quality-guardian/install.sh
npm test
npm run lint
npm run typecheck

# 2. 全テスト合格を確認

# 3. ユーザーに承認を得る

# 4. Push
git push origin main
```

### 5.3 Git操作方法の選択

**このプロジェクト（quality-guardian）の場合:**
- mainブランチで直接作業
- PRなしでpush

**他のプロジェクトの場合:**
- worktreeを使用
- PR経由でマージ

---

## 6. バックグラウンドプロセスの管理

### 6.1 必須の対応

1. **開発サーバー起動前の確認**
   ```bash
   lsof -i :ポート番号
   ```

2. **長時間実行コマンドの管理**
   - 完了後すぐにBashOutputで出力確認
   - 不要になったプロセスはすぐにKillShell

3. **セッション終了前のクリーンアップ**
   - 不要なバックグラウンドプロセスを確認
   - /bashes コマンドで一覧確認

4. **重複プロセスの防止**
   - 同じ種類のプロセスを複数起動しない
   - 新しいサーバー起動前に既存サーバーを停止

---

## 7. 継続タスクの管理

### 7.1 継続タスクの定義

以下のような宣言をした場合、完了まで継続する義務が発生:
- 「定期的に確認します」
- 「5分ごとに進捗をモニタリングします」
- 「完了まで監視し続けます」

### 7.2 実装方法

```bash
#!/bin/bash
interval=300  # 5分 = 300秒

echo "5分ごとに進捗を確認します"

while true; do
  current_time=$(date '+%Y-%m-%d %H:%M:%S')
  echo "[$current_time] 進捗を確認中..."

  # 完了チェック
  if echo "$output" | grep -q "完了"; then
    echo "タスク完了を確認しました"
    break
  fi

  # 次回確認時刻を表示
  echo "次回確認: ..."

  sleep $interval
done
```

---

## 8. エラー対応ワークフロー

### 8.1 エラー発生時の対応

```
1. 原因を調査する
   - エラーメッセージを確認
   - ログを確認
   - 設定を確認
   - 環境を確認

2. 複数の対策を順番に試す
   - 対策1を試す
   - 対策2を試す
   - 対策3を試す

3. 対策が成功したら作業を継続する

4. どうしても解決できない場合のみユーザーに報告
   - 試した対策とその結果を明記
```

### 8.2 禁止事項

- 「申し訳ありません。〜してください」で終わる
- エラーを調査せずに謝罪だけする
- 1つの方法が失敗したら諦める
- ユーザーに作業を丸投げする

---

## 9. 確認指示への対応

### 9.1 確認指示があった場合の必須手順

1. **内容を表示する**
2. **ユーザーの承認を得る**
3. **承認後に作業開始**

### 9.2 確認が必要な指示の例

- 「確認してください」
- 「あっているか確認」
- 「見せてください」
- 「表示してください」
- 「ここに出してください」
- 「まず表示して」

### 9.3 禁止事項

- 「確認してください」→ 表示せずに修正開始
- 「ここに出して」→ 出さずに「作り直します」
- 確認指示を無視して突き進む

---

## 10. 大きなタスク単位での完了報告

**Phase 4-2のようなサブタスクの場合、大きい項番（Phase 4全体）を完了するまで報告しない。**

```
Phase 4: データベース設定
  Phase 4-1: スキーマ作成
  Phase 4-2: マイグレーション実行
  Phase 4-3: テストデータ投入

→ Phase 4-1, 4-2, 4-3を全て完了してから報告
→ 「Phase 4（データベース設定）が完了しました」
```

---

**Current Version: 1.0.0**
**Last Updated: 2025-11-27**
