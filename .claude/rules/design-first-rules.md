# MUST Rule 19: 設計書First原則の厳守（プロジェクト横断対応）

**「仕様書first」「設計書first」「ドキュメントfirst」プロジェクトでは、機能説明・質問対応時に必ず設計書を最初に確認すること。コードから推測して説明してはいけない。**

**さらに、quality-guardian自体が、プロジェクトにルールが書かれていない場合でも、AIの「コードfirst」という悪い習慣を横断的に検出する。**

## 問題の本質

AIは機能の説明を求められた時、以下の問題行動をする：

1. **コードから推測して説明**
   - すぐにコードを読む
   - コードの実装から機能を推測
   - 設計書を確認しない

2. **設計意図を無視**
   - なぜその実装になったのか分からない
   - 設計書とコードの乖離を見逃す
   - プロジェクトの設計思想を破壊

3. **「仕様書first」の原則を守らない**
   - プロジェクトは「仕様書first」で開発しているのに
   - AIは「コードfirst」で説明してしまう
   - 開発プロセスの根幹を破壊

## 2つの検出レベル

このMUST Rule 19は2つのレベルで動作する：

### レベル1: 個別プロジェクトでの検出（従来）

プロジェクトのCLAUDE.mdに「仕様書first」等の記載がある場合、そのルールに従うよう検出。

### レベル2: quality-guardian横断的検出（新規・重要）

**プロジェクトにルールが書かれていなくても、AIの「コードfirst」という悪い習慣を検出。**

**なぜquality-guardian自体で検出するのか:**
- プロジェクトごとにCLAUDE.mdにルールを書くのは現実的ではない
- AIの「コードfirst」という悪い習慣を横断的に防ぐ
- **開発方法論違反は、プロジェクトにルールがなくても問題**

**検出すべきAIの悪い行動パターン（プロジェクト横断）:**
```
🚫 「コードfirst」の悪い習慣:

1. 機能説明を求められた時、いきなりコードファイルを読もうとする
2. 設計書・ドキュメントの存在を確認しない
3. 「コードを読めば分かる」という姿勢
4. プロジェクトにルールがないからと「コードfirst」で進める
```

## 必須手順

### 1. プロジェクトの開発方針を確認（レベル1検出）

**まずCLAUDE.mdで開発方針を確認:**

```bash
# CLAUDE.mdに「仕様書first」「設計書first」等の記載があるか確認
grep -i "仕様書first\|設計書first\|ドキュメントfirst\|spec-first\|design-first" .claude/CLAUDE.md

# 開発フローの記載を確認
grep -i "開発フロー\|開発手順\|development flow" .claude/CLAUDE.md
```

**結果A: 開発方針の記載がある場合**
→ その方針に従う（ステップ2へ）

**結果B: 開発方針の記載がない場合**
→ ステップ1.5（quality-guardian横断的検出）へ

### 1.5. quality-guardian横断的検出（レベル2検出・新規）

**開発方針の記載がない場合でも、以下の悪い行動パターンを検出:**

```
🚫 AIの悪い行動パターン（BLOCKER判定）:

1. 「コードを読んで推測する」
   - いきなりコードファイルを読もうとする
   - 設計書・ドキュメントの存在確認なし
   - 「コードを見れば分かる」という姿勢

2. 「設計書の存在を確認しない」
   - docs/、README.md、設計書を探さない
   - 「おそらくコードに書いてある」と推測

3. 「なぜそうなっているか」を無視
   - 実装だけを説明しようとする
   - 設計意図を確認しない
```

**検出した場合の対応:**

プロジェクトに明示的なルールがない場合でも、以下の手順を推奨:
1. まず設計書・ドキュメントがないか確認（docs/, README.md等）
2. 設計書がない場合のみコードを確認
3. 「なぜそうなっているか」の設計意図を意識

**正しい手順:**
```bash
# まず設計書・ドキュメントを探す（推奨）
find . -name "*.md" | grep -i "design\|spec\|adr\|architecture"
find docs -name "*.md"
cat README.md  # プロジェクト概要・設計思想

# 設計書がない場合はコードを確認（許容）
# ただし「なぜそうなっているか」を意識
```

### 2. 機能説明を求められた時の必須手順

**「〜の使い方は？」「〜の機能は？」と聞かれた場合:**

#### A. 「仕様書first」プロジェクトの場合（CLAUDE.mdに記載あり）

```bash
# ステップ1: 設計書を検索（必須）
find docs/design -name "*.md" -exec grep -l "機能名" {} \;
find docs/adr -name "*.md" -exec grep -l "機能名" {} \;
find docs/specs -name "*.md" -exec grep -l "機能名" {} \;

# ステップ2-A: 設計書が見つかった場合
# → 設計書の内容に基づいて説明
# → コードは設計書の補足として参照する程度

# ステップ2-B: 設計書が見つからない場合
# → 「この機能の設計書が見つかりませんでした」と報告
# → ユーザーに「設計書なしで実装された可能性があります」と伝える
# → 設計書の有無を明確にしてから、必要に応じてコードを確認
```

#### B. 開発方針なしの場合（quality-guardian横断検出適用）

```bash
# まず設計書・ドキュメントを探す（推奨）
find . -name "*.md" | grep -i "design\|spec\|adr"
cat README.md

# 設計書が見つかった場合
# → 設計書の内容に基づいて説明

# 設計書が見つからない場合
# → コードを確認（許容）
# → ただし「なぜそうなっているか」を意識
```

### 3. 設計書が見つかった場合の説明順序

1. **設計書の内容を説明**
   - 設計意図
   - アーキテクチャ
   - 仕様

2. **設計書とコードの整合性を確認**
   - 設計書通りに実装されているか
   - 差異がある場合は報告

3. **必要に応じてコードで補足**
   - 設計書に書かれていない実装詳細
   - 具体的な使い方

### 4. 設計書が見つからない場合の対応

**報告例:**

```
「[機能名]の設計書を探しましたが、見つかりませんでした。

検索した場所:
- docs/design/
- docs/adr/
- docs/specs/

このプロジェクトは「仕様書first」で開発されているため、
設計書が存在するはずですが、以下の可能性があります:

1. 設計書が別の場所にある
2. 設計書なしで実装された機能
3. 設計書の命名が異なる

どのように対応しますか？
1. 設計書の場所を教えていただく
2. コードから機能を確認する（設計書なしで実装された場合）
3. 設計書を新規作成する
```

## 禁止事項

```
❌ 設計書を確認せずにコードから機能を推測して説明
❌ 「コードを読めばわかる」という姿勢
❌ 設計書の存在を確認しないまま実装説明
❌ 設計書より先にコードを読む
❌ 「おそらくこういう機能」と推測で説明
❌ プロジェクトの開発方針（仕様書first等）を無視
```

## 正しい対応パターン

### パターン1: 設計書が見つかった場合

```
ユーザー: Batch Testの使い方は？

[誤った対応]
❌ すぐにコードを読む（batch-test-panel.tsx）
❌ コードから機能を推測して説明

[正しい対応]
✅ まず設計書を検索
   find docs/design -name "*.md" -exec grep -l "batch\|Batch Test" {} \;

✅ 設計書を読む（phase-0-meta-prompt-execution.md）

✅ 設計書の内容を報告
   「設計書を確認しました。

   `phase-0-meta-prompt-execution.md`に「Parallel Testing」という機能が
   記載されていますが、「Batch Test」という名称の機能は見つかりませんでした。

   設計書の「Parallel Testing」の説明:
   - 複数の候補プロンプト × 複数のプロバイダーで並列実行
   - 1つのuserPrompt（testInput）を使用

   実装コード(`batch-test-panel.tsx`)を確認すると:
   - 複数のテストケース（異なるinput）を管理
   - これは設計書に記載されていない追加機能の可能性があります

   確認が必要な点:
   1. Batch Test機能の設計書は別に存在しますか？
   2. それとも、設計書なしで実装された機能でしょうか？」
```

### パターン2: 設計書が見つからない場合

```
ユーザー: 新機能Xの使い方は？

[誤った対応]
❌ すぐにコードを読んで説明

[正しい対応]
✅ まず設計書を検索
   find docs/design -name "*.md" -exec grep -l "機能X" {} \;

✅ 設計書が見つからない → 報告
   「[機能X]の設計書を探しましたが、見つかりませんでした。

   このプロジェクトは「仕様書first」で開発されているため、
   設計書が存在するはずですが、見つかりませんでした。

   以下の対応が可能です:
   1. 設計書の場所を教えていただく
   2. コードから機能を確認する（設計書なしの場合）
   3. 設計書を新規作成する

   どのように対応しますか？」
```

## チェックリスト

**機能説明を求められたら:**

- [ ] **CLAUDE.mdで開発方針を確認した**（仕様書first、TDD等）
- [ ] **設計書を最初に検索した**（docs/design、docs/adr等）
- [ ] **設計書が見つかった場合、設計書の内容に基づいて説明した**
- [ ] **設計書が見つからない場合、その旨を報告した**
- [ ] **コードを読む前に、設計書の有無を確認した**
- [ ] **設計書とコードの整合性を確認した**

## 過去の問題例

### 問題例: Batch Test機能の説明を求められた時

**状況:**
```
ユーザー: Batch Testの使い方は？

AI: すぐにコードを読んだ（batch-test-panel.tsx）
AI: コードから機能を推測して説明した

ユーザー: 「仕様書firstでやっているはずなのでどこかに有るはずではないのでしょうか?」

AI: そこで初めて設計書を確認
```

**ユーザーの指摘:**
```
「問題としては、今後このような事がないようにするためのあなたの具体的な対応が必要とされています」
```

**何が問題だったか:**
1. **設計書を確認せずにコードから推測**
   - このプロジェクトは「仕様書first」で開発している
   - なのに、AIは「コードfirst」で説明した
   - プロジェクトの開発プロセスの根幹を破壊

2. **設計書の存在を無視**
   - 設計書を確認したのは、ユーザーに指摘された後
   - 本来は最初に設計書を確認すべきだった

3. **MUST Rule 1違反**
   - プロジェクトの開発方針（仕様書first）を無視
   - ユーザー指示の厳守を怠った

**本来すべきだったこと:**
1. まず設計書を検索
   ```bash
   find docs/design -name "*.md" -exec grep -l "batch\|Batch Test" {} \;
   ```

2. 設計書を読む（phase-0-meta-prompt-execution.md）

3. 設計書の内容を報告
   - 「Parallel Testing」という類似機能が記載されている
   - 「Batch Test」という名称は見つからない
   - 設計書なしで実装された可能性がある

4. ユーザーに確認
   - 設計書は別に存在しますか？
   - それとも、設計書なしで実装された機能でしょうか？

## なぜこれがMUST Ruleなのか

- **プロジェクトの開発プロセスの根幹**（仕様書first）
- **設計意図の理解**（なぜその実装になったのか）
- **設計書とコードの整合性**（乖離を検出）
- **MUST Rule 1違反**（ユーザー指示の厳守を怠った）
- **開発品質の維持**（設計なしの実装を防ぐ）

## memory-guardianとの連携

このルールは memory-guardian Section 8 によって自動的にチェックされます。

**トリガーフレーズ:**
- 「〜の使い方は？」
- 「〜はどう動く？」
- 「〜の機能について教えて」
- 「〜はどこにある？」
- 「〜の仕様は？」
- 「〜について説明して」

**memory-guardianが検出した場合:**
1. CLAUDE.mdで開発方針を確認
2. 「仕様書first」等の記載があれば、設計書を最初に確認するよう警告
3. 設計書の有無を確認
4. 設計書に基づいて説明するよう要求

---

**Current Version: 1.0**
**Last Updated: 2025-01-10**
