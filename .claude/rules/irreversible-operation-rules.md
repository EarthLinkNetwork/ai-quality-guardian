# MUST Rule 3: 不可逆な操作・影響範囲の大きい操作の事前確認

**不可逆な操作（元に戻せない操作）や影響範囲の大きい操作を実行する前に、必ずユーザーに確認を取り、影響範囲を説明する。**

## 不可逆な操作の例

- **外部サービスへのデータ送信**: Slack通知、メール送信、Webhook呼び出し、API呼び出し等
- **ファイル・ディレクトリの削除**: 重要なファイル、設定ファイル、データファイル等
- **データベース操作**: レコード削除、テーブル削除、スキーマ変更等
- **デプロイ・リリース操作**: 本番環境へのデプロイ、リリース作成、パッケージ公開等
- **危険なGit操作**: git filter-branch --all、git push --force、git reset --hard、git rebase、git amend、タグ削除等
- **クラウドリソースの削除**: AWS、GCP、Azure等のリソース削除
- **課金が発生する操作**: 有料APIの呼び出し、クラウドリソースの作成等

## 影響範囲の大きい操作の例

- **環境変数の変更**: .env、.env.local、.env.production等のファイル変更
- **データベース接続先の変更**: DATABASE_URL等の接続文字列変更（SQLite → MySQL、開発環境 → 本番環境等）
- **API接続先の変更**: API_ENDPOINT、NEXT_PUBLIC_API_URL等の変更
- **認証設定の変更**: AUTH_SECRET、JWT_SECRET、OAuth設定等の変更
- **インフラ設定の変更**: Docker設定、docker-compose.yml、Kubernetes設定等
- **CI/CD設定の変更**: GitHub Actions、Jenkins、CircleCI等のワークフロー変更
- **スキーマファイルの変更**: Prisma schema、GraphQL schema等のデータベーススキーマ変更

## 必須の対応

1. **操作前に、何を行うか明確に説明する**
   - どのサービスに
   - 何を送信/削除するか
   - 誰に影響するか

2. **操作が不可逆であることを警告する**
   - 「この操作は取り消せません」と明記
   - 削除できない、元に戻せないことを説明

3. **影響範囲を説明する**
   - 誰に通知が届くか
   - どのデータが消えるか
   - どのシステムに影響するか

4. **ユーザーの明示的な承認を得る**
   - 「実行してよろしいですか？」と確認
   - 曖昧な要望を勝手に解釈しない

## 禁止事項

```
❌ 「通知してほしい」という曖昧な要望を「今すぐ送信」と解釈
❌ 削除できないことを説明せずに実行
❌ 影響範囲を確認せずに実行
❌ 「おそらく大丈夫」と推測で実行
❌ テスト環境と本番環境を混同して実行
❌ 環境変数を確認なしに変更
❌ データベース接続先を確認なしに変更
❌ 設定ファイルの変更内容を説明せずに実行
```

## 正しい対応例

### 例1: Slack通知

```
ユーザー: Slack通知してほしい

[正しい対応]
「Slack通知機能をGitHub Actionsワークフローに追加しますか？
それとも、今すぐテスト通知を手動で送信しますか？

注意: 手動送信した通知は削除できません。
通知は #deploy-notifications チャンネルの全メンバーに届きます。

どちらを希望されますか？」
```

### 例2: 環境変数変更

```
ユーザー: DATABASE_URLをMySQLに変更してください

[正しい対応]
「DATABASE_URLをMySQLに変更するには、以下のファイルを更新する必要があります：

1. .env.local
   - DATABASE_URLを sqlite → mysql (AWS RDS) に変更
   - 影響: アプリケーションの接続先データベースが変わります

2. prisma/schema.prisma
   - provider を "sqlite" → "mysql" に変更
   - 影響: データベーススキーマの形式が変わります

これらのファイルを変更してよろしいですか？」
```

## チェックリスト

**不可逆・影響範囲が大きい操作の前に必ず確認:**

- [ ] **何を行うか明確に説明した**
- [ ] **操作が不可逆であることを警告した**
- [ ] **影響範囲を説明した**
- [ ] **ユーザーの明示的な承認を得た**
- [ ] **曖昧な要望を勝手に解釈していない**
