# MUST Rule 17: 過去の実行履歴・標準工程の厳守

**同じタスクを過去に実施している場合、その工程を厳守すること。プロジェクト仕様の標準工程も厳守すること。**

## 問題の本質

AIは各タスクを「単発の要求」として処理し、以下を無視する傾向がある：

1. **過去の実行履歴**: 同じタスクを過去にどう実施したか
2. **プロジェクト仕様**: CLAUDE.mdに記載された標準工程
3. **過去の合意事項**: 過去のセッションで決定した内容

## 必須手順

### タスク受領時の必須確認（最優先）

**タスクを受けた時、まず以下を確認:**

```
必須確認事項:
□ プロジェクト仕様（CLAUDE.md）に標準工程が記載されているか？
  → 記載されている → これが絶対の正解
  → 記載されていない → 過去のログを参照

□ このタスクを過去に実施したか？
  → git log でコミット履歴を検索
  → /tmp/ や logs/ で過去のログファイルを検索

□ 過去に実施している場合、その工程は何だったか？
  → 過去のログファイルを確認
  → コミットメッセージを確認
  → 工程を抽出（例: バックアップ → 検証 → レポート）

□ 過去の工程とCLAUDE.mdの仕様が一致しているか？
  → 一致している → その工程を実施
  → 不一致 → CLAUDE.mdの仕様を優先（過去のログが間違っている）

□ CLAUDE.mdと過去のログが矛盾している場合:
  → 必ずCLAUDE.mdを優先
  → 過去のログは「参考」であり「正解」ではない
  → 過去が間違っていた可能性を常に考慮する
```

**この確認をスキップした場合 → MUST Rule 17違反**

### 優先順位（絶対厳守）

```
1. CLAUDE.mdの仕様（最優先・絶対の正解）
   ↓
2. ユーザーの明示的な指示
   ↓
3. 過去の実行履歴（参考・検証用）
```

**重要:** 過去のログはあくまで「参考」であり、CLAUDE.mdの仕様と矛盾する場合は**必ずCLAUDE.mdを優先**する。

## 具体例: バックアップタスク

### 過去の問題例1: 検証を省略

**状況:**
```
ユーザー: 「Sandboxのバックアップを取って検証してください」

AIの誤った対応:
1. git log を確認しない
2. 過去のログファイル（/tmp/sandbox-*.log）を確認しない
3. CLAUDE.mdの「BACKUP AND VERIFICATION MANDATORY WORKFLOW」を確認しない
4. バックアップのみ実行（検証を省略）

結果:
- 検証なしのバックアップ
- 生ログなし
- レポート生成不可
- プロジェクトの目的（GCP環境削除）に支障
```

### 過去の問題例2: 過去のログを盲信（重大）

**状況:**
```
ユーザー: 「Sandboxのバックアップを取って検証してください」

AIの誤った対応:
1. 過去のログ（2025-11-04）を確認 ✓
2. 過去のログの内容:
   - FHIR History検証のみ実施
   - Database検証は「ファイル整合性チェックのみ」
3. AIの判断: 「これが正しい方法だ」← 誤り
4. CLAUDE.mdを確認したが、「過去のログ」を優先
5. CLAUDE.md仕様:
   - Database Verification: Restore + compare (10% sampling)
   ← これが正しい仕様
6. AIの実施内容: ファイル整合性チェックのみ ← 仕様違反

結果:
- CLAUDE.mdの仕様を無視
- 過去のログが間違っていた可能性を考慮しない
- ユーザーから「何回言えば分かるのか」と指摘
- 「削除するのだから手抜きをするな」という明確な指示を無視
```

**ユーザーの指摘:**
```
「ファイル整合性チェックのみ実施はあり得ないと、何回いえば分かるのですか?
claudemeにも書いてあるのに無視するのはなぜですか?」
```

**AIの誤り:**
```
1. 過去のログを見て「これが正しい方法だ」と誤認
   → 過去のログ = 正しい、という誤った前提

2. CLAUDE.mdに明記されている「Restore + compare」を軽視
   → 「書いてあること」よりも「過去にやったこと」を優先

3. 「時間がかかる」という理由で妥協案を提示
   → 「削除するのだから手抜きをするな」という指示を無視
```

**本来すべきだったこと:**
```
1. CLAUDE.mdを確認 ✓
   → Database Verification: Restore + compare (10% sampling)

2. 過去のログを確認 ✓
   → Database検証は「ファイル整合性チェックのみ」

3. 矛盾を検出 ✓
   → CLAUDE.md仕様 ≠ 過去のログ

4. 優先順位を適用 ← ここが重要
   → CLAUDE.md（絶対の正解）> 過去のログ（参考）

5. 結論
   → 過去のログが間違っていた
   → CLAUDE.mdの仕様通り「Restore + compare」を実施
```

**ユーザーの指摘:**
```
「なぜ、今まで何回もやってきた、行程が無視されのですか?
これはバックアップツールで、gcpの環境を削除するために必要なツールで
削除するためにバックアップの内容が正しいか確認しないといけないといっています。
これはプロジェクトの仕様にもかいてあります。」
```

### 正しい対応

**タスク受領時:**

```bash
# 1. 過去の実行履歴を確認
git log --grep="backup" --oneline -10

# 結果:
# a1b2c3d feat: Complete Sandbox backup and verification (2025-11-04)
# → 過去に実施している

# 2. 過去のログファイルを確認
ls -la /tmp/sandbox-*.log

# 結果:
# /tmp/sandbox-backup-2025-11-04.log（バックアップ）
# /tmp/sandbox-fhir-verification-one-10pct.log（検証）
# → 過去は「バックアップ＋検証」を実施

# 3. CLAUDE.mdを確認
grep -A 20 "BACKUP AND VERIFICATION" .claude/CLAUDE.md

# 結果:
# 「BACKUP AND VERIFICATION MANDATORY WORKFLOW」セクション存在
# - 全てのバックアップ実行は3種類の検証を含む
# - 検証なしのバックアップは禁止
# → 仕様に明記

# 4. 結論
# 今回も過去と同じ工程（バックアップ＋3種類の検証）を実施する
```

**実行:**

```bash
# 過去の工程に従って実施
1. バックアップ実行（生ログ取得）
   → backup-fhir.ts 実行 | tee /tmp/sandbox-backup-2025-11-06.log

2. 3種類の検証実行（生ログ取得）
   → verify-database.ts 実行 | tee /tmp/sandbox-db-verification-2025-11-06.log
   → verify-fhir-current.ts 実行 | tee /tmp/sandbox-fhir-current-2025-11-06.log
   → verify-fhir-history.ts 実行 | tee /tmp/sandbox-fhir-history-2025-11-06.log

3. レポート生成
   → 生ログからレポート生成

4. GCS・ローカルに配置
```

## 失敗したチェックポイント

ユーザーが指摘した5個の全てのチェックポイント：

### 1. プロジェクト仕様の確認失敗

**チェックポイント:**
- CLAUDE.md に明記された標準工程を確認する

**失敗:**
- CLAUDE.mdを読んだが、「BACKUP AND VERIFICATION MANDATORY WORKFLOW」を無視
- 仕様を「参考情報」として扱い、必須要件として認識していない

**対策:**
- タスク受領時、CLAUDE.mdの関連セクションを必ず読む
- 標準工程が記載されている場合、厳守する

### 2. 過去の実行履歴の確認失敗

**チェックポイント:**
- 同じタスクを過去に実施していないか確認する
- 実施している場合、その工程を確認する

**失敗:**
- git log を確認しない
- 過去のログファイル（/tmp/sandbox-*.log）を見たが、「今回も同じ工程」と考えなかった
- 過去の作業を「参考」として見ており、「再現すべき工程」として見ていない

**対策:**
- git log --grep="タスク名" で過去のコミットを検索
- 過去のログファイルで工程を確認
- 過去の工程を再現する

### 3. 過去の合意事項の確認失敗

**チェックポイント:**
- 過去のセッションで合意した内容を確認する

**失敗:**
- ログ形式について詳細に議論し決定したのに、新しい形式のレポートを作成
- 会話履歴を「情報」として見ており、「約束」として認識していない

**対策:**
- 「ログ」「形式」「出力」等のキーワードで会話履歴を検索
- 「この形式でfixされて実装に入ります」という承認を探す

### 4. タスク受領時の確認失敗

**チェックポイント:**
- 指示の背景・目的を理解する

**失敗:**
- 「バックアップを取って検証」という指示を字面通り受け取り
- 「検証」の種類を確認しなかった

**対策:**
- 曖昧な用語（「検証」「テスト」「確認」）は必ず明確化
- 過去の実行履歴で具体的な内容を確認

### 5. ログ出力時の確認失敗

**チェックポイント:**
- 過去の約束を思い出す

**失敗:**
- 「過去に話した形式を覚えているか」と聞かれたのに
- 新しい形式のレポートを作成

**対策:**
- 「覚えているか」「前に話した」という言葉は、過去の合意があるサイン
- 会話履歴・コメント・過去のログで確認

## システム的思考の必要性

**AIがやりがちな誤り:**
```
❌ 各タスクを「単発の要求」として処理
❌ プロジェクトの目的を無視
❌ 過去の実施パターンを無視
❌ 合意事項を無視
❌ 仕様書を無視
```

**正しいアプローチ:**
```
✅ プロジェクトの目的を理解（例: GCP環境削除）
✅ 過去の実施パターンを確認（例: 毎回検証している）
✅ 合意事項を尊重（例: ログ形式）
✅ 仕様書を厳守（例: CLAUDE.md）
✅ タスクを「プロジェクトの文脈」の中で理解
```

## 禁止事項

```
❌ 過去の実行履歴を確認せずにタスク開始
❌ CLAUDE.mdの標準工程を無視
❌ 「今回は違う方法で」と独自の判断
❌ 過去の工程を「参考」として扱う（厳守すべき）
❌ 「おそらく同じだろう」と推測で進める
❌ 過去の合意事項を思い出さずに新しい形式を採用
```

## 正しい対応

```
✅ git log で過去のコミットを検索
✅ 過去のログファイルで工程を確認
✅ CLAUDE.mdで標準工程を確認
✅ 過去の工程と今回の指示が一致するか確認
✅ 不一致の場合はユーザーに確認
✅ 一致する場合は過去の工程を再現
✅ 会話履歴で過去の合意を検索
```

## チェックリスト

**タスク開始前に必ず確認:**

- [ ] **git log で過去のコミットを検索した**
- [ ] **過去のログファイルで工程を確認した**
- [ ] **CLAUDE.mdで標準工程を確認した**
- [ ] **過去の工程と今回の指示が一致することを確認した**
- [ ] **曖昧な用語（検証/テスト/ログ）を明確化した**
- [ ] **会話履歴で過去の合意を検索した**

## 過去の問題例から学ぶ

### 問題例: バックアップタスクで検証を省略

**問題内容:**
- ユーザー: 「Sandboxのバックアップを取って検証してください」
- AI: バックアップのみ実行、検証を省略
- 過去の実行履歴: 毎回「バックアップ＋3種類の検証」を実施
- CLAUDE.md: 「BACKUP AND VERIFICATION MANDATORY WORKFLOW」に明記
- 結果: 検証なし、生ログなし、レポート生成不可

**本来すべきだったこと:**
1. git log で過去のバックアップコミットを検索
2. 過去のログファイルで「バックアップ＋3種類の検証」を確認
3. CLAUDE.mdで標準工程を確認
4. 今回も同じ工程を実施

### なぜこれがMUST Ruleなのか

- **プロジェクトの目的を損なう**（GCP環境削除ができない）
- **ユーザーの時間を無駄にする**（今日中に完了すべきタスクが翌日以降に）
- **信頼の損失**（何度も同じミスを繰り返す）
- **システム的思考の欠如**（単発タスクとして処理、文脈を無視）
- **5個のチェックポイントを全て見落とす**（重大な問題）

## MUST Rule 13との関係

**MUST Rule 13:** 実装前のメモリー・コメント・要求の整合性確認
**MUST Rule 17:** 過去の実行履歴・標準工程の厳守

**違い:**
- Rule 13: 会話履歴・コメント・過去の合意を確認
- Rule 17: 過去の実行履歴・標準工程を確認

**共通点:**
- どちらも「過去の情報」を尊重する
- どちらも「推測で進めない」
- どちらも memory-guardian が担当

**Rule 17が必要な理由:**
- Rule 13は「会話履歴・コメント」に焦点
- Rule 17は「過去の実行履歴・標準工程」に焦点
- バックアップタスクのような「定型作業」は、会話履歴よりも実行履歴が重要
