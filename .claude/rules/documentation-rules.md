> **⚠️ DEPRECATION NOTICE**
> このファイルの内容は [docs/QUALITY_GUARDIAN.md](../../docs/QUALITY_GUARDIAN.md) に移行されました。
> 今後は docs/QUALITY_GUARDIAN.md を正式な参照先としてください。
> このファイルは後方互換性のために残されていますが、将来的に削除される可能性があります。

# MUST Rule 18: 重要な理解の即座の文書化義務

**ユーザーから重要な説明・理由・背景を聞いた時、その場で即座にCLAUDE.mdまたは関連ファイルに記録すること。**

## 問題の本質

AIは過去にユーザーから説明を受けたことを忘れ、同じ間違いを繰り返す：

1. **説明を聞いても記録しない**
   - 「理解しました」だけで終わる
   - 自分のメモリーに頼る
   - 後で忘れる

2. **理由を記録しない**
   - 「何をするか」だけを記録
   - 「なぜそうするか」を記録しない
   - 結果：同じ質問を繰り返す

3. **ユーザーに何度も同じことを言わせる**
   - 時間の無駄
   - 信頼の損失
   - ユーザーのストレス

## 厳守事項

### 1. 即座に記録する

**ユーザーが重要な説明をした直後に記録:**

```
ユーザー: 「2種類のレポートが必要です。Healthcare APIの履歴エンドポイントに問題があるからです」

[誤った対応]
❌ 「理解しました。実装します」← 記録していない

[正しい対応]
✅ 「理解しました。CLAUDE.mdに記録します」
✅ [即座にCLAUDE.mdまたは関連ファイルに追記]
✅ 「記録しました。これで今後この理由を忘れません」
```

### 2. 「なぜ？」の理由を記録

**「何をするか」だけでなく、「なぜそうするか」を記録:**

```markdown
❌ 悪い記録:
「2種類のレポートが必要」

✅ 良い記録:
「2種類のレポートが必要
理由: Healthcare APIの履歴エンドポイントに問題がある（Blobエラー、404等）
- カレントデータ: API経由で検証可能
- 履歴データ: API不安定なのでJSON直接検証が必要」
```

### 3. 記録する内容

**必須項目:**
1. **ユーザーの説明（できるだけ原文）**
2. **なぜそうなのか（理由）**
3. **過去に起きた問題（あれば）**
4. **技術的背景（API制約等）**

**例:**
```markdown
## なぜ2種類のFHIR検証が必要か

**ユーザーの説明:**
「Healthcare APIの履歴エンドポイントに問題がある。だから2種類のレポートが必要」

**理由:**
- Healthcare API `_history` エンドポイントは不安定（Blobエラー、404エラー）
- カレントデータはAPI経由で信頼できる
- 履歴データはAPIが使えないので、バックアップJSON直接検証が必要

**技術的背景:**
- `import` API: カレントのみimport
- `importHistory` API: 履歴もimport可能だが、検証にはAPI使えない
- よって、履歴はJSONファイルを直接パースして検証

**過去の問題:**
- 2025-11-06: API経由の履歴検証で11/14ストアが false negative
- 原因: `[object Blob]` エラーでAPIから履歴取得失敗
```

### 4. 記録場所

**記録すべきファイル:**

| 内容 | 記録場所 |
|------|---------|
| プロジェクト全体に関わる重要な理由・背景 | `.claude/CLAUDE.md` |
| 特定機能の技術的理由 | 該当ファイルのコメント |
| API制約・外部サービスの問題 | `.claude/CLAUDE.md` または関連ファイル |
| 過去の失敗例・教訓 | `.claude/rules/` 配下のルールファイル |

**例1: プロジェクト全体に関わる（CLAUDE.md）**
```markdown
## BACKUP AND VERIFICATION MANDATORY WORKFLOW

### なぜ2種類のFHIR検証が必要か
（上記の詳細を記載）
```

**例2: 特定機能（ファイル内コメント）**
```typescript
// verify-fhir-history.ts

/**
 * FHIR履歴データ検証
 *
 * 重要: Healthcare APIの_historyエンドポイントは使用しない
 * 理由: Blobエラー、404エラーが頻発して信頼できない（2025-11-06実測）
 *
 * 代わりにバックアップJSONファイルを直接パースして検証する。
 * これがユーザーから指示された「2種類のレポート」が必要な理由。
 */
export async function verifyFHIRHistory() {
  // ...
}
```

## 禁止事項

```
❌ 「理解しました」だけで終わる
❌ 記録せずに実装開始
❌ 「後で文書化します」（後で忘れる）
❌ 自分のメモリーに頼る
❌ 理由を省略して「何をするか」だけ記録
❌ ユーザーの説明を自分の言葉で要約しすぎる（ニュアンスが失われる）
```

## 正しい対応フロー

```
1. ユーザーから重要な説明を受ける
   ↓
2. 「理解しました。CLAUDE.md（または関連ファイル）に記録します」と宣言
   ↓
3. 即座に該当ファイルを Read
   ↓
4. 適切な場所に追記（Edit または Write）
   ↓
5. 「記録しました。以下の内容を追加しました：[追加内容の要約]」と報告
   ↓
6. ユーザーに確認を求める（必要に応じて）
   ↓
7. 承認を得てから実装開始
```

## 記録すべきタイミング

**以下の状況で即座に記録:**

1. **「なぜ？」の理由を聞いた時**
   - 「なぜ2種類必要？」→「APIに問題があるから」← 即座に記録

2. **技術的制約を聞いた時**
   - 「importでは履歴が戻らない」← 即座に記録

3. **過去の失敗例を聞いた時**
   - 「前回〜で失敗した」← 即座に記録

4. **ユーザーから「何度も言っている」と指摘された時**
   - これは記録していなかった証拠 → 即座に記録

5. **複雑な要件の背景を聞いた時**
   - 「削除するから慎重に」← プロジェクトの目的を記録

## 過去の問題例

### 問題例1: 2種類のレポートが必要な理由を記録しなかった

**状況:**
```
1. ユーザーが「2種類のレポートが必要」と説明
2. AIが「理解しました」だけで記録しなかった
3. 後日、AIが「なぜ2種類？」と再度質問
4. ユーザーが「前に説明したのに忘れている」と指摘
```

**ユーザーの指摘:**
「私が正しいのではなく、あなたがいったことを私がおぼえているだけです。あなたが忘れている、もしくは仕様にのこしていないのが問題なのです」

**本来すべきだったこと:**
1. ユーザーの説明を聞いた直後にCLAUDE.mdに記録
2. 「なぜ2種類必要か」の理由を明確に文書化
3. 技術的背景（Healthcare API の制約）も記録

**なぜこれがMUST Ruleなのか:**
- ユーザーの時間を無駄にする（何度も同じことを説明させる）
- 信頼の損失（「AIは話を覚えていない」）
- 同じ間違いを繰り返す
- プロジェクトの知識が蓄積されない

### 問題例2: API制約を記録しなかった

**状況:**
```
1. ユーザーが「importでは履歴が戻らない」と説明
2. AIが理解したが記録しなかった
3. 後日、AIが「importで履歴を復元」と提案
4. ユーザーが「前に説明したはず」と指摘
```

**本来すべきだったこと:**
```markdown
## Healthcare API の制約

### import vs importHistory

**重要:**
- `import` API: カレントデータのみimport可能
- `importHistory` API: 履歴データも含めてimport可能

この制約により、履歴データの検証方法が限定される：
- カレント: API経由で検証可能
- 履歴: JSON直接検証が必要（API不安定なため）

参考: [ユーザーの説明日付]
```

## 記録のフォーマット

**推奨フォーマット:**

```markdown
## [トピック]

**ユーザーの説明:**
「[ユーザーの発言をできるだけ原文で]」

**理由:**
- [なぜそうなのか]
- [技術的背景]

**技術的詳細:**
- [API制約]
- [外部サービスの問題]
- [パフォーマンス考慮]

**過去の問題:**
- [日付]: [何が起きたか]
- [原因]
- [対策]

**参考:**
- ファイル: [関連ファイルパス]
- コミット: [関連コミットハッシュ]
- 日付: [いつ説明を受けたか]
```

## チェックリスト

**ユーザーから重要な説明を受けた時、以下を確認:**

- [ ] **即座に記録したか？**（「後で」は禁止）
- [ ] **「なぜ？」の理由を記録したか？**
- [ ] **ユーザーの説明を原文で残したか？**
- [ ] **技術的背景を記録したか？**
- [ ] **過去の問題があれば記録したか？**
- [ ] **記録場所は適切か？**（CLAUDE.md or 関連ファイル）
- [ ] **ユーザーに「記録しました」と報告したか？**

## memory-guardianとの連携

memory-guardian は、実装開始前に以下をチェック：

1. **「なぜ？」の理由が文書化されているか**
2. **ユーザーが過去に説明した内容が記録されているか**
3. **記録されていない場合 → WARNING判定**

**例:**
```markdown
⚠️ memory-guardian: 重要な理由が文書化されていない（WARNING）

[タスク]
「2種類のFHIR検証レポートを作成」

[検出]
- CLAUDE.mdに「2種類のレポート」の記載なし
- 「なぜ2種類必要か」の理由が不明
- ユーザーから過去に説明を受けた可能性

[推奨対応]
実装前にユーザーに確認：
「2種類のレポートが必要な理由を教えていただけますか？
過去に説明されていた場合は申し訳ございません。
理由を理解してからCLAUDE.mdに記録し、実装を開始します」

判定: WARNING - 理由を確認してから実装してください
```

## なぜこれがMUST Ruleなのか

- **ユーザーの時間を守る**（何度も同じ説明をさせない）
- **信頼を維持する**（「話を覚えていない」と思われない）
- **知識を蓄積する**（プロジェクトの理解が深まる）
- **同じ間違いを防ぐ**（記録があれば確認できる）
- **新しいメンバーへの引き継ぎ**（文書化されていれば説明不要）

## 実装前の確認

**新しいタスクを開始する前に:**

1. CLAUDE.mdを確認
2. 関連する「なぜ？」の記録を探す
3. 見つからない場合、ユーザーに確認
4. 説明を受けたら即座に記録
5. 記録してから実装開始
