# MUST Rule 17: 「同じ」指示の全体確認義務

**ユーザーが「Aと同じ」「Bと同じように」と指示した場合、関連する全てのファイル・パターンを洗い出し、全体の一貫性を確保すること。**

## 問題の本質

AIは「〜と同じ」という指示を受けた時、以下の問題行動をする：

1. **一部のファイルだけを確認**
   - 1つのファイルだけ見て「同じ」と判断
   - 関連ファイルを洗い出さない
   - locale版、ルート版、類似ファイルを見落とす

2. **推測で判断**
   - 「おそらく全て同じはず」と推測
   - 実際には不一致があるのに気づかない

3. **一部だけ修正して終わる**
   - 1つのファイルを修正
   - 他のファイルは放置
   - 結果：一貫性が崩れる

## 必須手順

### 1. 関連ファイルを全て洗い出す

```bash
# 例: 「detailCouponと同じ」の場合
find src -name "*DetailCoupon*" -o -name "*detailCoupon*"
find src -name "*Detail*Content.tsx"

# 例: 「ログ形式を前回と同じに」の場合
find . -name "*.log" -o -name "*logger*"
grep -r "console.log\|logger" src/
```

### 2. 全てのファイルの該当箇所を確認

```bash
# 例: matchSearchItems の実装を確認
grep -n "matchSearchItems\|match.*searchItems" src/app/**/Detail*.tsx

# 例: ログ形式を確認
grep -n "logger.info\|console.log" src/**/*.ts
```

### 3. 全てのファイルで一貫性を保つ

- 1つのファイルだけ修正して終わらない
- 全てのファイルで同じ実装になっているか確認
- locale版、ルート版、類似ファイル全てをチェック

### 4. 不一致を発見したら全て修正

- 不一致を見つけたら、全てのファイルで統一
- ユーザーに報告：「locale版には未対応だったため、追加しました」

## 禁止事項

```
❌ 「〜と同じ」と言われて、1つのファイルだけ確認
❌ 関連ファイルを洗い出さずに実装開始
❌ 「おそらく全て同じはず」と推測
❌ 一部のファイルだけ修正して終わる
❌ locale版を見落とす
❌ 類似ファイルの存在を確認しない
```

## 正しい対応パターン

### パターン1: 「Aと同じ」指示を受けた場合

```
ユーザー: detailCouponと同じアーキテクチャーにしてください

[誤った対応]
❌ src/app/detailCoupon/DetailCouponContent.tsx だけ確認
❌ その実装を src/app/detail/CouponDetailContent.tsx にコピー
❌ locale版を見落とす

[正しい対応]
✅ 関連ファイルを全て洗い出す
   find src -name "*DetailCoupon*" -o -name "*Detail*Content.tsx"

✅ 発見:
   - src/app/detailCoupon/DetailCouponContent.tsx
   - src/app/[locale]/detailCoupon/DetailCouponContent.tsx
   - src/app/detail/CouponDetailContent.tsx
   - src/app/[locale]/detail/CouponDetailContent.tsx

✅ 全てのファイルの該当箇所を確認
   grep -n "matchSearchItems" src/app/**/Detail*.tsx

✅ 不一致を発見:
   - ルート版: searchItems対応あり
   - locale版: searchItems対応なし ← 不一致

✅ 全てのファイルで統一
   - locale版にも searchItems対応を追加
   - 全4ファイルで一貫性を確保

✅ ユーザーに報告:
   「4つのファイルを確認しました。
   locale版には searchItems対応がなかったため、追加しました。
   全てのファイルで一貫性を確保しました。」
```

### パターン2: 「前回と同じ」指示を受けた場合

```
ユーザー: ログ形式を前回と同じにしてください

[誤った対応]
❌ 直近のログファイル1つだけ確認
❌ その形式を真似る

[正しい対応]
✅ 会話履歴で「前回」がいつか確認
✅ 前回の実装を全て確認
   - どのファイルで実装したか
   - どの形式を使ったか
   - どのパラメータを使ったか

✅ 前回と全く同じ形式を使用
✅ ユーザーに報告:
   「前回（○月○日）の実装を確認しました。
   以下の形式を使用します：
   - ファイル: src/utils/logger.ts
   - 形式: JSON形式、タイムスタンプ付き
   - パラメータ: level, message, timestamp」
```

## チェックリスト

**「〜と同じ」指示を受けた時に必ず確認:**

- [ ] **関連ファイルを全て洗い出した**（find、grep）
- [ ] **全てのファイルの該当箇所を確認した**
- [ ] **不一致を検出した**（あれば）
- [ ] **全てのファイルで一貫性を保つように修正した**
- [ ] **locale版を確認した**（該当する場合）
- [ ] **類似ファイルを確認した**（命名パターンが似ているファイル）
- [ ] **実装後、全てのファイルで一貫性を再確認した**

## 過去の問題例

### 問題例1: 「detailCouponと同じ」で一部のファイルを見落とした

**状況:**
```
ユーザー: detailCouponと同じアーキテクチャーにしてください

AI: src/app/detailCoupon/DetailCouponContent.tsx だけ確認
AI: その実装を真似る
結果: locale版には searchItems対応がなかった（不一致）
```

**ユーザーの指摘:**
```
「なぜ detailCouponと同じといったのに、違う実装になっているのですか?
どうしてこういうことがおるのですか?
根本原因を対策しないと、今後も同様な事がおこります」
```

**何が問題だったか:**
1. **一部のファイルだけ確認**
   - src/app/detailCoupon/DetailCouponContent.tsx だけ見た
   - 他の3つのファイル（locale版、detail版）を見落とした

2. **関連ファイルを洗い出さなかった**
   - find コマンドで全ファイルを検索しなかった
   - grep で該当箇所を全検索しなかった

3. **不一致に気づかなかった**
   - ルート版と locale版で実装が異なることに気づかなかった
   - 「おそらく全て同じはず」と推測した

**本来すべきだったこと:**
1. `find src -name "*DetailCoupon*"` で全てのファイルを洗い出す
2. `grep -n "matchSearchItems" src/app/**/Detail*.tsx` で全ファイルの該当箇所を確認
3. 不一致を発見（locale版には未対応）
4. 全てのファイルで一貫性を保つように修正
5. 修正後、再度全ファイルで一貫性を確認

### 問題例2: 「前回と同じ」で直近のファイルだけ確認

**状況:**
```
ユーザー: バックアップ検証は前回と同じでお願いします

AI: 直近のバックアップファイル1つだけ確認
AI: その方法を真似る
結果: 前回は「Restore + compare (10% sampling)」だったのに、今回は「ファイル整合性チェックのみ」を実装
```

**ユーザーの指摘:**
```
「前回と違いますよね? なぜ勝手に変えたんですか?」
```

**何が問題だったか:**
1. **会話履歴で「前回」を確認しなかった**
2. **直近のファイルだけ見て判断した**
3. **CLAUDE.mdの仕様を確認しなかった**

**本来すべきだったこと:**
1. 会話履歴で「前回」がいつか確認
2. 前回の実装内容を確認（CLAUDE.md、実装ファイル、会話ログ）
3. 前回と全く同じ方法を使用
4. ユーザーに報告：「前回（○月○日）の方法を使用します」

## なぜこれがMUST Ruleなのか

- **ユーザー指示の厳守**（MUST Rule 1違反）
- **一貫性の欠如**（品質問題）
- **時間の無駄**（やり直しが発生）
- **信頼の損失**（「話を聞いていない」）
- **繰り返し発生**（同じ失敗を何度もする）

## memory-guardianとの連携

このルールは memory-guardian Section 4 によって自動的にチェックされます。

**トリガーフレーズ:**
- 「〜と同じ」
- 「〜と同じアーキテクチャー」
- 「〜と同様に」
- 「〜と同じように」
- 「〜と揃える」
- 「〜に合わせる」
- 「前回と同じ」
- 「いつもの」

**memory-guardianが検出した場合:**
1. 関連ファイルを全て洗い出すよう警告
2. 全てのファイルの該当箇所を確認するよう指示
3. 全体の一貫性を保つよう要求

---

**Current Version: 1.0**
**Last Updated: 2025-01-10**
