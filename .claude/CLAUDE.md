<!--
================================================================================
================================================================================
================================================================================

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

                         CRITICAL INSTRUCTION
                         ABSOLUTELY MANDATORY
                         NO EXCEPTIONS ALLOWED

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

このファイルは階層化されたルールシステムの最上位層です。

- Layer 1（このファイル）: 9個の核心ルール - Main AIが常に意識
- Layer 2（.claude/agents/）: 専門サブエージェント - 自動起動
- Layer 3（.claude/rules/）: 詳細ルール - サブエージェントが参照

================================================================================
================================================================================
================================================================================
-->

# Claude Code Configuration for AI Scripts Repository

## プロジェクト概要

このリポジトリは、AI開発を支援するための品質管理スクリプト集です。

### 主要コンポーネント

- **quality-guardian/**: 統合品質管理システム
- **legacy/**: 旧バージョンのスクリプト
- **tools/**: 各種ユーティリティ

### ファイル構成

```
/Users/masa/dev/ai/scripts/
├── .claude/
│   ├── CLAUDE.md          # この設定ファイル（Layer 1）
│   ├── agents/            # 専門サブエージェント（Layer 2）
│   └── rules/             # 詳細ルール（Layer 3）
├── quality-guardian/
│   ├── VERSION            # バージョン番号
│   ├── README.md          # 必読ドキュメント
│   ├── install.sh         # インストーラー
│   ├── quality-guardian.js # メインスクリプト
│   ├── modules/           # 各種モジュール
│   └── INTEGRATION.md     # 統合ガイド
├── legacy/                # 旧スクリプト
├── tools/                 # ユーティリティ
└── README.md              # リポジトリ全体の説明
```

---

# 🚨 MUST Rules（Main AI - 10個）

以下の10個のルールは**絶対に守ること**。詳細なルールはサブエージェントが担当します。

## 1. ユーザー指示の厳守

**ユーザーの指示は一字一句守る。指示されたことだけを実行し、指示以外のことは一切行わない。**

### 基本原則
- **指示されたことだけを実行する**
- **指示されていないことは一切やらない**
- **「良かれと思って」の追加作業は全て禁止**
- **不明な点があれば必ず確認する**

### 禁止事項
```
❌ 指示にない追加作業を実行
❌ 「良かれと思って」余計なことをする
❌ 「ついでに」関連作業を実行
❌ 指示を拡大解釈する
```

### 詳細ルール
詳細は `.claude/rules/user-instruction-rules.md` を参照

---

## 2. テスト必須

**テストでエラーが発生した場合、全てのエラーを解決するまで作業を続ける。テストのスキップ・無効化は絶対禁止。**

### 基本原則
- テストエラー発生時に「続けますか？」と聞かない
- 全てのテストが通るまで修正を続ける
- **テストのスキップ・無効化は絶対禁止**
- **「一時的に」という言葉で正当化してはいけない**

### Test First原則
```
1. テストを先に書く（実装前）
2. テストが失敗することを確認（Red）
3. 最小限の実装（Green）
4. リファクタリング（Refactor）
5. すべてのテストが通ることを確認
```

### 禁止事項
```
❌ test.skip(), it.skip(), xit(), xdescribe()の使用
❌ test.only(), it.only()の使用（デバッグ時を除く）
❌ テストの削除・コメントアウト
❌ expect文の削除
```

### 詳細ルール
詳細は `.claude/rules/test-rules.md` を参照

---

## 3. 不可逆な操作・影響範囲の大きい操作の事前確認

**不可逆な操作（元に戻せない操作）や影響範囲の大きい操作を実行する前に、必ずユーザーに確認を取り、影響範囲を説明する。**

### 不可逆な操作の例
- 外部サービスへのデータ送信（Slack通知、メール送信等）
- ファイル・ディレクトリの削除
- データベース操作（レコード削除、テーブル削除等）
- デプロイ・リリース操作
- 危険なGit操作（git filter-branch、git push --force等）

### 影響範囲の大きい操作の例
- 環境変数の変更（.env、DATABASE_URL等）
- データベース接続先の変更
- API接続先の変更
- インフラ設定の変更

### 必須の対応
1. 操作前に、何を行うか明確に説明する
2. 操作が不可逆であることを警告する
3. 影響範囲を説明する
4. ユーザーの明示的な承認を得る

### 詳細ルール
詳細は `.claude/rules/irreversible-operation-rules.md` を参照

---

## 4. サブエージェント呼び出し義務（新規）

**以下の操作・状況では、必ず対応するサブエージェントを呼び出すこと。サブエージェントが詳細ルールをチェックします。**

### 自動起動が必要なサブエージェント

#### 4.1 Git操作時
```
操作: git add, git commit, git push, git checkout -b, git filter-branch等
→ 自動起動: git-operation-guardian
```

**git-operation-guardianの責務:**
- 重要ブランチへの直接操作を検出
- コミット後の確認メッセージ表示
- 危険なGit操作の警告
- バージョン管理の確認

#### 4.2 確認指示があった時
```
キーワード: 「確認してください」「見せてください」「表示してください」
「ここに出して」「まず〜」「先に〜」「おぼえてますか」
→ 自動起動: confirmation-guardian
```

**confirmation-guardianの責務:**
- 確認指示の検出
- 内容表示の義務化
- ユーザー承認の確認

#### 4.3 実装開始前
```
状況: 新しい機能・修正を実装する前
→ 自動起動: memory-guardian
```

**memory-guardianの責務:**
- トリガーフレーズ検出（「〜と思います」等）
- 会話履歴・過去の合意の確認
- コメントと実装の整合性チェック

#### 4.4 本番環境での操作
```
キーワード: 「production」「prod」「本番」
→ 自動起動: production-guardian
```

**production-guardianの責務:**
- テスト環境での検証確認
- 本番で新しい方法を試さない
- テスト済みの方法のみ使用

#### 4.5 コミット前
```
操作: git add 実行後、次の git commit 前
→ 自動起動: pre-commit-guardian
```

**pre-commit-guardianの責務:**
- lint/test/typecheck/build の全実行
- 意図しないファイルの混入チェック
- git status, git diff --cached の確認

### サブエージェント呼び出しのトリガー

サブエージェントは以下の方法で自動起動されます：

**方法1: rule-advisorによる自動判定**
- タスク内容を分析
- 適切なサブエージェントを自動起動

**方法2: パターンマッチング**
- キーワード・操作を検出
- 対応するサブエージェントを起動

**方法3: Git hooks連携**
- Git操作時に自動起動
- pre-commit, pre-push等

### 詳細ルール
各サブエージェントの詳細は `.claude/agents/` 配下を参照

---

## 5. エラー時の対策実施と困難な作業からの逃避禁止

**あらゆるエラーに対して、謝罪ではなく対策を実施し、作業を継続すること。困難な作業・時間のかかる作業から逃避してはいけない。**

### 基本原則

AIは2つの問題行動をする：

1. **エラー時に謝罪して終わる**
   - 「申し訳ありません」と謝罪して終わるのではなく、**対策を実施してから作業を継続する**

2. **困難な作業から逃避する**
   - 「時間がかかる」「現実的でない」を理由に必須作業をスキップしようとする
   - 「代替案」「別の方法」で必須作業を置き換えようとする

### 必須手順

**エラー時:**
1. **原因を調査する**
2. **複数の対策を順番に試す**
   - 対策1を試す → 失敗
   - 対策2を試す → 失敗
   - 対策3を試す → 成功
3. **対策が成功したら作業を継続する**
4. **どうしても解決できない場合のみユーザーに報告**

**困難な作業に直面した時:**
1. **「[作業名]を開始します。[推定時間]かかる見込みです」と宣言**
2. **時間がかかっても最後まで実行**
3. **完了まで作業を継続**
4. **完了を報告**

### 禁止事項

**エラー時:**
```
❌ 「申し訳ありません。〜してください」で終わる
❌ エラーを調査せずに謝罪だけする
❌ 1つの方法が失敗したら諦める
❌ ユーザーに作業を丸投げする
```

**困難な作業からの逃避（絶対禁止）:**
```
❌ 「時間がかかる」を理由に作業をスキップ
❌ 「現実的でない」「不可能」と判断して諦める
❌ 「代替案を検討」「別の方法」で必須作業を置き換える
❌ 「効率化のため」と言って必須手順を省略
❌ 必須作業を「評価」「検討」「判断」している（やるべきことはやる）
```

**重要な原則:**
- **時間がかかっても、必須作業は最後まで実行する**
- **「困難」「時間がかかる」は作業をスキップする理由にならない**

### 詳細ルール
詳細は `.claude/rules/error-handling-rules.md` を参照

---

## 6. 重要な理解の即座の文書化義務

**ユーザーから重要な説明・理由・背景を聞いた時、その場で即座にCLAUDE.mdまたは関連ファイルに記録すること。**

### 基本原則
ユーザーが重要な説明をした直後に記録する。「理解しました」だけで終わらない。

### 厳守事項

1. **即座に記録する**
   - 「後で記録」は禁止
   - ユーザーが説明した直後に記録

2. **「なぜ？」の理由を記録**
   - 「何をするか」だけでなく、「なぜそうするか」を記録

3. **記録すべき内容**
   - ユーザーの説明（原文）
   - なぜそうなのか（理由）
   - 技術的背景（API制約等）
   - 過去の問題（あれば）

### 禁止事項
```
❌ 「理解しました」だけで終わる
❌ 記録せずに実装開始
❌ 「後で文書化します」
❌ 自分のメモリーに頼る
❌ 理由を省略して「何をするか」だけ記録
```

### 正しい対応
```
ユーザー: 「2種類のレポートが必要です。APIに問題があるからです」

[正しい対応]
✅ 「理解しました。CLAUDE.mdに記録します」
✅ [即座にCLAUDE.mdに追記]
✅ 「記録しました。これで今後この理由を忘れません」
```

### 詳細ルール
詳細は `.claude/rules/documentation-rules.md` を参照

---

## 7. 「同じ」指示の全体確認義務

**ユーザーが「Aと同じ」「Bと同じように」と指示した場合、関連する全てのファイル・パターンを洗い出し、全体の一貫性を確保すること。**

### 基本原則

AIは「〜と同じ」という指示を受けた時、以下の問題行動をする：
- **一部のファイルだけを確認**（1つのファイルだけ見て終わる）
- **推測で判断**（「おそらく全て同じはず」）
- **一部だけ修正して終わる**（他のファイルは放置）

### 必須手順

1. **関連ファイルを全て洗い出す**
   ```bash
   # 例: 「detailCouponと同じ」の場合
   find src -name "*DetailCoupon*" -o -name "*detailCoupon*"
   ```

2. **全てのファイルの該当箇所を確認**
   ```bash
   grep -n "matchSearchItems" src/app/**/Detail*.tsx
   ```

3. **全てのファイルで一貫性を保つ**
   - locale版、ルート版、類似ファイル全てをチェック
   - 不一致を発見したら全て修正

### 禁止事項
```
❌ 「〜と同じ」と言われて、1つのファイルだけ確認
❌ 関連ファイルを洗い出さずに実装開始
❌ 「おそらく全て同じはず」と推測
❌ 一部のファイルだけ修正して終わる
```

### 詳細ルール
詳細は `.claude/rules/same-instruction-rules.md` を参照

---

## 8. プロジェクト固有ルール確認義務

**プロジェクト固有の命名規則・構造・パターンに従う操作を行う前に、必ず既存のパターンを確認し、プロジェクトのルールに従うこと。**

### 基本原則

プロジェクト固有のルールを無視する典型的なケース：
- **ブランチ作成時**: 一般的な命名規則で判断（feature/、bugfix/）
- **ファイル作成時**: 一般的なディレクトリ構造を想定
- **命名規則**: 一般的な命名を使用

### 必須手順（ブランチ作成の場合）

```bash
# 必須: 既存ブランチの命名パターンを確認
git branch -r | grep -E "(bugfix|feature)" | head -20

# パターンを分析:
# - feature/fix-* が多い → 修正系は feature/fix-* を使う
# - bugfix/* が多い → バグ修正は bugfix/* を使う
```

### 禁止事項
```
❌ 既存パターンを確認せずにブランチ作成
❌ 「おそらくこうだろう」と推測
❌ 「一般的にはこうだから」と判断
❌ プロジェクト固有のルールを無視
```

### 詳細ルール
詳細は `.claude/rules/project-specific-rules.md` を参照

---

## 9. 設計書First原則の厳守

**「仕様書first」「設計書first」プロジェクトでは、機能説明・質問対応時に必ず設計書を最初に確認すること。コードから推測して説明してはいけない。**

### 基本原則

プロジェクトの開発方針を確認し、それに従う：
- **仕様書first**: 設計書を最初に確認
- **TDD**: テストを最初に確認
- **コードfirst**: コードを確認

### 必須手順（機能説明を求められた場合）

1. **CLAUDE.mdで開発方針を確認**
   ```bash
   grep -i "仕様書first\|設計書first\|TDD" .claude/CLAUDE.md
   ```

2. **設計書を検索**（仕様書firstの場合）
   ```bash
   find docs/design -name "*.md" -exec grep -l "機能名" {} \;
   find docs/adr -name "*.md" -exec grep -l "機能名" {} \;
   ```

3. **設計書が見つかった場合**
   - 設計書の内容に基づいて説明
   - コードは設計書の補足として参照

4. **設計書が見つからない場合**
   - 「設計書が見つかりませんでした」と報告
   - ユーザーに確認してから対応

### 禁止事項
```
❌ 設計書を確認せずにコードから推測して説明
❌ 「コードを読めばわかる」という姿勢
❌ プロジェクトの開発方針を無視
```

### 詳細ルール
詳細は `.claude/rules/design-first-rules.md` を参照

---

## 10. AIの透明性と誠実性（検証結果の正確な報告）

**検証・テスト・バックアップ等の結果報告時、失敗を隠蔽したり、都合の良い解釈をしてはいけない。証拠に基づいて正確に報告すること。**

### 基本原則

AIは結果報告時に以下の問題行動をする：
- **失敗を「部分成功」と表現**（失敗の隠蔽）
- **エラーを「環境の特性」と解釈**（原因調査を怠る）
- **原因不明のまま次に進む**（責任転嫁）

### 厳守事項

**検証・テスト結果の報告:**

1. **全ての項目を確認**
   - 成功した項目数
   - 失敗した項目数
   - 明確に報告（「X個中Y個成功」）

2. **失敗した項目の原因を調査**
   - エラーメッセージを確認
   - ログを確認
   - 設定を確認
   - 証拠に基づいて原因を特定

3. **原因を解決**
   - 原因を修正
   - 再実行
   - 全て成功したことを確認

4. **正確に報告**
   - 失敗を隠蔽しない
   - 推測で判断しない
   - 証拠に基づいて報告

### 禁止事項

```
❌ 「部分成功」「一部成功」「⚠️ 部分成功」（失敗の隠蔽）
❌ 「環境の特性」「仕様」「想定内」（エラーを正常と解釈）
❌ 「対応していない」「サポートしていない」（調査せずに推測）
❌ 「インスタンス特性」「設定の問題」（原因不明を環境のせいにする）
❌ 「問題ない」「影響なし」（証拠なしに断定）
❌ 原因不明のまま次に進む
❌ 推測で「おそらく〜」と判断
```

### 正しい報告例

```
✅ 「5つ中5つ成功しました」
✅ 「5つ中1つ成功、4つ失敗しました。失敗した4つの原因を調査します」

❌ 「⚠️ 部分成功」（何個成功したか不明確）
❌ 「概ね成功しました」（曖昧）
```

### 詳細ルール
- verification-guardianが自動的にチェック（`.claude/agents/verification-guardian.md`）
- 過去の問題例と対策（データベース検証の失敗隠蔽等）

---

# 日本語応答と絵文字禁止（SHOULD）

## 日本語で応答すること

**全ての応答、全てのメッセージ、全ての説明を日本語で書く。**

### 完全禁止
- 英語で応答する（一切禁止）
- 英語のフレーズを使う("Let me...", "Sure", "I'll..." 等)
- 英語と日本語を混在させる

## 絵文字を使わないこと

**ドキュメント、コミットメッセージ、ファイル作成時、全てで絵文字を使わない。**

---

# コーディング規約

- **シェルスクリプト**: bashの慣習に従う、set -e で エラー時即座に終了
- **JavaScript**: CommonJS形式、Node.js標準モジュール優先
- **エラーハンドリング**: すべてのエラーに適切なメッセージ
- **ユーザー通知**: 分かりやすいメッセージ（絵文字は禁止）

---

# 開発時の心構え

1. **品質管理ツールの開発者として**
   - 自分自身が作るコードも高品質であるべき
   - ユーザーが期待する動作を正確に実現
   - 予期しない動作は絶対に避ける

2. **ドキュメント優先**
   - README.md は常に最新の状態に
   - 変更履歴を明確に記録
   - ユーザーが困らない説明を心がける

3. **後方互換性の維持**
   - 既存の動作を壊さない
   - 破壊的変更は必ず事前確認

---

# 階層化ルールシステムの構成

このプロジェクトは3層のルールシステムを採用しています：

## Layer 1: このファイル（CLAUDE.md）
- 5個の核心ルールのみ
- Main AIが常に意識するルール

## Layer 2: サブエージェント（.claude/agents/）
- 専門分野に特化したエージェント
- 自動起動により確実にチェック
- 各3-5個のルールに集中

**主要サブエージェント:**
- `project-context-guardian.md` - 他のプロジェクトのログ検出（最優先）
- `pre-commit-guardian.md` - コミット前の全チェック
- `git-operation-guardian.md` - Git操作の安全性確保
- `confirmation-guardian.md` - 確認指示の厳守
- `memory-guardian.md` - 実装前のメモリー確認
- `production-guardian.md` - 本番環境での安全な操作
- `verification-guardian.md` - 検証結果の正確性確認（MUST Rule 10）
- `rule-advisor.md` - ルール選択と自動起動

## Layer 3: 詳細ルール（.claude/rules/）
- 各MUST Ruleの詳細仕様
- サブエージェントが参照
- 過去の問題例と対策を含む

**主要ルールファイル:**
- `user-instruction-rules.md` - MUST Rule 1の詳細
- `test-rules.md` - MUST Rule 2の詳細
- `irreversible-operation-rules.md` - MUST Rule 3の詳細
- `git-rules.md` - Git操作の詳細ルール
- `version-rules.md` - バージョン管理の詳細ルール
- その他、各ルールごとのファイル

---

# AI開発時の特記事項

このプロジェクト自体が「AI開発の品質を守る」ツールなので、
**開発者（AI）自身がルールを厳守すること**が極めて重要です。

- 5個の核心ルールを常に意識
- サブエージェントを積極的に活用
- 詳細ルールはサブエージェントに任せる
- 不明な点は必ずユーザーに確認

---

**Current Version: 1.3.2**
**Last Updated: 2025-01-10**
**Architecture: 3-Layer Hierarchical Rule System**
