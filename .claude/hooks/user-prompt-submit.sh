#!/bin/bash
# quality-guardianç”¨ user-prompt-submit hook
# åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ã‚°ã‚’æ¤œå‡ºã—ã¦ã€ä¿®æ­£ã§ã¯ãªãåˆ†æã‚’ä¿ƒã™

set -e

# å…¥åŠ›ã‚’èª­ã¿å–ã‚‹ï¼ˆJSONå½¢å¼ï¼‰
INPUT=$(cat)

# ãƒ‡ãƒãƒƒã‚°: å—ã‘å–ã£ãŸå…¥åŠ›ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
echo "=== HOOK DEBUG $(date) ===" >> /tmp/quality-guardian-hook-debug.log
echo "$INPUT" >> /tmp/quality-guardian-hook-debug.log

# JSONã‹ã‚‰ prompt ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŠ½å‡º
USER_MESSAGE=$(echo "$INPUT" | jq -r '.prompt // empty')

# ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ã‚¹
THIS_PROJECT="/Users/masa/dev/ai/scripts"

# æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³
DETECTED=0

# 1. åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ã‚¹æ¤œå‡º
if echo "$USER_MESSAGE" | grep -qE '/Users/masa/dev/[^/]+/' | grep -qvE '/Users/masa/dev/ai/scripts'; then
  DETECTED=1
fi

# 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼æ¤œå‡º
if echo "$USER_MESSAGE" | grep -qE 'password authentication failed|FATAL.*password|pg_hba.conf|Connection terminated|cloudsqlsuperuser'; then
  DETECTED=1
fi

# 3. Git worktreeé•åæ¤œå‡º
if echo "$USER_MESSAGE" | grep -qE 'git checkout -b|ãƒ–ãƒ©ãƒ³ãƒã¯w[or]ktreeã§å¯¾å¿œ'; then
  DETECTED=1
fi

# 4. Claude Codeå®Ÿè¡Œãƒ­ã‚°æ¤œå‡ºï¼ˆâºãƒãƒ¼ã‚¯ï¼‰
if echo "$USER_MESSAGE" | grep -qE 'âº|Bash\(|Read\(|Edit\(|Write\('; then
  DETECTED=1
fi

# 5. Bitbucket/GitHub URLæ¤œå‡º
if echo "$USER_MESSAGE" | grep -qE 'bitbucket\.org|github\.com.*pull/[0-9]+'; then
  DETECTED=1
fi

# æ¤œå‡ºæ™‚ã®å¯¾å¿œ
if [ $DETECTED -eq 1 ]; then
  cat <<'EOF'

ğŸš¨ğŸš¨ğŸš¨ BLOCKER: åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ã‚°ã‚’æ¤œå‡ºã—ã¾ã—ãŸ ğŸš¨ğŸš¨ğŸš¨

ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯ã€ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆquality-guardianï¼‰ä»¥å¤–ã®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ã€é‡è¦ã€‘
- ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ã‚¹: /Users/masa/dev/ai/scripts/quality-guardian/
- åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å•é¡Œã‚’ä¿®æ­£ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“
- AI guardianã¨ã—ã¦åˆ†æã®ã¿è¡Œã£ã¦ãã ã•ã„

ã€æ¤œå‡ºã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘
ä»¥ä¸‹ã®ã„ãšã‚Œã‹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼š
- åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ï¼ˆpassword authentication failedç­‰ï¼‰
- Git worktreeä½¿ç”¨é•åï¼ˆgit checkout -bç­‰ï¼‰
- Claude Codeå®Ÿè¡Œãƒ­ã‚°ï¼ˆâºãƒãƒ¼ã‚¯ç­‰ï¼‰
- Bitbucket/GitHub URL

ã€æ­£ã—ã„å¯¾å¿œã€‘
1. ã€Œã“ã‚Œã¯åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ã‚°ã§ã™ã€ã¨å®£è¨€
2. project-context-guardianã‚’èµ·å‹•ã—ã¦ãƒ«ãƒ¼ãƒ«é•åã‚’åˆ†æ
3. quality-guardianè‡ªä½“ã‚’å¼·åŒ–ï¼ˆãƒ«ãƒ¼ãƒ«è¿½åŠ ã€ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¹å–„ï¼‰
4. ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã¨ã‚³ãƒŸãƒƒãƒˆ

ã€çµ¶å¯¾ç¦æ­¢ã€‘
âŒ åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£
âŒ åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
âŒ åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å•é¡Œã‚’è§£æ±º
âŒ ã€Œä¿®æ­£ã—ã¾ã™ã€ã¨åå¿œ

EOF
fi

# ============================================================================
# é‡è¦ãªMUST Rulesã‚’æ¯å›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å†è¡¨ç¤ºï¼ˆå†å¸°çš„ãƒ«ãƒ¼ãƒ«è¡¨ç¤ºï¼‰
# ============================================================================

cat <<'EOF'

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”´ MUST Rules - ä½œæ¥­å‰ã«æ¯å›ç¢ºèªãƒ»è¡¨ç¤ºã™ã‚‹ã“ã¨ ğŸ”´
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€MUST Rule 0: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç¢ºèªç¾©å‹™ã€‘
ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: /Users/masa/dev/ai/scripts/quality-guardian/
âŒ åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å•é¡Œã‚’ä¿®æ­£ã—ã¦ã¯ã„ã‘ãªã„
âŒ åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ã¯ã„ã‘ãªã„

ã€MUST Rule 2: Test First & å‹•ä½œç¢ºèªå¿…é ˆã€‘
âœ… å®Ÿè£…å‰ã«å¿…ãšãƒ†ã‚¹ãƒˆã‚’å…ˆã«æ›¸ãï¼ˆTest Firstå³å®ˆï¼‰
âœ… å®Ÿè£…å¾Œã«Playwright/curl/unittestã§å‹•ä½œç¢ºèª
âœ… å…¨ã¦ã®ç¢ºèªãŒå®Œäº†ã—ã¦ã‹ã‚‰ã€Œå®Œäº†ã—ã¾ã—ãŸã€ã¨å ±å‘Š
âŒ ãƒ†ã‚¹ãƒˆæœªå®Ÿæ–½ã§ã€Œå®Œäº†ã€ã¨å ±å‘Šã—ã¦ã¯ã„ã‘ãªã„
âŒ å‹•ä½œç¢ºèªæœªå®Ÿæ–½ã§ã€Œå®Œäº†ã€ã¨å ±å‘Šã—ã¦ã¯ã„ã‘ãªã„

ã€MUST Rule 4: Gitæ“ä½œå‰ã®ç¢ºèªç¾©å‹™ã€‘
âœ… gitæ“ä½œå‰ã«å¿…ãš `git branch --show-current` ã§ç¢ºèª
âœ… main/develop/masterã®å ´åˆã¯å³åº§ã«featureãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
âŒ main/develop/masterã¸ã®ç›´æ¥commitã¯çµ¶å¯¾ç¦æ­¢
âŒ ãƒ–ãƒ©ãƒ³ãƒç¢ºèªãªã—ã§git add/commit/pushã—ã¦ã¯ã„ã‘ãªã„

ã€MUST Rule 11: å‹•ä½œç¢ºèªã®è‡ªå·±å®Œçµç¾©å‹™ã€‘
âœ… å®Ÿè£…å®Œäº†å¾Œã€Playwrightã§è‡ªåˆ†ã§å‹•ä½œç¢ºèª
âŒ ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªã—ã¦ãã ã•ã„ã€ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¾é ¼ã—ã¦ã¯ã„ã‘ãªã„

ã€å†å¸°çš„ãƒ«ãƒ¼ãƒ«è¡¨ç¤ºã®ç¾©å‹™ã€‘
ã“ã®MUST Rulesã‚’ä½œæ¥­é–‹å§‹å‰ã«æ¯å›ç¢ºèªã—ã€å¿œç­”ã®æœ€åˆã«å¿…ãšè¡¨ç¤ºã™ã‚‹ã“ã¨ã€‚
æ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã‚‚ã“ã®ãƒ«ãƒ¼ãƒ«ã‚’è¡¨ç¤ºã—ç¶šã‘ã‚‹ã“ã¨ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

EOF

exit 0
