#!/bin/bash
# quality-guardianç”¨ user-prompt-submit hook
# åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ã‚°ã‚’æ¤œå‡ºã—ã¦ã€ä¿®æ­£ã§ã¯ãªãåˆ†æã‚’ä¿ƒã™

set -e

# å…¥åŠ›ã‚’èª­ã¿å–ã‚‹ï¼ˆJSONå½¢å¼ï¼‰
INPUT=$(cat)

# ãƒ‡ãƒãƒƒã‚°: å—ã‘å–ã£ãŸå…¥åŠ›ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
echo "=== HOOK DEBUG $(date) ===" >> /tmp/quality-guardian-hook-debug.log
echo "$INPUT" >> /tmp/quality-guardian-hook-debug.log

# JSONã‹ã‚‰ prompt ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŠ½å‡º
USER_MESSAGE=$(echo "$INPUT" | jq -r '.prompt // empty')

# ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ã‚¹
THIS_PROJECT="/Users/masa/dev/ai/scripts"

# æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³
DETECTED=0

# 1. åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ã‚¹æ¤œå‡º
if echo "$USER_MESSAGE" | grep -qE '/Users/masa/dev/[^/]+/' | grep -qvE '/Users/masa/dev/ai/scripts'; then
  DETECTED=1
fi

# 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼æ¤œå‡º
if echo "$USER_MESSAGE" | grep -qE 'password authentication failed|FATAL.*password|pg_hba.conf|Connection terminated|cloudsqlsuperuser'; then
  DETECTED=1
fi

# 3. Git worktreeé•åæ¤œå‡º
if echo "$USER_MESSAGE" | grep -qE 'git checkout -b|ãƒ–ãƒ©ãƒ³ãƒã¯w[or]ktreeã§å¯¾å¿œ'; then
  DETECTED=1
fi

# 4. Claude Codeå®Ÿè¡Œãƒ­ã‚°æ¤œå‡ºï¼ˆâºãƒãƒ¼ã‚¯ï¼‰
if echo "$USER_MESSAGE" | grep -qE 'âº|Bash\(|Read\(|Edit\(|Write\('; then
  DETECTED=1
fi

# 5. Bitbucket/GitHub URLæ¤œå‡º
if echo "$USER_MESSAGE" | grep -qE 'bitbucket\.org|github\.com.*pull/[0-9]+'; then
  DETECTED=1
fi

# æ¤œå‡ºæ™‚ã®å¯¾å¿œ
if [ $DETECTED -eq 1 ]; then
  cat <<'EOF'

ğŸš¨ğŸš¨ğŸš¨ BLOCKER: åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ã‚°ã‚’æ¤œå‡ºã—ã¾ã—ãŸ ğŸš¨ğŸš¨ğŸš¨

ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯ã€ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆquality-guardianï¼‰ä»¥å¤–ã®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ã€é‡è¦ã€‘
- ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ã‚¹: /Users/masa/dev/ai/scripts/quality-guardian/
- åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å•é¡Œã‚’ä¿®æ­£ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“
- AI guardianã¨ã—ã¦åˆ†æã®ã¿è¡Œã£ã¦ãã ã•ã„

ã€æ¤œå‡ºã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘
ä»¥ä¸‹ã®ã„ãšã‚Œã‹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼š
- åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ï¼ˆpassword authentication failedç­‰ï¼‰
- Git worktreeä½¿ç”¨é•åï¼ˆgit checkout -bç­‰ï¼‰
- Claude Codeå®Ÿè¡Œãƒ­ã‚°ï¼ˆâºãƒãƒ¼ã‚¯ç­‰ï¼‰
- Bitbucket/GitHub URL

ã€æ­£ã—ã„å¯¾å¿œã€‘
1. ã€Œã“ã‚Œã¯åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ã‚°ã§ã™ã€ã¨å®£è¨€
2. project-context-guardianã‚’èµ·å‹•ã—ã¦ãƒ«ãƒ¼ãƒ«é•åã‚’åˆ†æ
3. quality-guardianè‡ªä½“ã‚’å¼·åŒ–ï¼ˆãƒ«ãƒ¼ãƒ«è¿½åŠ ã€ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¹å–„ï¼‰
4. ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã¨ã‚³ãƒŸãƒƒãƒˆ

ã€çµ¶å¯¾ç¦æ­¢ã€‘
âŒ åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£
âŒ åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
âŒ åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å•é¡Œã‚’è§£æ±º
âŒ ã€Œä¿®æ­£ã—ã¾ã™ã€ã¨åå¿œ

EOF
fi

# ============================================================================
# å…¨MUST Rulesã‚’æ¯å›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å†è¡¨ç¤ºï¼ˆå†å¸°çš„ãƒ«ãƒ¼ãƒ«è¡¨ç¤ºï¼‰
# ============================================================================

cat <<'EOF'

# ğŸ”´ CRITICAL Rulesï¼ˆæœ€é‡è¦ãƒ»12å€‹ï¼‰- æ¯å›ç¢ºèª

ã€Rule 1: ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤ºã®å³å®ˆã€‘
æŒ‡ç¤ºã•ã‚ŒãŸã“ã¨ã ã‘ã‚’å®Ÿè¡Œã€‚æŒ‡ç¤ºä»¥å¤–ã¯ä¸€åˆ‡ç¦æ­¢ã€‚

ã€Rule 2: ãƒ†ã‚¹ãƒˆå¿…é ˆã¨å®Œäº†åŸºæº–ã€‘
Test FirståŸå‰‡å³å®ˆã€‚å…¨ãƒ†ã‚¹ãƒˆåˆæ ¼ã¾ã§ã€Œå®Œäº†ã€ç¦æ­¢ã€‚
è©³ç´°: `.claude/rules/must-rules.md` Rule 2

ã€Rule 3: ä¸å¯é€†ãªæ“ä½œã®äº‹å‰ç¢ºèªã€‘
Slacké€šçŸ¥ãƒ»å‰Šé™¤ãƒ»Gitå±é™ºæ“ä½œã¯äº‹å‰ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªå¿…é ˆã€‚
è©³ç´°: `.claude/rules/must-rules.md` Rule 3

ã€Rule 4: Gitæ“ä½œå‰ã®ç¢ºèªç¾©å‹™ã€‘
git-operation-guardian ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ©ç”¨
ã‚¿ã‚¤ãƒŸãƒ³ã‚°: git add/commit/push/checkout -b ç­‰ã®å‰
è©³ç´°: `.claude/agents/git-operation-guardian.md`

ã€Rule 5: ã‚¨ãƒ©ãƒ¼æ™‚ã®å¯¾ç­–å®Ÿæ–½ã¨ä½œæ¥­ç¶™ç¶šã€‘
è¬ç½ªã§ã¯ãªãå¯¾ç­–å®Ÿæ–½ã€‚å›°é›£ãªä½œæ¥­ã‹ã‚‰é€ƒé¿ç¦æ­¢ã€‚

ã€Rule 6: é‡è¦ãªç†è§£ã®å³åº§ã®æ–‡æ›¸åŒ–ã€‘
ã€Œä½•å›ã‚‚è¨€ã£ã¦ã„ã‚‹ã€â†’ å³åº§ã«CLAUDE.mdã«è¨˜éŒ²ã€‚
ãƒˆãƒªã‚¬ãƒ¼: ã€Œã€œã™ã¹ãã€ã€Œã€œã—ã¦ã¯ã„ã‘ãªã„ã€ã€Œå›°ã£ã¦ã„ã‚‹ã€

ã€Rule 7: ã€ŒåŒã˜ã€æŒ‡ç¤ºã®å…¨ä½“ç¢ºèªã€‘
ã€ŒAã¨åŒã˜ã€â†’ é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«å…¨ã¦æ´—ã„å‡ºã—ã€ä¸€è²«æ€§ç¢ºä¿ã€‚
è©³ç´°: `.claude/rules/must-rules.md` Rule 7

ã€Rule 9: è¨­è¨ˆæ›¸FirståŸå‰‡ã€‘
è¨­è¨ˆæ›¸firstãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€å¿…ãšè¨­è¨ˆæ›¸ã‚’æœ€åˆã«ç¢ºèªã€‚
è©³ç´°: `.claude/rules/must-rules.md` Rule 9

ã€Rule 11: å‹•ä½œç¢ºèªã®è‡ªå·±å®Œçµç¾©å‹™ã€‘
Playwrightã§è‡ªåˆ†ã§ç¢ºèªã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¾é ¼ç¦æ­¢ã€‚
è©³ç´°: `.claude/agents/memory-guardian.md` Section 1.9

ã€Rule 12: å•é¡Œç™ºç”Ÿæ™‚ã®å†ç™ºé˜²æ­¢ç¾©å‹™ã€‘
å•é¡Œç™ºç”Ÿ â†’ åŸå› åˆ†æ â†’ CLAUDE.mdã«ãƒ«ãƒ¼ãƒ«è¿½åŠ  â†’ ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–° â†’ ã‚³ãƒŸãƒƒãƒˆ
è©³ç´°: `.claude/agents/memory-guardian.md`

ã€Rule 16: å•é¡Œè§£æ±ºå¾Œã®å…¨ä½“ç¢ºèªç¾©å‹™ã€‘
å®Ÿè£…ä¿®æ­£ â†’ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚åŒæœŸã€‚
`.claude/hooks/*` âŸ· `templates/hooks/*`
è©³ç´°: `.claude/rules/must-rules.md` Rule 16

ã€Rule 17: Claude Codeç—•è·¡ã®å®Œå…¨æ’é™¤ã€‘
ã‚³ãƒŸãƒƒãƒˆç½²åç¦æ­¢ã€‚çµµæ–‡å­—ç¦æ­¢ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‹æ‰‹ã«ä½œæˆç¦æ­¢ã€‚
è©³ç´°: `.claude/rules/must-rules.md` Rule 17

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å†å¸°çš„ãƒ«ãƒ¼ãƒ«è¡¨ç¤ºã®ç¾©å‹™ã€‘
ã“ã®CRITICAL Rulesã‚’å¿œç­”ã®æœ€åˆã«æ¯å›è¡¨ç¤ºã™ã‚‹ã“ã¨ã€‚

ã€é‡è¦ã€‘çœç•¥ç¦æ­¢ãƒ»ä¸€å­—ä¸€å¥ãã®ã¾ã¾è¡¨ç¤º
âŒ 1è¡Œã«ç°¡ç•¥åŒ–ï¼ˆRule 1:xxx | Rule 2:xxx | ...ï¼‰
âœ… ä¸Šè¨˜ã®è¤‡æ•°è¡Œå½¢å¼ã‚’å®Œå…¨ã«å†ç¾
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

EOF

exit 0
