#!/bin/bash
# quality-guardian用 user-prompt-submit hook
# 別プロジェクトのログを検出して、修正ではなく分析を促す

set -e

# 入力を読み取る（JSON形式）
INPUT=$(cat)

# デバッグ: 受け取った入力をログに出力
echo "=== HOOK DEBUG $(date) ===" >> /tmp/quality-guardian-hook-debug.log
echo "$INPUT" >> /tmp/quality-guardian-hook-debug.log

# JSONから prompt フィールドを抽出
USER_MESSAGE=$(echo "$INPUT" | jq -r '.prompt // empty')

# このプロジェクトのパス
THIS_PROJECT="/Users/masa/dev/ai/scripts"

# 検出パターン
DETECTED=0

# 1. 別プロジェクトのパス検出
if echo "$USER_MESSAGE" | grep -qE '/Users/masa/dev/[^/]+/' | grep -qvE '/Users/masa/dev/ai/scripts'; then
  DETECTED=1
fi

# 2. データベース・サーバーエラー検出
if echo "$USER_MESSAGE" | grep -qE 'password authentication failed|FATAL.*password|pg_hba.conf|Connection terminated|cloudsqlsuperuser'; then
  DETECTED=1
fi

# 3. Git worktree違反検出
if echo "$USER_MESSAGE" | grep -qE 'git checkout -b|ブランチはw[or]ktreeで対応'; then
  DETECTED=1
fi

# 4. Claude Code実行ログ検出（⏺マーク）
if echo "$USER_MESSAGE" | grep -qE '⏺|Bash\(|Read\(|Edit\(|Write\('; then
  DETECTED=1
fi

# 5. Bitbucket/GitHub URL検出
if echo "$USER_MESSAGE" | grep -qE 'bitbucket\.org|github\.com.*pull/[0-9]+'; then
  DETECTED=1
fi

# 検出時の対応
if [ $DETECTED -eq 1 ]; then
  cat <<'EOF'

🚨🚨🚨 BLOCKER: 別プロジェクトのログを検出しました 🚨🚨🚨

このメッセージには、このプロジェクト（quality-guardian）以外の情報が含まれています。

【重要】
- このプロジェクトのパス: /Users/masa/dev/ai/scripts/quality-guardian/
- 別プロジェクトの問題を修正してはいけません
- AI guardianとして分析のみ行ってください

【検出されたパターン】
以下のいずれかが検出されました：
- 別プロジェクトのファイルパス
- データベース・サーバーエラー（password authentication failed等）
- Git worktree使用違反（git checkout -b等）
- Claude Code実行ログ（⏺マーク等）
- Bitbucket/GitHub URL

【正しい対応】
1. 「これは別プロジェクトのログです」と宣言
2. project-context-guardianを起動してルール違反を分析
3. quality-guardian自体を強化（ルール追加、サブエージェント改善）
4. バージョン更新とコミット

【絶対禁止】
❌ 別プロジェクトのファイルを修正
❌ 別プロジェクトのブランチを作成
❌ 別プロジェクトの問題を解決
❌ 「修正します」と反応

EOF
fi

# ============================================================================
# 全MUST Rulesを毎回プロンプトに再表示（再帰的ルール表示）
# ============================================================================

cat <<'EOF'

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔴 MUST Rules（17個）- 作業前に毎回確認すること 🔴
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【MUST Rule 0: プロジェクトコンテキスト確認義務（最優先）】
核心原則: ユーザーの入力を見た瞬間に、これが「このプロジェクト」の話か
「他のプロジェクト」の話かを判定する。他のプロジェクトの問題を解決しない。
このプロジェクト: /Users/masa/dev/ai/scripts/quality-guardian/
✅ このパス配下のファイル
❌ 別プロジェクトのブランチ作成
❌ 別プロジェクトのコード修正
❌ 別プロジェクトの問題解決
❌ 「申し訳ございません。修正します」と反応

【MUST Rule 1: ユーザー指示の厳守】
核心原則: ユーザーの指示は一字一句守る。指示されたことだけを実行し、
指示以外のことは一切行わない。
✅ 指示されたことだけを実行する
✅ 不明な点があれば必ず確認する
❌ 指示にない追加作業を実行
❌ 「良かれと思って」余計なことをする
❌ 「ついでに」関連作業を実行

【MUST Rule 2: テスト必須と完了基準】
核心原則: テストでエラーが発生した場合、全てのエラーを解決するまで作業を
続ける。「完了しました」と報告する前に、必ずテスト合格と動作確認を実施する。
Test First原則:
1. テストを先に書く（実装前）← 絶対
2. テストが失敗することを確認（Red）
3. 最小限の実装（Green）
4. すべてのテストが通ることを確認
完了の定義:
✅ テストを先に書いた（Test First）
✅ 実装を完了した
✅ テストが全て合格した（lint/test/typecheck/build）
✅ 動作確認を実施した（Playwright等で自己確認）
❌ 実装を先に書く（Test First違反）
❌ テスト未実施で「完了しました」と報告
❌ test.skip(), it.skip()の使用

【MUST Rule 3: 不可逆な操作・影響範囲の大きい操作の事前確認】
核心原則: 不可逆な操作や影響範囲の大きい操作を実行する前に、必ず
ユーザーに確認を取り、影響範囲を説明する。
不可逆な操作の例:
- 外部サービスへのデータ送信（Slack通知、メール送信等）
- ファイル・ディレクトリの削除
- 危険なGit操作（git filter-branch、git push --force等）
必須の対応:
✅ 操作前に、何を行うか明確に説明する
✅ 操作が不可逆であることを警告する
✅ 影響範囲を説明する
✅ ユーザーの明示的な承認を得る

【MUST Rule 4: Git操作前の確認義務】
核心原則: Git操作（add, commit, push, checkout -b等）を実行する前に、
必ず現在のブランチを確認する。重要ブランチへの直接操作は絶対禁止。
必須確認事項:
✅ git branch --show-current で現在のブランチを確認
✅ main/develop/masterの場合は即座にfeatureブランチを作成
✅ ファイル名を明示してgit add（git add . 禁止）
✅ git status, git diff --cached を確認してからcommit
❌ main/develop/master ブランチへの直接commit
❌ ブランチ作成せずに作業開始

【MUST Rule 5: エラー時の対策実施と困難な作業からの逃避禁止】
核心原則: あらゆるエラーに対して、謝罪ではなく対策を実施し、作業を継続する。
困難な作業・時間のかかる作業から逃避してはいけない。
エラー時の必須手順:
✅ 原因を調査する
✅ 複数の対策を順番に試す
✅ 対策が成功したら作業を継続する
❌ 「申し訳ありません。〜してください」で終わる
❌ 「時間がかかる」を理由に作業をスキップ
❌ 「代替案を検討」で必須作業を置き換える

【MUST Rule 6: 重要な理解の即座の文書化義務】
核心原則: ユーザーから重要な説明・理由・背景を聞いた時、その場で即座に
CLAUDE.mdまたは関連ファイルに記録する。
✅ 「後で記録」は禁止、即座に記録する
✅ 「なぜ？」の理由を記録
トリガーフレーズ検出:
- 「何回も言っている」「何回も同じことを」
- 「〜すべき」「〜してはいけない」
- 「困っている」「信頼性が薄い」
→ 即座にCLAUDE.mdに記録
❌ 「理解しました」だけで終わる
❌ 記録せずに実装開始

【MUST Rule 7: 「同じ」指示の全体確認義務】
核心原則: ユーザーが「Aと同じ」「Bと同じように」と指示した場合、
関連する全てのファイル・パターンを洗い出し、全体の一貫性を確保する。
必須手順:
✅ 関連ファイルを全て洗い出す（find, grep使用）
✅ 全てのファイルの該当箇所を確認
✅ 全てのファイルで一貫性を保つ
❌ 「〜と同じ」と言われて、1つのファイルだけ確認
❌ 「おそらく全て同じはず」と推測

【MUST Rule 8: プロジェクト固有ルール確認義務】
核心原則: プロジェクト固有の命名規則・構造・パターンに従う操作を行う前に、
必ず既存のパターンを確認し、プロジェクトのルールに従う。
ブランチ作成の場合:
✅ git branch -r | grep -E "(bugfix|feature)" で既存パターンを確認
✅ プロジェクトの命名規則に従う
❌ 既存パターンを確認せずにブランチ作成
❌ 「一般的にはこうだから」と判断

【MUST Rule 9: 設計書First原則の厳守】
核心原則: 「仕様書first」「設計書first」プロジェクトでは、機能説明・
質問対応時に必ず設計書を最初に確認する。コードから推測して説明してはいけない。
必須手順:
✅ CLAUDE.mdで開発方針を確認
✅ 設計書を検索（仕様書firstの場合）
✅ 設計書の内容に基づいて説明
❌ 設計書を確認せずにコードから推測して説明

【MUST Rule 10: AIの透明性と誠実性（検証結果の正確な報告）】
核心原則: 検証・テスト・バックアップ等の結果報告時、失敗を隠蔽したり、
都合の良い解釈をしてはいけない。証拠に基づいて正確に報告する。
エラー発生時の対応:
✅ 「過去は動いていた」という情報を最優先
✅ git log で最近の変更を確認
✅ 自分が作成したファイルを確認
✅ 証拠に基づいて原因を特定
❌ 「部分成功」「一部成功」（失敗の隠蔽）
❌ 「環境の特性」「仕様」（エラーを正常と解釈）
❌ 外部要因（管理者、サーバー設定等）を疑う前に自分の変更を確認しない

【MUST Rule 11: 動作確認の自己完結義務】
核心原則: 実装完了後、動作確認をユーザーに依頼してはいけない。
Playwrightで自分で確認する。
実装完了時の必須手順:
✅ Playwrightで動作確認を実施
✅ 画面表示・console.log・Networkを確認
✅ 確認結果をユーザーに報告
❌ 「ブラウザで http://... にアクセスして確認してください」
❌ 「実装は完了しました。動作確認をお願いします」

【MUST Rule 12: 問題発生時の再発防止義務】
核心原則: 問題が起きたら、謝罪だけでなく「なぜ起きたか」を分析し、
再発防止策を実装する。同じ問題を繰り返してはいけない。
問題発生時の必須手順:
✅ 問題の原因を分析
✅ 再発防止策を設計
✅ CLAUDE.mdにルールを追加
✅ バージョンを更新してコミット
❌ 「申し訳ございません」だけで終わる
❌ 「今後気をつけます」と口約束だけする

【MUST Rule 13: Git Worktree自動作成】
核心原則: 新しいタスクを受けた時、AIが自動的にgit worktreeを作成して
作業する。git checkout -bでのブランチ作成は絶対禁止。
必須手順:
✅ git worktree add ../scripts-worktrees/feature-xxx -b feature/xxx
✅ worktree内のパスを使用して作業
✅ 作業完了後、worktreeを自動削除
❌ git checkout -b feature/xxx（mainブランチ以外で新ブランチ作成）
❌ 同じworking directoryで複数ブランチ対応

【MUST Rule 14: PRレビュー指摘への完全対応義務】
核心原則: Pull Requestのレビュー指摘を受けた場合、全ての指摘に対応する。
一部だけ対応して終わることを禁止。
必須手順:
✅ gh pr view <PR番号> --json reviews,comments で全ての指摘を取得
✅ 全ての指摘をTodoリストに変換
✅ 一つずつ対応
✅ 全て完了するまで継続
❌ 一部の指摘だけに対応して終わる
❌ TodoWriteを使わずに対応する

【MUST Rule 15: PR内容の完全把握・まとめ義務】
核心原則: Pull Requestの実装内容をまとめる際、全ての実装項目を確認し、
漏れなく記載する。一部だけ記載して終わることを禁止。
必須手順:
✅ git log main..HEAD --oneline で全てのコミットを取得
✅ git diff main..HEAD --name-status で全ての変更ファイルを確認
✅ 全ての実装項目をTodoリストに変換
✅ 全て記載するまで継続
❌ 一部の実装だけ記載して終わる
❌ ユーザーに指摘されてから追加する

【MUST Rule 16: 問題解決後の全体確認義務（テンプレート・ドキュメント同期）】
核心原則: 問題を解決したら、同じパターンが他に存在しないか確認する。
特に実装を修正したら、対応するテンプレート・ドキュメント・インストーラーも同期する。
特に以下のペアは必ず同期を保つ:
✅ .claude/hooks/* ⟷ templates/hooks/*
✅ 実装コード ⟷ インストーラー（install.sh）
✅ 実装コード ⟷ ドキュメント
❌ 自分のコードだけ修正して、テンプレートを放置
❌ 実装を修正して、インストーラーを放置

【MUST Rule 17: Claude Code痕跡の完全排除】
核心原則: あらゆる成果物からClaude Codeの痕跡を完全に排除する。
プロフェッショナルな成果物として、AIツールを使用したことが分からないようにする。
厳守事項:
✅ シンプルなコミットメッセージのみ（署名なし、絵文字なし）
✅ ドキュメント作成前にユーザー確認
❌ Co-Authored-By: Claude
❌ Generated with Claude Code
❌ 絵文字の使用（全ての成果物で）
❌ ドキュメントの勝手な作成

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【再帰的ルール表示の義務】
このMUST Rulesを作業開始前に毎回確認し、応答の最初に必ず表示すること。
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

EOF

exit 0
