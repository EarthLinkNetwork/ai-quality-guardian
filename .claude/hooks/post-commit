#!/bin/bash
# Quality Guardian post-commit hook
# PRçŠ¶æ…‹ç¢ºèªï¼ˆMUST Rule 20ï¼‰

set -e

echo "ğŸ“‹ Quality Guardian post-commit check..."

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# MUST Rule 20: PRçŠ¶æ…‹ç¢ºèª
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

echo ""
echo "  checking: PR status (MUST Rule 20)"

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
CURRENT_BRANCH=$(git branch --show-current)

# ä¿è­·ãƒ–ãƒ©ãƒ³ãƒã®ãƒªã‚¹ãƒˆ
PROTECTED_BRANCHES=(
  "main"
  "master"
  "develop"
  "production"
  "staging"
)

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒãŒä¿è­·ãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã¯ãƒã‚§ãƒƒã‚¯ã‚¹ã‚­ãƒƒãƒ—
BRANCH_PROTECTED=0
for PROTECTED in "${PROTECTED_BRANCHES[@]}"; do
  if [ "$CURRENT_BRANCH" = "$PROTECTED" ]; then
    BRANCH_PROTECTED=1
    break
  fi
done

if [ $BRANCH_PROTECTED -eq 1 ]; then
  echo "  â­  protected branch, skipping PR check"
  exit 0
fi

# featureãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã€PRçŠ¶æ…‹ã‚’ç¢ºèª
if [[ "$CURRENT_BRANCH" =~ ^feature/ ]]; then
  # ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
  if git ls-remote --exit-code --heads origin "$CURRENT_BRANCH" >/dev/null 2>&1; then
    echo "  âœ… remote branch exists: origin/$CURRENT_BRANCH"

    # gh ã‚³ãƒãƒ³ãƒ‰ãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª
    if command -v gh >/dev/null 2>&1; then
      # PRãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
      PR_NUMBER=$(gh pr list --head "$CURRENT_BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")

      if [ -n "$PR_NUMBER" ]; then
        echo "  âœ… PR exists: #$PR_NUMBER"
      else
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âš ï¸  MUST Rule 20: PRãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ãƒ–ãƒ©ãƒ³ãƒ: $CURRENT_BRANCH"
        echo "ãƒªãƒ¢ãƒ¼ãƒˆ: origin/$CURRENT_BRANCH"
        echo ""
        echo "PRã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š"
        echo "  gh pr create --base main --title \"Your PR Title\""
        echo ""
        echo "ã¾ãŸã¯ã€GitHubä¸Šã§PRã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š"
        echo "  https://github.com/$(git config --get remote.origin.url | sed 's/.*github.com[:/]\(.*\)\.git/\1/')/compare/$CURRENT_BRANCH"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      fi
    else
      echo "  âš ï¸  gh command not found, skipping PR check"
      echo "     Install gh: https://cli.github.com/"
    fi
  else
    echo "  âš ï¸  remote branch not pushed yet"
    echo "     Push to remote: git push -u origin $CURRENT_BRANCH"
  fi
else
  echo "  â­  not a feature branch, skipping PR check"
fi

echo ""
echo "âœ… Post-commit checks completed"
exit 0
