<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PM Orchestrator Runner - Web UI</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: #2563eb;
      color: white;
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 1.3rem;
      font-weight: 600;
      cursor: pointer;
    }

    .namespace-badge {
      background: rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 12px;
      font-family: monospace;
    }

    .namespace-badge.auto-derived {
      background: rgba(34, 197, 94, 0.3);
    }

    .namespace-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .namespace-selector select {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-family: monospace;
      cursor: pointer;
    }

    .namespace-selector select:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.5);
    }

    .namespace-selector select option {
      background: #2563eb;
      color: white;
    }

    .runner-status {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .runner-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .runner-dot.alive {
      background: #22c55e;
      box-shadow: 0 0 4px #22c55e;
    }

    .runner-dot.dead {
      background: #ef4444;
    }

    .runner-count {
      margin-left: 4px;
    }

    nav {
      display: flex;
      gap: 16px;
    }

    nav a {
      color: rgba(255, 255, 255, 0.9);
      text-decoration: none;
      font-size: 0.9rem;
      padding: 8px 16px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    nav a:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    nav a.active {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .page-header h2 {
      font-size: 1.5rem;
      color: #1f2937;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #e5e7eb;
      color: #374151;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.2s;
    }

    .back-btn:hover {
      background: #d1d5db;
    }

    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 16px;
    }

    .card h3 {
      font-size: 1.1rem;
      margin-bottom: 16px;
      color: #1f2937;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 8px;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .list-item:hover {
      background: #f9fafb;
      border-color: #2563eb;
      transform: translateX(4px);
    }

    .list-item-main {
      flex: 1;
    }

    .list-item-title {
      font-weight: 500;
      color: #111827;
    }

    .list-item-meta {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 4px;
    }

    .list-item-arrow {
      color: #9ca3af;
      font-size: 1.2rem;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-right: 8px;
    }

    .badge-queued {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-running {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge-complete {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-error {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-cancelled {
      background: #e5e7eb;
      color: #4b5563;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: #374151;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }

    .btn {
      display: inline-block;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-primary:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .detail-item {
      background: #f9fafb;
      padding: 12px;
      border-radius: 6px;
    }

    .detail-item label {
      display: block;
      font-size: 0.8rem;
      color: #6b7280;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .detail-item value {
      display: block;
      font-weight: 500;
      color: #1f2937;
      word-break: break-all;
    }

    .prompt-box {
      background: #f9fafb;
      padding: 16px;
      border-radius: 6px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      word-break: break-word;
      border-left: 4px solid #2563eb;
    }

    .log-section {
      margin-top: 20px;
    }

    .log-entry {
      padding: 12px;
      border-left: 3px solid #e5e7eb;
      margin-bottom: 8px;
      background: #fafafa;
    }

    .log-entry.user-input {
      border-left-color: #2563eb;
    }

    .log-entry.task-started {
      border-left-color: #f59e0b;
    }

    .log-entry.task-completed {
      border-left-color: #10b981;
    }

    .log-entry.error {
      border-left-color: #ef4444;
      background: #fef2f2;
    }

    .log-time {
      font-size: 0.75rem;
      color: #6b7280;
      font-family: monospace;
    }

    .log-type {
      font-size: 0.8rem;
      font-weight: 600;
      color: #374151;
      margin: 4px 0;
    }

    .log-content {
      font-size: 0.9rem;
      color: #1f2937;
      white-space: pre-wrap;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .empty-state p {
      margin-bottom: 16px;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    .success-message {
      background: #d1fae5;
      color: #065f46;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    .refresh-btn {
      background: none;
      border: 1px solid #d1d5db;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      color: #6b7280;
    }

    .refresh-btn:hover {
      background: #f3f4f6;
    }

    .action-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    @media (max-width: 600px) {
      .container {
        padding: 12px;
      }

      header {
        padding: 12px 16px;
      }

      .header-content {
        flex-direction: column;
        gap: 12px;
      }

      header h1 {
        font-size: 1.1rem;
      }

      nav {
        width: 100%;
        justify-content: center;
      }

      .card {
        padding: 16px;
      }

      .page-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
      }

      .detail-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Chat UI Styles */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 200px);
      min-height: 400px;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #fff;
    }

    .chat-message {
      display: flex;
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .chat-message.user {
      justify-content: flex-end;
    }

    .chat-message.assistant {
      justify-content: flex-start;
    }

    .chat-message.system {
      justify-content: center;
    }

    .chat-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .chat-message.user .chat-bubble {
      background: #2563eb;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .chat-message.assistant .chat-bubble {
      background: #f3f4f6;
      color: #374151;
      border-bottom-left-radius: 4px;
    }

    .chat-message.system .chat-bubble {
      background: #fef3c7;
      color: #92400e;
      font-size: 0.9rem;
      padding: 8px 16px;
    }

    .chat-bubble-meta {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 4px;
    }

    .chat-message.user .chat-bubble-meta {
      text-align: right;
      color: rgba(255,255,255,0.7);
    }

    .chat-input-container {
      padding: 16px;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .chat-input-wrapper {
      display: flex;
      gap: 12px;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 1rem;
      resize: none;
      min-height: 44px;
      max-height: 150px;
    }

    .chat-input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .chat-input.respond-mode {
      border-color: #f59e0b;
      background: #fffbeb;
    }

    .chat-send-btn {
      padding: 12px 24px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .chat-send-btn:hover {
      background: #1d4ed8;
    }

    .chat-send-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .chat-send-btn.respond-mode {
      background: #f59e0b;
    }

    .chat-send-btn.respond-mode:hover {
      background: #d97706;
    }

    .chat-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      font-size: 0.85rem;
      color: #6b7280;
    }

    .chat-status.awaiting {
      background: #fef3c7;
      color: #92400e;
    }

    .chat-status .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #e5e7eb;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .project-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .project-type-badge.runner-dev {
      background: #fef3c7;
      color: #92400e;
    }

    .project-type-badge.normal {
      background: #d1fae5;
      color: #065f46;
    }

    .settings-panel {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .settings-panel h4 {
      margin-bottom: 12px;
      color: #374151;
    }


    /* Self-Hosting UI Styles */
    .selfhost-panel {
      background: #fefce8;
      border: 2px solid #fbbf24;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .selfhost-panel h4 {
      color: #92400e;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .selfhost-panel.ready {
      background: #f0fdf4;
      border-color: #22c55e;
    }

    .selfhost-panel.ready h4 {
      color: #065f46;
    }

    .selfhost-panel.blocked {
      background: #fef2f2;
      border-color: #ef4444;
    }

    .selfhost-panel.blocked h4 {
      color: #991b1b;
    }

    .selfhost-checks {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    .selfhost-check {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .selfhost-check .check-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .selfhost-check .check-icon.pass {
      background: #22c55e;
      color: white;
    }

    .selfhost-check .check-icon.fail {
      background: #ef4444;
      color: white;
    }

    .selfhost-apply-plan {
      background: #1f2937;
      color: #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      font-family: monospace;
      font-size: 0.85rem;
      overflow-x: auto;
      margin-bottom: 16px;
    }

    .selfhost-apply-plan ol {
      margin: 0;
      padding-left: 24px;
    }

    .selfhost-apply-plan li {
      margin-bottom: 4px;
    }

    .selfhost-block-reason {
      background: #fef2f2;
      color: #991b1b;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .selfhost-actions {
      display: flex;
      gap: 12px;
    }

    .btn-apply {
      background: #f59e0b;
      color: white;
    }

    .btn-apply:hover {
      background: #d97706;
    }

    .btn-apply:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    /* Resume Info Panel */
    .resume-panel {
      background: #f0f9ff;
      border: 2px solid #3b82f6;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .resume-panel h4 {
      color: #1e40af;
      margin-bottom: 12px;
    }

    .resume-panel.match {
      background: #f0fdf4;
      border-color: #22c55e;
    }

    .resume-panel.match h4 {
      color: #065f46;
    }

    .resume-panel.mismatch {
      background: #fef2f2;
      border-color: #ef4444;
    }

    .resume-panel.mismatch h4 {
      color: #991b1b;
    }

    .resume-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .resume-detail-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .resume-detail-item label {
      font-size: 0.8rem;
      color: #6b7280;
      font-weight: 500;
    }

    .resume-detail-item value {
      font-size: 0.9rem;
      color: #1f2937;
    }

    .resume-state-message {
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .resume-state-message.match {
      background: #dcfce7;
      color: #166534;
    }

    .resume-state-message.mismatch {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Dev Console Styles */
    .dev-console {
      margin-top: 16px;
    }

    .dev-console-layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      grid-template-rows: 1fr auto;
      gap: 16px;
      min-height: 500px;
    }

    .dev-file-tree {
      grid-row: 1 / 3;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: auto;
      max-height: 600px;
    }

    .dev-file-tree-header {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .dev-file-tree-header input {
      width: 100%;
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .dev-file-list {
      padding: 8px;
    }

    .dev-file-item {
      padding: 6px 8px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .dev-file-item:hover {
      background: #e5e7eb;
    }

    .dev-file-item.directory {
      font-weight: 500;
    }

    .dev-file-item.directory::before {
      content: "üìÅ";
    }

    .dev-file-item.file::before {
      content: "üìÑ";
    }

    .dev-file-item.parent::before {
      content: "‚¨ÜÔ∏è";
    }

    .dev-content-area {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .dev-file-view {
      background: #1f2937;
      color: #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      flex: 1;
      min-height: 200px;
    }

    .dev-file-view-header {
      padding: 8px 12px;
      background: #374151;
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dev-file-view-content {
      padding: 12px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.8rem;
      line-height: 1.5;
      overflow: auto;
      max-height: 300px;
      white-space: pre;
    }

    .dev-patch-section {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
    }

    .dev-patch-section h4 {
      margin: 0 0 8px 0;
      font-size: 0.9rem;
    }

    .dev-patch-textarea {
      width: 100%;
      height: 100px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.8rem;
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      resize: vertical;
    }

    .dev-cmd-section {
      grid-column: 1 / 3;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
    }

    .dev-cmd-input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .dev-cmd-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.85rem;
    }

    .dev-cmd-log {
      background: #1f2937;
      color: #e5e7eb;
      border-radius: 4px;
      padding: 12px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.8rem;
      line-height: 1.4;
      max-height: 200px;
      overflow: auto;
      white-space: pre-wrap;
    }

    .dev-cmd-log .stdout { color: #a3e635; }
    .dev-cmd-log .stderr { color: #f87171; }
    .dev-cmd-log .system { color: #60a5fa; }

    .dev-cmd-history {
      margin-top: 12px;
    }

    .dev-cmd-history-item {
      padding: 6px 8px;
      background: #f3f4f6;
      border-radius: 4px;
      margin-bottom: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      justify-content: space-between;
    }

    .dev-cmd-history-item:hover {
      background: #e5e7eb;
    }

    .dev-search-results {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      max-height: 200px;
      overflow: auto;
      margin-top: 8px;
    }

    .dev-search-result {
      padding: 6px 8px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .dev-search-result:hover {
      background: #f9fafb;
    }

    .dev-search-result .path {
      color: #2563eb;
      font-weight: 500;
    }

    .dev-search-result .line {
      color: #6b7280;
    }

    .dev-search-result .text {
      color: #1f2937;
      font-family: monospace;
      font-size: 0.75rem;
    }

    /* Git Operations */
    .dev-git-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }

    .dev-git-section h4 {
      margin: 0 0 12px 0;
      font-size: 0.9rem;
      color: #374151;
    }

    .dev-git-status {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      padding: 12px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.8rem;
      margin-bottom: 12px;
    }

    .dev-git-status .git-branch {
      color: #059669;
      font-weight: 600;
    }

    .dev-git-status .git-clean {
      color: #6b7280;
    }

    .dev-git-status .git-modified {
      color: #d97706;
    }

    .dev-git-status .git-staged {
      color: #059669;
    }

    .dev-git-status .git-untracked {
      color: #dc2626;
    }

    .dev-git-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .dev-git-diff {
      background: #1f2937;
      color: #e5e7eb;
      border-radius: 4px;
      padding: 12px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.75rem;
      line-height: 1.4;
      max-height: 300px;
      overflow: auto;
      white-space: pre-wrap;
      margin-bottom: 12px;
    }

    .dev-git-diff .diff-add {
      color: #a3e635;
    }

    .dev-git-diff .diff-del {
      color: #f87171;
    }

    .dev-git-diff .diff-header {
      color: #60a5fa;
    }

    .dev-git-commit-section {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .dev-git-gate-status {
      width: 100%;
      font-size: 0.8rem;
      margin-bottom: 4px;
    }

    .dev-git-gate-status.gate-pass {
      color: #059669;
    }

    .dev-git-gate-status.gate-fail {
      color: #dc2626;
    }

    #dev-git-commit-msg {
      flex: 1;
      min-width: 200px;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    #dev-git-commit-btn,
    #dev-git-push-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    #dev-git-commit-btn {
      background: #059669;
      color: white;
    }

    #dev-git-commit-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    #dev-git-push-btn {
      background: #2563eb;
      color: white;
    }

    #dev-git-push-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    /* Session Log Tree Styles */
    .session-log-tree {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .session-log-tree-header {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
      background: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 8px 8px 0 0;
    }

    .session-log-tree-header h4 {
      margin: 0;
      font-size: 0.9rem;
      color: #374151;
    }

    .session-log-tree-actions {
      display: flex;
      gap: 8px;
    }

    .session-log-tree-content {
      padding: 8px;
      max-height: 400px;
      overflow-y: auto;
    }

    .session-tree-node {
      padding: 4px 8px;
      margin: 2px 0;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .session-tree-node:hover {
      background: #e5e7eb;
    }

    .session-tree-node.expanded {
      background: #f3f4f6;
    }

    .session-tree-node.selected {
      background: #dbeafe;
      border: 1px solid #3b82f6;
    }

    .session-tree-node .node-icon {
      flex-shrink: 0;
      width: 16px;
      text-align: center;
    }

    .session-tree-node .node-label {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .session-tree-node .node-status {
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }

    .session-tree-node .node-status.active {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .session-tree-node .node-status.completed {
      background: #dcfce7;
      color: #166534;
    }

    .session-tree-node .node-status.failed {
      background: #fee2e2;
      color: #991b1b;
    }

    .session-tree-node .node-status.running {
      background: #fef3c7;
      color: #92400e;
    }

    .session-tree-children {
      margin-left: 16px;
      border-left: 1px solid #e5e7eb;
      padding-left: 8px;
    }

    .session-tree-node.type-date {
      font-weight: 600;
      color: #1f2937;
    }

    .session-tree-node.type-date .node-icon::before {
      content: "üìÖ";
    }

    .session-tree-node.type-session .node-icon::before {
      content: "üí¨";
    }

    .session-tree-node.type-run .node-icon::before {
      content: "‚ñ∂Ô∏è";
    }

    .session-tree-node.type-run.status-completed .node-icon::before {
      content: "‚úÖ";
    }

    .session-tree-node.type-run.status-failed .node-icon::before {
      content: "‚ùå";
    }

    .session-tree-node.type-run.status-running .node-icon::before {
      content: "üîÑ";
    }

    /* Session Log Detail Panel */
    .session-log-detail {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .session-log-detail-header {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .session-log-detail-header h4 {
      margin: 0;
      font-size: 0.9rem;
      color: #374151;
    }

    .session-log-detail-meta {
      padding: 12px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.8rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
    }

    .session-log-detail-meta .meta-item {
      display: flex;
      flex-direction: column;
    }

    .session-log-detail-meta .meta-label {
      color: #6b7280;
      font-size: 0.7rem;
      text-transform: uppercase;
    }

    .session-log-detail-meta .meta-value {
      color: #1f2937;
      font-weight: 500;
    }

    .session-log-detail-content {
      padding: 12px;
      background: #1f2937;
      color: #e5e7eb;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.8rem;
      line-height: 1.5;
      max-height: 300px;
      overflow: auto;
      white-space: pre-wrap;
      border-radius: 0 0 8px 8px;
    }

    .session-log-detail-content .log-stdout { color: #a3e635; }
    .session-log-detail-content .log-stderr { color: #f87171; }
    .session-log-detail-content .log-system { color: #60a5fa; }

    /* Runbook Preset Buttons */
    .runbook-presets {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .runbook-btn {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: #fff;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .runbook-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }

    .runbook-btn.running {
      background: #fef3c7;
      border-color: #f59e0b;
      cursor: not-allowed;
    }

    .runbook-btn.success {
      background: #dcfce7;
      border-color: #22c55e;
    }

    .runbook-btn.error {
      background: #fee2e2;
      border-color: #ef4444;
    }

    .runbook-btn .btn-icon {
      font-size: 1rem;
    }

    /* Web Dev Mode Toggle */
    .web-dev-mode-card {
      margin-bottom: 16px;
    }

    .web-dev-mode-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .web-dev-mode-header h3 {
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .web-dev-mode-status {
      font-size: 0.85rem;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 500;
    }

    .web-dev-mode-status.enabled {
      background: #dcfce7;
      color: #166534;
    }

    .web-dev-mode-status.disabled {
      background: #f3f4f6;
      color: #6b7280;
    }

    .web-dev-mode-toggle {
      position: relative;
      width: 48px;
      height: 24px;
      background: #e5e7eb;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .web-dev-mode-toggle.enabled {
      background: #22c55e;
    }

    .web-dev-mode-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .web-dev-mode-toggle.enabled::after {
      transform: translateX(24px);
    }

    .web-dev-mode-description {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #6b7280;
    }

    .web-dev-mode-warning {
      margin-top: 12px;
      padding: 12px;
      background: #fef3c7;
      border: 1px solid #fde047;
      border-radius: 8px;
      font-size: 0.85rem;
      color: #92400e;
    }

    .web-dev-mode-warning strong {
      display: block;
      margin-bottom: 4px;
    }

    /* Safety Confirmation Dialog */
    .safety-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .safety-dialog {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    .safety-dialog h4 {
      margin: 0 0 12px 0;
      color: #dc2626;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .safety-dialog p {
      margin: 0 0 16px 0;
      color: #4b5563;
      line-height: 1.5;
    }

    .safety-dialog-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .safety-dialog-actions .btn-danger {
      background: #dc2626;
      color: white;
      border: none;
    }

    .safety-dialog-actions .btn-danger:hover {
      background: #b91c1c;
    }
    /* Runner Controls Styles */
    .runner-controls {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .runner-controls-status {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 16px;
      background: #f3f4f6;
      border-radius: 8px;
    }

    .runner-controls-status .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .runner-controls-status .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .runner-controls-status .status-dot.running {
      background: #22c55e;
      box-shadow: 0 0 8px #22c55e;
    }

    .runner-controls-status .status-dot.stopped {
      background: #ef4444;
    }

    .runner-controls-status .status-dot.building {
      background: #f59e0b;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .runner-controls-status .status-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .runner-controls-status .status-label {
      font-size: 0.9rem;
      font-weight: 500;
      color: #374151;
    }

    .runner-controls-status .status-detail {
      font-size: 0.75rem;
      color: #6b7280;
      font-family: monospace;
    }

    .runner-controls-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .runner-controls-actions .btn {
      min-width: 100px;
    }

    .runner-controls-actions .btn-build {
      background: #3b82f6;
      color: white;
    }

    .runner-controls-actions .btn-build:hover {
      background: #2563eb;
    }

    .runner-controls-actions .btn-restart {
      background: #f59e0b;
      color: white;
    }

    .runner-controls-actions .btn-restart:hover {
      background: #d97706;
    }

    .runner-controls-actions .btn-stop {
      background: #ef4444;
      color: white;
    }

    .runner-controls-actions .btn-stop:hover {
      background: #dc2626;
    }

    .runner-controls-actions .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .runner-controls-result {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .runner-controls-result.success {
      background: #f0fdf4;
      border: 1px solid #22c55e;
      color: #166534;
    }

    .runner-controls-result.error {
      background: #fef2f2;
      border: 1px solid #ef4444;
      color: #991b1b;
    }

    .runner-controls-result pre {
      margin-top: 8px;
      padding: 8px;
      background: rgba(0,0,0,0.05);
      border-radius: 4px;
      font-size: 0.8rem;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1 onclick="navigate('/')">PM Orchestrator Runner</h1>
      <div class="namespace-selector" id="namespace-selector" style="display: none;">
        <select id="namespace-select" onchange="onNamespaceChange(this.value)">
          <!-- Populated by JavaScript -->
        </select>
        <div class="runner-status" id="runner-status">
          <span class="runner-dot" id="runner-dot"></span>
          <span id="runner-text">-</span>
        </div>
      </div>
      <nav id="main-nav">
        <a href="/dashboard" data-nav="dashboard">Dashboard</a>
        <a href="/" data-nav="home">Task Groups</a>
        <a href="/activity" data-nav="activity">Activity</a>
        <a href="/new" data-nav="new">+ New</a>
        <a href="/agent" data-nav="agent">Agent</a>
        <a href="/settings" data-nav="settings">Settings</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <div id="app">
      <div class="loading">Loading</div>
    </div>
  </main>

  <script>
    const app = document.getElementById('app');
    let currentPath = '/';

    // API helper with namespace support
    async function api(path, options = {}) {
      // Add namespace query parameter if currentNamespace is set
      let url = `/api${path}`;
      if (typeof currentNamespace !== 'undefined' && currentNamespace) {
        const separator = path.includes('?') ? '&' : '?';
        url = `${url}${separator}namespace=${encodeURIComponent(currentNamespace)}`;
      }
      const response = await fetch(url, {
        headers: { 'Content-Type': 'application/json' },
        ...options,
      });
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.message || 'Request failed');
      }
      return data;
    }

    // Format date
    function formatDate(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleString('ja-JP', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
      });
    }

    // Format full date
    function formatFullDate(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
      });
    }

    // Get status badge class
    function getStatusBadgeClass(status) {
      const map = {
        'QUEUED': 'badge-queued',
        'RUNNING': 'badge-running',
        'COMPLETE': 'badge-complete',
        'ERROR': 'badge-error',
        'CANCELLED': 'badge-cancelled',
      };
      return map[status] || 'badge-queued';
    }

    // Escape HTML
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Update nav active state
    function updateNav(path) {
      document.querySelectorAll('#main-nav a').forEach(link => {
        link.classList.remove('active');
        if (path === '/dashboard' && link.dataset.nav === 'dashboard') {
          link.classList.add('active');
        } else if (path === '/' && link.dataset.nav === 'home') {
          link.classList.add('active');
        } else if (path === '/activity' && link.dataset.nav === 'activity') {
          link.classList.add('active');
        } else if (path === '/new' && link.dataset.nav === 'new') {
          link.classList.add('active');
        } else if (path === '/agent' && link.dataset.nav === 'agent') {
          link.classList.add('active');
        } else if (path === '/settings' && link.dataset.nav === 'settings') {
          link.classList.add('active');
        } else if (path.startsWith('/projects/')) {
          link.classList.add('active');
        } else if (path.startsWith('/runs/')) {
          link.classList.add('active');
        }
      });
    }

    // Render task group list (Home)
    async function renderTaskGroupList() {
      app.innerHTML = '<div class="loading">Loading</div>';

      try {
        const data = await api('/task-groups');
        const groups = data.task_groups || [];

        if (groups.length === 0) {
          app.innerHTML = `
            <div class="page-header">
              <h2>Task Groups</h2>
              <button class="refresh-btn" onclick="renderTaskGroupList()">Refresh</button>
            </div>
            <div class="card">
              <div class="empty-state">
                <p>No task groups yet.</p>
                <button class="btn btn-primary" onclick="navigate('/new')">+ Create New Command</button>
              </div>
            </div>
          `;
          return;
        }

        const items = groups.map(g => `
          <div class="list-item" onclick="navigate('/task-groups/${encodeURIComponent(g.task_group_id)}')">
            <div class="list-item-main">
              <div class="list-item-title">${escapeHtml(g.task_group_id)}</div>
              <div class="list-item-meta">
                ${g.task_count} task(s) | Created: ${formatDate(g.created_at)}
              </div>
            </div>
            <span class="list-item-arrow">‚Ä∫</span>
          </div>
        `).join('');

        app.innerHTML = `
          <div class="page-header">
            <h2>Task Groups</h2>
            <button class="refresh-btn" onclick="renderTaskGroupList()">Refresh</button>
          </div>
          <div class="card">
            ${items}
          </div>
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="page-header">
            <h2>Task Groups</h2>
          </div>
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <button class="btn btn-secondary" onclick="renderTaskGroupList()">Retry</button>
          </div>
        `;
      }
    }

    // Render task list for a task group
    async function renderTaskList(taskGroupId) {
      app.innerHTML = '<div class="loading">Loading</div>';

      try {
        const data = await api(`/task-groups/${encodeURIComponent(taskGroupId)}/tasks`);
        const tasks = data.tasks || [];

        const backBtn = `<a href="/" class="back-btn" onclick="event.preventDefault(); navigate('/')">‚Üê Back to Groups</a>`;

        if (tasks.length === 0) {
          app.innerHTML = `
            <div class="page-header">
              <h2>${escapeHtml(taskGroupId)}</h2>
              <div class="action-bar">
                ${backBtn}
                <button class="refresh-btn" onclick="renderTaskList('${escapeHtml(taskGroupId)}')">Refresh</button>
              </div>
            </div>
            <div class="card">
              <div class="empty-state">
                <p>No tasks in this group yet.</p>
                <button class="btn btn-primary" onclick="navigate('/new?group=${encodeURIComponent(taskGroupId)}')">+ Add Task</button>
              </div>
            </div>
          `;
          return;
        }

        const items = tasks.map(t => `
          <div class="list-item" onclick="navigate('/tasks/${encodeURIComponent(t.task_id)}')">
            <div class="list-item-main">
              <span class="badge ${getStatusBadgeClass(t.status)}">${t.status}</span>
              <span class="list-item-title">${escapeHtml(t.task_id)}</span>
              <div class="list-item-meta">
                ${escapeHtml(t.prompt.substring(0, 80))}${t.prompt.length > 80 ? '...' : ''}
              </div>
              <div class="list-item-meta">
                ${formatDate(t.created_at)}
              </div>
            </div>
            <span class="list-item-arrow">‚Ä∫</span>
          </div>
        `).join('');

        app.innerHTML = `
          <div class="page-header">
            <h2>${escapeHtml(taskGroupId)}</h2>
            <div class="action-bar">
              ${backBtn}
              <button class="refresh-btn" onclick="renderTaskList('${escapeHtml(taskGroupId)}')">Refresh</button>
            </div>
          </div>
          <div class="card">
            <h3>Tasks (${tasks.length})</h3>
            ${items}
          </div>
          <div style="text-align: center; margin-top: 16px;">
            <button class="btn btn-primary" onclick="navigate('/new?group=${encodeURIComponent(taskGroupId)}')">+ Add Task to This Group</button>
          </div>
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="page-header">
            <h2>${escapeHtml(taskGroupId)}</h2>
            <a href="/" class="back-btn" onclick="event.preventDefault(); navigate('/')">‚Üê Back</a>
          </div>
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <button class="btn btn-secondary" onclick="renderTaskList('${escapeHtml(taskGroupId)}')">Retry</button>
          </div>
        `;
      }
    }

    // Render task detail with logs
    async function renderTaskDetail(taskId) {
      app.innerHTML = '<div class="loading">Loading</div>';

      try {
        const task = await api(`/tasks/${encodeURIComponent(taskId)}`);

        const backBtn = `<a href="/task-groups/${encodeURIComponent(task.task_group_id)}" class="back-btn" onclick="event.preventDefault(); navigate('/task-groups/${encodeURIComponent(task.task_group_id)}')">‚Üê Back to Tasks</a>`;

        let errorSection = '';
        if (task.error_message) {
          errorSection = `
            <div class="card">
              <h3>Error</h3>
              <div class="log-entry error">
                <div class="log-content">${escapeHtml(task.error_message)}</div>
              </div>
            </div>
          `;
        }

        // Log entries (simulated based on task status)
        let logEntries = '';
        if (task.status !== 'QUEUED') {
          logEntries = `
            <div class="card log-section">
              <h3>Execution Log</h3>
              <div class="log-entry user-input">
                <div class="log-time">${formatFullDate(task.created_at)}</div>
                <div class="log-type">USER INPUT</div>
                <div class="log-content">${escapeHtml(task.prompt)}</div>
              </div>
              ${task.status === 'RUNNING' ? `
              <div class="log-entry task-started">
                <div class="log-time">${formatFullDate(task.updated_at)}</div>
                <div class="log-type">TASK STARTED</div>
                <div class="log-content">Task is currently running...</div>
              </div>
              ` : ''}
              ${task.status === 'COMPLETE' ? `
              <div class="log-entry task-completed">
                <div class="log-time">${formatFullDate(task.updated_at)}</div>
                <div class="log-type">TASK COMPLETED</div>
                <div class="log-content">${task.output ? escapeHtml(task.output) : 'Task completed successfully.'}</div>
              </div>
              ` : ''}
              ${task.status === 'ERROR' ? `
              <div class="log-entry error">
                <div class="log-time">${formatFullDate(task.updated_at)}</div>
                <div class="log-type">TASK ERROR</div>
                <div class="log-content">${escapeHtml(task.error_message || 'Unknown error')}</div>
              </div>
              ` : ''}
              ${task.status === 'CANCELLED' ? `
              <div class="log-entry" style="border-left-color: #6b7280;">
                <div class="log-time">${formatFullDate(task.updated_at)}</div>
                <div class="log-type">TASK CANCELLED</div>
                <div class="log-content">Task was cancelled by user.</div>
              </div>
              ` : ''}
            </div>
          `;
        }

        app.innerHTML = `
          <div class="page-header">
            <h2>Task Detail</h2>
            <div class="action-bar">
              ${backBtn}
              <button class="refresh-btn" onclick="renderTaskDetail('${escapeHtml(taskId)}')">Refresh</button>
            </div>
          </div>

          <div class="card">
            <h3>Status</h3>
            <div style="display: flex; align-items: center; gap: 16px;">
              <span class="badge ${getStatusBadgeClass(task.status)}" style="font-size: 1rem; padding: 8px 16px;">${task.status}</span>
              ${(task.status === 'QUEUED' || task.status === 'RUNNING') ? `
                <button class="btn btn-secondary" onclick="cancelTask('${escapeHtml(task.task_id)}')" style="padding: 8px 16px;">Cancel Task</button>
              ` : ''}
            </div>
          </div>

          <div class="card">
            <h3>Details</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Task ID</label>
                <value>${escapeHtml(task.task_id)}</value>
              </div>
              <div class="detail-item">
                <label>Task Group</label>
                <value><a href="/task-groups/${encodeURIComponent(task.task_group_id)}" onclick="event.preventDefault(); navigate('/task-groups/${encodeURIComponent(task.task_group_id)}')">${escapeHtml(task.task_group_id)}</a></value>
              </div>
              <div class="detail-item">
                <label>Session ID</label>
                <value>${escapeHtml(task.session_id)}</value>
              </div>
              <div class="detail-item">
                <label>Created</label>
                <value>${formatFullDate(task.created_at)}</value>
              </div>
              <div class="detail-item">
                <label>Updated</label>
                <value>${formatFullDate(task.updated_at)}</value>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Prompt</h3>
            <div class="prompt-box">${escapeHtml(task.prompt)}</div>
          </div>

          ${task.output ? `
          <div class="card">
            <h3>Result</h3>
            <div class="prompt-box" style="background-color: #f0fdf4; border-color: #22c55e;">${escapeHtml(task.output)}</div>
          </div>
          ` : ''}

          ${task.status === 'AWAITING_RESPONSE' && task.clarification ? `
          <div class="card" style="border-left: 4px solid #f59e0b;">
            <h3>Clarification Needed</h3>
            <div class="prompt-box" style="background-color: #fffbeb; border-color: #f59e0b;">
              <strong>Question:</strong> ${escapeHtml(task.clarification.question || 'No question provided')}
              ${task.clarification.options ? `<br><br><strong>Options:</strong><ul>${task.clarification.options.map(o => `<li>${escapeHtml(o)}</li>`).join('')}</ul>` : ''}
              ${task.clarification.context ? `<br><strong>Context:</strong> ${escapeHtml(task.clarification.context)}` : ''}
            </div>
          </div>
          ` : ''}

          ${task.status === 'AWAITING_RESPONSE' || task.show_reply_ui ? `
          <div class="card" style="border-left: 4px solid #3b82f6;">
            <h3>Reply</h3>
            <form id="reply-form" data-task-id="${escapeHtml(task.task_id)}">
              <div class="form-group">
                <label for="replyBox">Your Reply (Enter to send, Shift+Enter for newline)</label>
                <textarea id="replyBox" name="reply" rows="4"
                  placeholder="Enter your reply here..."
                  style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; resize: vertical; min-height: 100px;"
                  required></textarea>
              </div>
              <div id="reply-message"></div>
              <button type="submit" id="reply-btn" class="btn btn-primary" style="margin-top: 10px;">
                Send Reply
              </button>
            </form>
          </div>
          ` : ''}

          ${errorSection}
          ${logEntries}
        `;

        // AC-CHAT-3, AC-INPUT-1: Setup reply form if present
        const replyForm = document.getElementById('reply-form');
        if (replyForm) {
          const replyBox = document.getElementById('replyBox');
          const replyBtn = document.getElementById('reply-btn');
          const replyMessage = document.getElementById('reply-message');

          // AC-INPUT-1: Enter to send, Shift+Enter for newline
          replyBox.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              replyForm.dispatchEvent(new Event('submit', { cancelable: true }));
            }
          });

          replyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const taskId = replyForm.dataset.taskId;
            const reply = replyBox.value.trim();

            if (!reply) {
              replyMessage.innerHTML = '<div class="error-message">Please enter a reply.</div>';
              return;
            }

            replyBtn.disabled = true;
            replyBtn.textContent = 'Sending...';

            try {
              const result = await api('/tasks/' + encodeURIComponent(taskId) + '/reply', {
                method: 'POST',
                body: JSON.stringify({ reply }),
              });

              replyMessage.innerHTML = '<div class="success-message">Reply sent! Task resumed.</div>';
              replyBox.value = '';

              // Refresh task detail after short delay
              setTimeout(() => {
                renderTaskDetail(taskId);
              }, 1000);
            } catch (error) {
              replyMessage.innerHTML = '<div class="error-message">Error: ' + escapeHtml(error.message) + '</div>';
            } finally {
              replyBtn.disabled = false;
              replyBtn.textContent = 'Send Reply';
            }
          });
        }
      } catch (error) {
        app.innerHTML = `
          <div class="page-header">
            <h2>Task Detail</h2>
            <a href="/" class="back-btn" onclick="event.preventDefault(); navigate('/')">‚Üê Back</a>
          </div>
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <button class="btn btn-secondary" onclick="renderTaskDetail('${escapeHtml(taskId)}')">Retry</button>
          </div>
        `;
      }
    }

    // Render new command form
    async function renderNewCommandForm(prefilledGroup = '') {
      let taskGroups = [];
      try {
        const data = await api('/task-groups');
        taskGroups = data.task_groups || [];
      } catch (error) {
        // Ignore - we can still create new task groups
      }

      const options = taskGroups.length > 0
        ? taskGroups.map(g => `<option value="${escapeHtml(g.task_group_id)}">${escapeHtml(g.task_group_id)}</option>`).join('')
        : '';

      const backBtn = `<a href="/" class="back-btn" onclick="event.preventDefault(); navigate('/')">‚Üê Back to Groups</a>`;

      app.innerHTML = `
        <div class="page-header">
          <h2>New Command</h2>
          ${backBtn}
        </div>

        <div class="card">
          <form id="new-command-form">
            <div class="form-group">
              <label for="task_group_id">Task Group ID</label>
              <input type="text" id="task_group_id" name="task_group_id"
                placeholder="Enter new or select existing"
                list="task-groups-list"
                value="${escapeHtml(prefilledGroup)}"
                required>
              <datalist id="task-groups-list">
                ${options}
              </datalist>
            </div>

            <div class="form-group">
              <label for="prompt">Command / Prompt</label>
              <textarea id="prompt" name="prompt"
                placeholder="Enter your command or prompt here..." required></textarea>
            </div>

            <div id="form-message"></div>

            <button type="submit" class="btn btn-primary" id="submit-btn">Submit to Queue</button>
          </form>
        </div>

        <div class="card" style="background: #fffbeb; border-left: 4px solid #f59e0b;">
          <p style="color: #92400e; font-size: 0.9rem;">
            <strong>Note:</strong> This adds a task to the queue. The Runner will pick it up and execute it automatically.
          </p>
        </div>
      `;

      // Form submission
      document.getElementById('new-command-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const submitBtn = document.getElementById('submit-btn');
        const messageDiv = document.getElementById('form-message');

        const taskGroupId = form.task_group_id.value.trim();
        const prompt = form.prompt.value.trim();

        if (!taskGroupId || !prompt) {
          messageDiv.innerHTML = '<div class="error-message">Please fill in all fields.</div>';
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        try {
          const result = await api('/tasks', {
            method: 'POST',
            body: JSON.stringify({ task_group_id: taskGroupId, prompt }),
          });

          messageDiv.innerHTML = `
            <div class="success-message">
              Task queued successfully!<br>
              Task ID: <strong>${escapeHtml(result.task_id)}</strong>
            </div>
          `;

          // Clear prompt only
          form.prompt.value = '';

          // Navigate to task detail after delay
          setTimeout(() => {
            navigate(`/tasks/${encodeURIComponent(result.task_id)}`);
          }, 1000);
        } catch (error) {
          messageDiv.innerHTML = `<div class="error-message">Error: ${escapeHtml(error.message)}</div>`;
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit to Queue';
        }
      });
    }

    // Cancel task
    async function cancelTask(taskId) {
      if (!confirm('Are you sure you want to cancel this task?')) {
        return;
      }

      try {
        const result = await fetch(`/api/tasks/${encodeURIComponent(taskId)}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'CANCELLED' }),
        });

        const data = await result.json();

        if (!result.ok) {
          alert(`Error: ${data.message || 'Failed to cancel task'}`);
          return;
        }

        // Refresh the task detail page
        renderTaskDetail(taskId);
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Settings state
    let settingsTab = 'global'; // 'global' or 'project'
    let settingsData = {
      apiKeys: { anthropic: null, openai: null },
      globalSettings: { llm: {}, preferences: {}, maxTokens: 4096, temperature: 0.7 },
      projectOverrides: {},
      namespace: ''
    };

    // Render Settings page - dispatcher based on current tab
    async function renderSettings() {
      app.innerHTML = '<div class="loading">Loading Settings...</div>';

      try {
        // Fetch all settings data in parallel
        const [apiKeyRes, projectRes, namespaceRes] = await Promise.all([
          fetch('/api/settings/api-key/status'),
          fetch('/api/settings/project'),
          fetch('/api/namespace')
        ]);

        settingsData.apiKeys = await apiKeyRes.json();
        const projectData = await projectRes.json();
        const namespaceData = await namespaceRes.json();
        settingsData.namespace = namespaceData.namespace;
        settingsData.globalSettings = {
          llm: projectData.llm || { provider: 'anthropic', model: 'claude-sonnet-4-20250514' },
          preferences: projectData.preferences || {},
          maxTokens: 4096,
          temperature: 0.7
        };
        // Project overrides: fields explicitly set for this project
        settingsData.projectOverrides = projectData.overrides || {};

        // Render based on current tab
        if (settingsTab === 'global') {
          renderSettingsGlobal();
        } else {
          renderSettingsProject();
        }
      } catch (error) {
        app.innerHTML = `
          <div class="card">
            <h2>Error Loading Settings</h2>
            <p>${escapeHtml(error.message)}</p>
            <button class="btn btn-primary" onclick="renderSettings()" style="margin-top: 16px;">Retry</button>
          </div>
        `;
      }
    }

    // Render GLOBAL settings tab
    function renderSettingsGlobal() {
      const { apiKeys, globalSettings, namespace } = settingsData;

      const renderProviderStatus = (provider, status) => {
        const configured = status?.configured === true;
        const masked = status?.masked || '';
        const statusClass = configured ? 'status-configured' : 'status-not-configured';
        const statusText = configured ? 'Configured' : 'Not Configured';
        const providerId = provider.toLowerCase();

        return `
          <div class="settings-provider" data-testid="settings-provider-${providerId}">
            <div class="provider-header">
              <span class="provider-name">${escapeHtml(provider)}</span>
              <span class="provider-status ${statusClass}">${statusText}</span>
            </div>
            ${configured ? `<div class="provider-masked">Key: ${escapeHtml(masked)}</div>` : ''}
            <div class="provider-actions">
              <input type="password" id="apikey-${providerId}" placeholder="Enter API Key" class="settings-input" />
              <button class="btn btn-sm" onclick="saveApiKey('${providerId}')">Save ${provider} Key</button>
              ${configured ? `<button class="btn btn-sm btn-danger" onclick="deleteApiKey('${providerId}')">Delete</button>` : ''}
            </div>
          </div>
        `;
      };

      app.innerHTML = `
        <div data-testid="settings-root" data-scope="global" class="settings-page">
          <div class="page-header">
            <h2>Settings</h2>
            <span class="project-indicator">Project: ${escapeHtml(namespace)}</span>
            <button class="refresh-btn" onclick="renderSettings()">Refresh</button>
          </div>

          <!-- Tabs -->
          <div data-testid="settings-tabs" class="settings-tabs">
            <button data-testid="settings-tab-global" class="tab-btn ${settingsTab === 'global' ? 'active' : ''}" onclick="switchSettingsTab('global')">Global</button>
            <button data-testid="settings-tab-project" class="tab-btn ${settingsTab === 'project' ? 'active' : ''}" onclick="switchSettingsTab('project')">Project</button>
          </div>

          <!-- Global: Environment Info -->
          <div data-testid="settings-envinfo" class="card settings-section">
            <h3>Environment Info</h3>
            <div class="env-info-grid">
              <div class="env-item">
                <label>Namespace:</label>
                <span>${escapeHtml(namespace)}</span>
              </div>
              <div class="env-item">
                <label>Scope:</label>
                <span>Global (applies to all projects)</span>
              </div>
            </div>
          </div>


          <!-- Runner Controls (AC-RC-UI-1) -->
          <div data-testid="settings-runner-controls" class="card settings-section">
            <h3>Runner Controls</h3>
            <p class="settings-hint">Manage the pm-orchestrator-runner process. Build, restart, or stop the runner.</p>
            <div class="runner-controls">
              <div class="runner-controls-status" id="runner-controls-status">
                <div class="status-indicator">
                  <span class="status-dot stopped" id="runner-status-dot"></span>
                  <div class="status-info">
                    <span class="status-label" id="runner-status-label">Checking...</span>
                    <span class="status-detail" id="runner-status-detail"></span>
                  </div>
                </div>
              </div>
              <div class="runner-controls-actions">
                <button class="btn btn-build" id="btn-runner-build" onclick="runnerBuild()" disabled>Build</button>
                <button class="btn btn-restart" id="btn-runner-restart" onclick="runnerRestart()" disabled>Restart</button>
                <button class="btn btn-stop" id="btn-runner-stop" onclick="runnerStop()" disabled>Stop</button>
              </div>
              <div id="runner-controls-result" class="runner-controls-result" style="display: none;"></div>
            </div>
          </div>

          <!-- Global: API Keys (ONLY in Global tab) -->
          <div data-testid="settings-apikeys" class="card settings-section">
            <h3>API Keys</h3>
            <p class="settings-hint">API keys are stored globally and shared across all projects.</p>
            <div class="settings-list">
              ${renderProviderStatus('Anthropic', apiKeys.anthropic)}
              ${renderProviderStatus('OpenAI', apiKeys.openai)}
            </div>
          </div>

          <!-- Global: LLM Configuration -->
          <div class="card settings-section">
            <h3>Default LLM Configuration</h3>
            <p class="settings-hint">These are the default values used when no project override is set.</p>
            <div class="settings-form">
              <div class="form-group">
                <label for="settings-provider" data-testid="settings-provider-label">Provider</label>
                <select id="settings-provider" data-testid="settings-provider" class="settings-select">
                  <option value="anthropic" ${globalSettings.llm?.provider === 'anthropic' ? 'selected' : ''}>Anthropic</option>
                  <option value="openai" ${globalSettings.llm?.provider === 'openai' ? 'selected' : ''}>OpenAI</option>
                </select>
              </div>
              <div class="form-group">
                <label for="settings-model" data-testid="settings-model-label">Model</label>
                <select id="settings-model" data-testid="settings-model" class="settings-select">
                  <option value="claude-sonnet-4-20250514" ${globalSettings.llm?.model === 'claude-sonnet-4-20250514' ? 'selected' : ''}>Claude Sonnet 4</option>
                  <option value="claude-3-5-sonnet-20241022" ${globalSettings.llm?.model === 'claude-3-5-sonnet-20241022' ? 'selected' : ''}>Claude 3.5 Sonnet</option>
                  <option value="gpt-4o" ${globalSettings.llm?.model === 'gpt-4o' ? 'selected' : ''}>GPT-4o</option>
                  <option value="gpt-4-turbo" ${globalSettings.llm?.model === 'gpt-4-turbo' ? 'selected' : ''}>GPT-4 Turbo</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Global: Generation Parameters -->
          <div class="card settings-section">
            <h3>Default Generation Parameters</h3>
            <div class="settings-form">
              <div class="form-group">
                <label for="settings-max-tokens" data-testid="settings-max-tokens-label">Max Tokens</label>
                <input type="number" id="settings-max-tokens" data-testid="settings-max-tokens" class="settings-input" value="${globalSettings.maxTokens}" min="1" max="128000" />
              </div>
              <div class="form-group">
                <label for="settings-temperature" data-testid="settings-temperature-label">Temperature</label>
                <input type="number" id="settings-temperature" data-testid="settings-temperature" class="settings-input" value="${globalSettings.temperature}" min="0" max="2" step="0.1" />
              </div>
            </div>
          </div>

          <!-- Global: Save Buttons -->
          <div class="settings-actions">
            <button class="btn btn-primary" onclick="saveGlobalSettings()">Save Global Settings</button>
            <button class="btn btn-secondary" onclick="resetSettings()">Reset to Defaults</button>
          </div>
        </div>
        ${getSettingsStyles()}
      `;
      
      // Load Runner Controls status after rendering
      loadRunnerControlsStatus();
    }

    // Render PROJECT settings tab (overrides)
    function renderSettingsProject() {
      const { globalSettings, projectOverrides, namespace } = settingsData;

      // Helper to render override status badge
      const overrideBadge = (fieldName) => {
        const isOverridden = projectOverrides && projectOverrides[fieldName] !== undefined;
        if (isOverridden) {
          return '<span class="override-badge overridden">Overridden</span>';
        }
        return '<span class="override-badge inherited">Inherited (Global)</span>';
      };

      // Get effective value (override or global default)
      const getEffectiveValue = (fieldName, globalValue) => {
        if (projectOverrides && projectOverrides[fieldName] !== undefined) {
          return projectOverrides[fieldName];
        }
        return globalValue;
      };

      app.innerHTML = `
        <div data-testid="settings-root" data-scope="project" class="settings-page">
          <div class="page-header">
            <h2>Settings</h2>
            <span class="project-indicator">Project: ${escapeHtml(namespace)}</span>
            <button class="refresh-btn" onclick="renderSettings()">Refresh</button>
          </div>

          <!-- Tabs -->
          <div data-testid="settings-tabs" class="settings-tabs">
            <button data-testid="settings-tab-global" class="tab-btn ${settingsTab === 'global' ? 'active' : ''}" onclick="switchSettingsTab('global')">Global</button>
            <button data-testid="settings-tab-project" class="tab-btn ${settingsTab === 'project' ? 'active' : ''}" onclick="switchSettingsTab('project')">Project</button>
          </div>

          <!-- Project: Header with namespace -->
          <div data-testid="settings-project-overrides" class="card settings-section project-overrides-card">
            <h3>Project Overrides</h3>
            <p class="settings-hint">Override global settings for this project only. Unchecked fields inherit from Global settings.</p>
            <div class="project-namespace-info">
              <strong>Namespace:</strong> <code>${escapeHtml(namespace)}</code>
            </div>
          </div>

          <!-- Project: API Keys info (read-only, no edit) -->
          <div class="card settings-section api-keys-info">
            <h3>API Keys</h3>
            <p class="settings-hint-readonly">API keys are managed in the Global tab. Projects use the globally configured keys.</p>
            <div class="global-keys-indicator">Global keys are used for this project</div>
          </div>

          <!-- Project: LLM Override -->
          <div class="card settings-section">
            <h3>LLM Configuration Override</h3>
            <div class="settings-form">
              <div class="form-group override-group">
                <div class="override-header">
                  <input type="checkbox" id="override-provider" ${projectOverrides?.provider !== undefined ? 'checked' : ''} onchange="toggleOverride('provider')" />
                  <label for="override-provider">Override Provider</label>
                  ${overrideBadge('provider')}
                </div>
                <select id="project-provider" class="settings-select ${projectOverrides?.provider === undefined ? 'inherited' : ''}" ${projectOverrides?.provider === undefined ? 'disabled' : ''}>
                  <option value="anthropic" ${getEffectiveValue('provider', globalSettings.llm?.provider) === 'anthropic' ? 'selected' : ''}>Anthropic</option>
                  <option value="openai" ${getEffectiveValue('provider', globalSettings.llm?.provider) === 'openai' ? 'selected' : ''}>OpenAI</option>
                </select>
              </div>
              <div class="form-group override-group">
                <div class="override-header">
                  <input type="checkbox" id="override-model" ${projectOverrides?.model !== undefined ? 'checked' : ''} onchange="toggleOverride('model')" />
                  <label for="override-model">Override Model</label>
                  ${overrideBadge('model')}
                </div>
                <select id="project-model" class="settings-select ${projectOverrides?.model === undefined ? 'inherited' : ''}" ${projectOverrides?.model === undefined ? 'disabled' : ''}>
                  <option value="claude-sonnet-4-20250514" ${getEffectiveValue('model', globalSettings.llm?.model) === 'claude-sonnet-4-20250514' ? 'selected' : ''}>Claude Sonnet 4</option>
                  <option value="claude-3-5-sonnet-20241022" ${getEffectiveValue('model', globalSettings.llm?.model) === 'claude-3-5-sonnet-20241022' ? 'selected' : ''}>Claude 3.5 Sonnet</option>
                  <option value="gpt-4o" ${getEffectiveValue('model', globalSettings.llm?.model) === 'gpt-4o' ? 'selected' : ''}>GPT-4o</option>
                  <option value="gpt-4-turbo" ${getEffectiveValue('model', globalSettings.llm?.model) === 'gpt-4-turbo' ? 'selected' : ''}>GPT-4 Turbo</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Project: Generation Parameters Override -->
          <div class="card settings-section">
            <h3>Generation Parameters Override</h3>
            <div class="settings-form">
              <div class="form-group override-group">
                <div class="override-header">
                  <input type="checkbox" id="override-maxTokens" ${projectOverrides?.maxTokens !== undefined ? 'checked' : ''} onchange="toggleOverride('maxTokens')" />
                  <label for="override-maxTokens">Override Max Tokens</label>
                  ${overrideBadge('maxTokens')}
                </div>
                <input type="number" id="project-maxTokens" class="settings-input ${projectOverrides?.maxTokens === undefined ? 'inherited' : ''}" value="${getEffectiveValue('maxTokens', globalSettings.maxTokens)}" min="1" max="128000" ${projectOverrides?.maxTokens === undefined ? 'disabled' : ''} />
              </div>
              <div class="form-group override-group">
                <div class="override-header">
                  <input type="checkbox" id="override-temperature" ${projectOverrides?.temperature !== undefined ? 'checked' : ''} onchange="toggleOverride('temperature')" />
                  <label for="override-temperature">Override Temperature</label>
                  ${overrideBadge('temperature')}
                </div>
                <input type="number" id="project-temperature" class="settings-input ${projectOverrides?.temperature === undefined ? 'inherited' : ''}" value="${getEffectiveValue('temperature', globalSettings.temperature)}" min="0" max="2" step="0.1" ${projectOverrides?.temperature === undefined ? 'disabled' : ''} />
              </div>
            </div>
          </div>

          <!-- Project: Save Buttons -->
          <div class="settings-actions">
            <button class="btn btn-primary" onclick="saveProjectSettings()">Save Project Overrides</button>
            <button class="btn btn-secondary" onclick="clearProjectOverrides()">Clear All Overrides</button>
          </div>
        </div>
        ${getSettingsStyles()}
      `;
    }

    // Settings styles (shared)
    function getSettingsStyles() {
      return `
        <style>
          .settings-page { max-width: 800px; }
          .project-indicator { font-size: 0.9rem; color: #6b7280; margin-left: 16px; }
          .settings-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
          .tab-btn { padding: 8px 16px; border: 1px solid #e5e7eb; background: #fff; border-radius: 6px; cursor: pointer; font-weight: 500; }
          .tab-btn.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }
          .settings-section { margin-bottom: 16px; }
          .settings-hint { font-size: 0.85rem; color: #6b7280; margin-bottom: 12px; }
          .settings-hint-readonly { font-size: 0.85rem; color: #9ca3af; font-style: italic; margin-bottom: 12px; }
          .env-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
          .env-item { display: flex; flex-direction: column; gap: 4px; }
          .env-item label { font-size: 0.85rem; color: #6b7280; font-weight: 500; }
          .env-item span { font-family: monospace; font-size: 0.9rem; word-break: break-all; }
          .settings-form { display: flex; flex-direction: column; gap: 16px; }
          .form-group { display: flex; flex-direction: column; gap: 6px; }
          .form-group label { font-size: 0.9rem; font-weight: 500; }
          .settings-input, .settings-select { padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.95rem; }
          .settings-select { background: #fff; }
          .settings-input.inherited, .settings-select.inherited { background: #f3f4f6; color: #9ca3af; }
          .checkbox-group { flex-direction: row; align-items: center; gap: 8px; }
          .checkbox-group input { width: 18px; height: 18px; }
          .settings-list { display: flex; flex-direction: column; gap: 16px; margin-top: 16px; }
          .settings-provider { padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; }
          .provider-header { display: flex; justify-content: space-between; align-items: center; }
          .provider-name { font-weight: 600; font-size: 1rem; }
          .provider-status { padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 500; }
          .status-configured { background: #dcfce7; color: #166534; }
          .status-not-configured { background: #fee2e2; color: #991b1b; }
          .provider-masked { margin-top: 8px; font-family: monospace; font-size: 0.85rem; color: #6b7280; }
          .provider-actions { display: flex; gap: 8px; margin-top: 12px; align-items: center; flex-wrap: wrap; }
          .provider-actions input { flex: 1; min-width: 200px; }
          .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
          .btn-danger { background: #ef4444; color: #fff; }
          .btn-danger:hover { background: #dc2626; }
          .settings-actions { display: flex; gap: 12px; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e5e7eb; }
          /* Project overrides specific */
          .project-overrides-card { background: #fffbeb; border-left: 4px solid #f59e0b; }
          .project-namespace-info { margin-top: 12px; padding: 8px 12px; background: #fef3c7; border-radius: 6px; font-size: 0.9rem; }
          .project-namespace-info code { background: #fde68a; padding: 2px 6px; border-radius: 4px; }
          .api-keys-info { background: #f3f4f6; }
          .global-keys-indicator { padding: 12px; background: #e5e7eb; border-radius: 6px; color: #6b7280; font-size: 0.9rem; text-align: center; }
          .override-group { padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; }
          .override-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
          .override-header input[type="checkbox"] { width: 18px; height: 18px; }
          .override-badge { padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 500; margin-left: auto; }
          .override-badge.inherited { background: #e5e7eb; color: #6b7280; }
          .override-badge.overridden { background: #dbeafe; color: #1e40af; }
        </style>
      `;
    }

    // Toggle override checkbox
    function toggleOverride(fieldName) {
      const checkbox = document.getElementById(`override-${fieldName}`);
      const input = document.getElementById(`project-${fieldName}`);
      if (!checkbox || !input) return;

      if (checkbox.checked) {
        input.disabled = false;
        input.classList.remove('inherited');
      } else {
        input.disabled = true;
        input.classList.add('inherited');
      }
    }

    // Switch settings tab
    function switchSettingsTab(tab) {
      settingsTab = tab;
      // Re-render with already loaded data
      if (tab === 'global') {
        renderSettingsGlobal();
      } else {
        renderSettingsProject();
      }
    }

    // Save API key
    async function saveApiKey(provider) {
      const input = document.getElementById(`apikey-${provider}`);
      const apiKey = input?.value?.trim();
      if (!apiKey) {
        alert('Please enter an API key');
        return;
      }

      try {
        const response = await fetch('/api/settings/api-key', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider, api_key: apiKey })
        });
        const data = await response.json();
        if (data.success) {
          renderSettings();
        } else {
          alert(data.message || 'Failed to save API key');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Delete API key
    async function deleteApiKey(provider) {
      if (!confirm(`Delete ${provider} API key?`)) return;

      try {
        const response = await fetch('/api/settings/api-key', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider })
        });
        const data = await response.json();
        if (data.success) {
          renderSettings();
        } else {
          alert(data.message || 'Failed to delete API key');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Save Global settings (no projectId)
    async function saveGlobalSettings() {
      const provider = document.getElementById('settings-provider')?.value;
      const model = document.getElementById('settings-model')?.value;
      const maxTokens = parseInt(document.getElementById('settings-max-tokens')?.value) || 4096;
      const temperature = parseFloat(document.getElementById('settings-temperature')?.value) || 0.7;

      try {
        // PUT /api/settings (no projectId = global)
        const response = await fetch('/api/settings/project', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            llm: { provider, model },
            preferences: { autoChunking: true, costWarningEnabled: true, costWarningThreshold: 0.5 }
          })
        });
        const data = await response.json();
        if (data.success) {
          alert('Global settings saved successfully');
          renderSettings();
        } else {
          alert(data.message || 'Failed to save settings');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Save Project overrides (with projectId)
    async function saveProjectSettings() {
      // Collect only overridden values
      const overrides = {};

      if (document.getElementById('override-provider')?.checked) {
        overrides.provider = document.getElementById('project-provider')?.value;
      }
      if (document.getElementById('override-model')?.checked) {
        overrides.model = document.getElementById('project-model')?.value;
      }
      if (document.getElementById('override-maxTokens')?.checked) {
        overrides.maxTokens = parseInt(document.getElementById('project-maxTokens')?.value);
      }
      if (document.getElementById('override-temperature')?.checked) {
        overrides.temperature = parseFloat(document.getElementById('project-temperature')?.value);
      }

      try {
        // PUT /api/settings/project?projectId=... (with projectId = project override)
        const namespace = settingsData.namespace;
        const response = await fetch(`/api/settings/project?projectId=${encodeURIComponent(namespace)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            overrides: overrides
          })
        });
        const data = await response.json();
        if (data.success) {
          alert('Project overrides saved successfully');
          renderSettings();
        } else {
          alert(data.message || 'Failed to save project overrides');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Clear all project overrides
    async function clearProjectOverrides() {
      if (!confirm('Clear all project overrides? This project will inherit all settings from Global.')) return;

      try {
        const namespace = settingsData.namespace;
        const response = await fetch(`/api/settings/project?projectId=${encodeURIComponent(namespace)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ overrides: {} })
        });
        const data = await response.json();
        if (data.success) {
          settingsData.projectOverrides = {};
          renderSettings();
        } else {
          alert(data.message || 'Failed to clear overrides');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Reset settings to defaults
    async function resetSettings() {
      if (!confirm('Reset all settings to defaults?')) return;

      try {
        await fetch('/api/settings/project', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            llm: { provider: 'anthropic', model: 'claude-sonnet-4-20250514' },
            preferences: { autoChunking: true, costWarningEnabled: true, costWarningThreshold: 0.5 }
          })
        });
        renderSettings();
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // ===================
    // Runner Controls (AC-RC-UI-1, AC-RC-API-1)
    // ===================
    let runnerControlsState = {
      isRunning: false,
      pid: null,
      build_sha: null,
      build_timestamp: null,
      isOperationInProgress: false
    };

    // Load runner status from API
    async function loadRunnerControlsStatus() {
      try {
        const response = await fetch('/api/runner/status');
        if (!response.ok) throw new Error('Failed to fetch runner status');
        const data = await response.json();
        
        runnerControlsState.isRunning = data.isRunning;
        runnerControlsState.pid = data.pid;
        runnerControlsState.build_sha = data.build_sha;
        runnerControlsState.build_timestamp = data.build_timestamp;
        
        updateRunnerControlsUI();
      } catch (error) {
        console.warn('Failed to load runner status:', error);
        // Still update UI to show error state
        runnerControlsState.isRunning = false;
        updateRunnerControlsUI();
      }
    }

    // Update Runner Controls UI based on state
    function updateRunnerControlsUI() {
      const dot = document.getElementById('runner-status-dot');
      const label = document.getElementById('runner-status-label');
      const detail = document.getElementById('runner-status-detail');
      const btnBuild = document.getElementById('btn-runner-build');
      const btnRestart = document.getElementById('btn-runner-restart');
      const btnStop = document.getElementById('btn-runner-stop');
      
      if (!dot || !label) return; // Not on settings page
      
      const { isRunning, pid, build_sha, build_timestamp, isOperationInProgress } = runnerControlsState;
      
      // Update status indicator
      if (isOperationInProgress) {
        dot.className = 'status-dot building';
        label.textContent = 'Operation in progress...';
        detail.textContent = '';
      } else if (isRunning) {
        dot.className = 'status-dot running';
        label.textContent = 'Running';
        let detailText = pid ? 'PID: ' + pid : '';
        if (build_sha) {
          detailText += (detailText ? ' | ' : '') + 'Build: ' + build_sha;
        }
        if (build_timestamp) {
          const ts = new Date(build_timestamp).toLocaleString();
          detailText += (detailText ? ' | ' : '') + 'Built: ' + ts;
        }
        detail.textContent = detailText;
      } else {
        dot.className = 'status-dot stopped';
        label.textContent = 'Stopped';
        detail.textContent = 'Runner is not running';
      }
      
      // Update button states
      if (btnBuild) btnBuild.disabled = isOperationInProgress;
      if (btnRestart) btnRestart.disabled = isOperationInProgress || !isRunning;
      if (btnStop) btnStop.disabled = isOperationInProgress || !isRunning;
    }

    // Show operation result
    function showRunnerResult(success, message, output) {
      const resultDiv = document.getElementById('runner-controls-result');
      if (!resultDiv) return;
      
      resultDiv.style.display = 'block';
      resultDiv.className = 'runner-controls-result ' + (success ? 'success' : 'error');
      
      let html = '<strong>' + (success ? 'Success' : 'Error') + ':</strong> ' + escapeHtml(message);
      if (output) {
        html += '<pre>' + escapeHtml(output) + '</pre>';
      }
      resultDiv.innerHTML = html;
      
      // Auto-hide success messages after 5 seconds
      if (success) {
        setTimeout(() => {
          if (resultDiv) resultDiv.style.display = 'none';
        }, 5000);
      }
    }

    // Build action
    async function runnerBuild() {
      if (runnerControlsState.isOperationInProgress) return;
      
      runnerControlsState.isOperationInProgress = true;
      updateRunnerControlsUI();
      
      try {
        const response = await fetch('/api/runner/build', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
          showRunnerResult(true, 'Build completed successfully', 'Build SHA: ' + (data.build_sha || 'N/A') + '\nDuration: ' + (data.duration_ms || 0) + 'ms');
          runnerControlsState.build_sha = data.build_sha;
          runnerControlsState.build_timestamp = data.build_timestamp;
        } else {
          showRunnerResult(false, data.message || 'Build failed', data.output || data.error);
        }
      } catch (error) {
        showRunnerResult(false, 'Build request failed', error.message);
      } finally {
        runnerControlsState.isOperationInProgress = false;
        await loadRunnerControlsStatus();
      }
    }

    // Restart action
    async function runnerRestart() {
      if (runnerControlsState.isOperationInProgress) return;
      if (!confirm('Restart the runner? This will briefly interrupt task processing.')) return;
      
      runnerControlsState.isOperationInProgress = true;
      updateRunnerControlsUI();
      
      try {
        const response = await fetch('/api/runner/restart', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
          const info = 'Old PID: ' + (data.old_pid || 'N/A') + '\nNew PID: ' + (data.new_pid || 'N/A') + '\nBuild SHA: ' + (data.build_sha || 'N/A');
          showRunnerResult(true, 'Restart completed successfully', info);
        } else {
          showRunnerResult(false, data.message || 'Restart failed', data.output || data.error);
        }
      } catch (error) {
        showRunnerResult(false, 'Restart request failed', error.message);
      } finally {
        runnerControlsState.isOperationInProgress = false;
        await loadRunnerControlsStatus();
      }
    }

    // Stop action
    async function runnerStop() {
      if (runnerControlsState.isOperationInProgress) return;
      if (!confirm('Stop the runner? Task processing will stop until manually restarted.')) return;
      
      runnerControlsState.isOperationInProgress = true;
      updateRunnerControlsUI();
      
      try {
        const response = await fetch('/api/runner/stop', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
          showRunnerResult(true, data.message || 'Runner stopped', 
            'Duration: ' + (data.duration_ms || 0) + 'ms');
        } else {
          showRunnerResult(false, data.message || 'Stop failed', data.error);
        }
      } catch (error) {
        showRunnerResult(false, 'Stop request failed', error.message);
      } finally {
        runnerControlsState.isOperationInProgress = false;
        await loadRunnerControlsStatus();
      }
    }


    // ===================
    // Agent Launcher
    // ===================
    let agentData = null;

    async function renderAgentLauncher() {
      app.innerHTML = `
        <div class="page-header">
          <h2>Agent Launcher</h2>
        </div>
        <div class="card" data-testid="agent-launcher-root">
          <h3>Select Project Folder</h3>
          <p class="hint" style="color: #6b7280; margin-bottom: 12px;">
            Enter the path to a project folder to inspect its agent configuration.
          </p>
          <div style="display: flex; gap: 8px; margin-bottom: 16px;">
            <input type="text" id="folder-input" data-testid="folder-input"
              placeholder="/path/to/project"
              style="flex: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; font-size: 0.9rem;">
            <button class="btn btn-primary" onclick="inspectFolder()">Inspect</button>
          </div>
          <div id="agent-result" data-testid="agent-result"></div>
        </div>
        <style>
          .agent-info-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-top: 16px; }
          .agent-info-row { display: flex; margin-bottom: 8px; }
          .agent-info-label { width: 140px; font-weight: 600; color: #374151; }
          .agent-info-value { flex: 1; font-family: monospace; color: #1f2937; word-break: break-all; }
          .agent-list { margin-top: 16px; }
          .agent-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px; }
          .agent-item .agent-name { font-weight: 500; color: #1f2937; }
          .agent-item .agent-path { font-size: 0.85rem; color: #6b7280; font-family: monospace; }
          .no-agents { padding: 16px; background: #fef3c7; border-radius: 6px; color: #92400e; }
          .agent-status { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 500; }
          .agent-status.found { background: #d1fae5; color: #065f46; }
          .agent-status.not-found { background: #fef3c7; color: #92400e; }
        </style>
      `;
    }

    async function inspectFolder() {
      const folderInput = document.getElementById('folder-input');
      const resultDiv = document.getElementById('agent-result');
      const folder = folderInput?.value?.trim();

      if (!folder) {
        resultDiv.innerHTML = '<p style="color: #dc2626;">Please enter a folder path.</p>';
        return;
      }

      resultDiv.innerHTML = '<p>Inspecting folder...</p>';

      try {
        const response = await fetch(`/api/agents?folder=${encodeURIComponent(folder)}`);
        const data = await response.json();

        if (!response.ok) {
          resultDiv.innerHTML = `<p style="color: #dc2626;">Error: ${data.message || 'Failed to inspect folder'}</p>`;
          return;
        }

        // Store for later use
        agentData = data;

        // Save to JSON file for evidence (via console)
        console.log('[AGENT-INSPECT]', JSON.stringify(data, null, 2));

        const agentsHtml = data.agents.length > 0
          ? data.agents.map(a => `
              <div class="agent-item">
                <span class="agent-name">${a.name}</span>
                <span class="agent-path">${a.path}</span>
              </div>
            `).join('')
          : '<div class="no-agents">No agents found in .claude/agents/ directory</div>';

        resultDiv.innerHTML = `
          <div class="agent-info-card" data-testid="agent-info-card">
            <div class="agent-info-row">
              <span class="agent-info-label">Selected Folder:</span>
              <span class="agent-info-value" data-testid="selected-folder">${data.folder}</span>
            </div>
            <div class="agent-info-row">
              <span class="agent-info-label">Effective CWD:</span>
              <span class="agent-info-value" data-testid="effective-cwd">${data.effectiveCwd}</span>
            </div>
            <div class="agent-info-row">
              <span class="agent-info-label">Namespace:</span>
              <span class="agent-info-value" data-testid="namespace">${data.namespace}</span>
            </div>
            <div class="agent-info-row">
              <span class="agent-info-label">State Directory:</span>
              <span class="agent-info-value" data-testid="state-dir">${data.stateDir}</span>
            </div>
            <div class="agent-info-row">
              <span class="agent-info-label">Agents Directory:</span>
              <span class="agent-info-value">
                <span class="agent-status ${data.hasAgentsDir ? 'found' : 'not-found'}" data-testid="agents-dir-status">
                  ${data.hasAgentsDir ? 'Found' : 'Not Found'}
                </span>
              </span>
            </div>
            <div class="agent-info-row">
              <span class="agent-info-label">Agent Count:</span>
              <span class="agent-info-value" data-testid="agent-count">${data.agentCount}</span>
            </div>
            <div class="agent-list" data-testid="agent-list">
              <h4 style="margin-bottom: 8px;">Agents:</h4>
              ${agentsHtml}
            </div>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `<p style="color: #dc2626;">Error: ${error.message}</p>`;
      }
    }

    // ===================
    // Dashboard & Activity Pages
    // ===================

    // Render Dashboard
    async function renderDashboard() {
      app.innerHTML = '<div class="loading">Loading Dashboard</div>';

      try {
        const data = await fetch('/api/dashboard').then(r => r.json());
        const projects = data.projects || [];
        const recentActivity = data.recentActivity || [];
        const stats = data.stats || {};

        const projectCards = projects.length > 0
          ? projects.map(p => `
              <div class="list-item" onclick="navigate('/projects/${encodeURIComponent(p.projectId)}')">
                <div class="list-item-main">
                  <div class="list-item-title">
                    ${p.favorite ? '<span style="color: #f59e0b;">&#9733;</span> ' : ''}
                    ${escapeHtml(p.alias || p.projectPath)}
                  </div>
                  <div class="list-item-meta">
                    <span class="badge badge-${p.status === 'running' ? 'running' : p.status === 'error' ? 'error' : 'queued'}">${p.status}</span>
                    ${p.sessionCount} sessions | Updated: ${formatDate(p.updatedAt)}
                  </div>
                </div>
                <span class="list-item-arrow">&#8250;</span>
              </div>
            `).join('')
          : '<div class="empty-state"><p>No projects yet. Create a project to get started.</p></div>';

        const activityItems = recentActivity.length > 0
          ? recentActivity.slice(0, 5).map(e => `
              <div class="log-entry ${e.type === 'error' ? 'error' : ''}">
                <div class="log-time">${formatDate(e.timestamp)}</div>
                <div class="log-type">${escapeHtml(e.type)}</div>
                <div class="log-content">${escapeHtml(e.summary || '')}</div>
              </div>
            `).join('')
          : '<p style="color: #6b7280;">No recent activity</p>';

        app.innerHTML = `
          <div class="page-header">
            <h2>Dashboard</h2>
            <button class="refresh-btn" onclick="renderDashboard()">Refresh</button>
          </div>

          <div class="detail-grid" style="margin-bottom: 20px;">
            <div class="card" style="text-align: center;">
              <div style="font-size: 2rem; font-weight: bold; color: #2563eb;">${stats.projects || 0}</div>
              <div style="color: #6b7280;">Projects</div>
            </div>
            <div class="card" style="text-align: center;">
              <div style="font-size: 2rem; font-weight: bold; color: #10b981;">${stats.sessions || 0}</div>
              <div style="color: #6b7280;">Sessions</div>
            </div>
            <div class="card" style="text-align: center;">
              <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;">${stats.runs || 0}</div>
              <div style="color: #6b7280;">Runs</div>
            </div>
            <div class="card" style="text-align: center;">
              <div style="font-size: 2rem; font-weight: bold; color: #8b5cf6;">${stats.events || 0}</div>
              <div style="color: #6b7280;">Events</div>
            </div>
          </div>

          <div class="card">
            <h3>Projects</h3>
            ${projectCards}
            <div style="margin-top: 16px; text-align: center;">
              <button class="btn btn-primary" onclick="showCreateProjectDialog()">+ New Project</button>
            </div>
          </div>

          <div class="card">
            <h3>Recent Activity</h3>
            ${activityItems}
            ${recentActivity.length > 5 ? '<a href="/activity" onclick="event.preventDefault(); navigate(\'\'/activity\'\')" style="display: block; text-align: center; margin-top: 12px;">View All Activity</a>' : ''}
          </div>
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="card">
            <div class="error-message">Error loading dashboard: ${escapeHtml(error.message)}</div>
            <button class="btn btn-secondary" onclick="renderDashboard()">Retry</button>
          </div>
        `;
      }
    }

    // Show create project dialog
    function showCreateProjectDialog() {
      const projectPath = prompt('Enter project path:');
      if (!projectPath) return;

      const alias = prompt('Enter project alias (optional):');

      fetch('/api/projects', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ projectPath, alias: alias || undefined }),
      })
        .then(r => r.json())
        .then(data => {
          if (data.error) {
            alert('Error: ' + data.message);
          } else {
            navigate('/projects/' + encodeURIComponent(data.projectId));
          }
        })
        .catch(e => alert('Error: ' + e.message));
    }

    // Render Activity page
    async function renderActivity() {
      app.innerHTML = '<div class="loading">Loading Activity</div>';

      try {
        const data = await fetch('/api/activity?limit=50').then(r => r.json());
        const events = data.events || [];

        const eventItems = events.length > 0
          ? events.map(e => `
              <div class="log-entry ${e.importance === 'high' ? 'error' : ''}">
                <div class="log-time">${formatFullDate(e.timestamp)}</div>
                <div class="log-type">${escapeHtml(e.type)}</div>
                <div class="log-content">${escapeHtml(e.summary || '')}</div>
                ${e.projectAlias ? '<div style="font-size: 0.85rem; color: #6b7280;">Project: ' + escapeHtml(e.projectAlias) + '</div>' : ''}
              </div>
            `).join('')
          : '<div class="empty-state"><p>No activity events yet.</p></div>';

        app.innerHTML = `
          <div class="page-header">
            <h2>Activity</h2>
            <button class="refresh-btn" onclick="renderActivity()">Refresh</button>
          </div>

          <div class="card">
            <h3>Recent Events</h3>
            ${eventItems}
          </div>
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <button class="btn btn-secondary" onclick="renderActivity()">Retry</button>
          </div>
        `;
      }
    }

    // Render Project Detail page
    async function renderProjectDetail(projectId, resumeId) {
      app.innerHTML = '<div class="loading">Loading Project</div>';

      try {
        const data = await fetch('/api/projects/' + encodeURIComponent(projectId)).then(r => r.json());
        if (data.error) throw new Error(data.message);

        const project = data.project;
        const sessions = data.sessions || [];

        // Fetch resume info if resumeId is provided
        var resumeInfo = null;
        if (resumeId) {
          try {
            var resumeRes = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/selfhost/resume/' + encodeURIComponent(resumeId));
            if (resumeRes.ok) {
              resumeInfo = await resumeRes.json();
            }
          } catch (e) {
            console.warn('Failed to load resume info:', e);
          }
        }

        const backBtn = '<a href="/dashboard" class="back-btn" onclick="event.preventDefault(); navigate(\'/dashboard\')">Back to Dashboard</a>';

        const sessionItems = sessions.length > 0
          ? sessions.map(s => `
              <div class="list-item" onclick="navigate('/sessions/${encodeURIComponent(s.sessionId)}')">
                <div class="list-item-main">
                  <div class="list-item-title">${escapeHtml(s.sessionId)}</div>
                  <div class="list-item-meta">
                    <span class="badge badge-${s.status === 'active' ? 'running' : 'complete'}">${s.status}</span>
                    ${s.totalRuns} runs | Started: ${formatDate(s.startedAt)}
                  </div>
                </div>
                <span class="list-item-arrow">&#8250;</span>
              </div>
            `).join('')
          : '<div class="empty-state"><p>No sessions yet.</p></div>';

        app.innerHTML = `
          <div class="page-header">
            <h2>${escapeHtml(project.alias || 'Project')}</h2>
            <div class="action-bar">
              ${backBtn}
              <button class="refresh-btn" onclick="renderProjectDetail('${escapeHtml(projectId)}')">Refresh</button>
              <button class="btn btn-primary" onclick="navigate('/chat/' + encodeURIComponent('${escapeHtml(projectId)}'))">Open Chat</button>
              <button class="btn btn-secondary" onclick="openProjectSettings('${escapeHtml(projectId)}')">Settings</button>
            </div>
          </div>

          <div class="card">
            <h3>Project Details</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Project ID</label>
                <value>${escapeHtml(project.projectId)}</value>
              </div>
              <div class="detail-item">
                <label>Path</label>
                <value>${escapeHtml(project.projectPath)}</value>
              </div>
              <div class="detail-item">
                <label>Status</label>
                <value><span class="badge badge-${project.status === 'running' ? 'running' : project.status === 'error' ? 'error' : 'queued'}">${project.status}</span></value>
              </div>
              <div class="detail-item">
                <label>Type</label>
                <value><span class="project-type-badge ${project.projectType === 'runner-dev' ? 'runner-dev' : 'normal'}">${project.projectType === 'runner-dev' ? 'Runner Dev' : 'Normal'}</span></value>
              </div>
              <div class="detail-item">
                <label>Last Activity</label>
                <value>${formatFullDate(project.lastActivityAt)}</value>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Sessions (${sessions.length})</h3>
            ${sessionItems}
          </div>

          <div class="action-bar" style="margin-top: 16px;">
            ${!project.archived
              ? '<button class="btn btn-secondary" onclick="archiveProject(\'' + escapeHtml(projectId) + '\')">Archive Project</button>'
              : '<button class="btn btn-primary" onclick="unarchiveProject(\'' + escapeHtml(projectId) + '\')">Unarchive Project</button>'
            }
          </div>

          ${project.projectType === 'runner-dev' ? '<div id="selfhost-section"></div>' : ''}

          ${resumeInfo ? '<div id="resume-info-section"></div>' : ''}

          ${project.projectType === 'runner-dev' ? '<div id="web-dev-mode-section"></div>' : ''}
          ${project.projectType === 'runner-dev' ? '<div id="dev-console-section"></div>' : ''}
        `;

        // Load self-hosting status for runner-dev projects
        if (project.projectType === 'runner-dev') {
          loadSelfhostStatus(projectId);
          // Render Web Dev Mode toggle
          renderWebDevModeSection(projectId);
          // Load Dev Console for runner-dev projects (if enabled)
          if (isWebDevModeEnabled(projectId)) {
            renderDevConsole(projectId);
          }
        }

        // Display resume info if available
        if (resumeInfo) {
          renderResumeInfo(resumeInfo);
        }
      } catch (error) {
        app.innerHTML = `
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <a href="/dashboard" class="btn btn-secondary" onclick="event.preventDefault(); navigate('/dashboard')">Back to Dashboard</a>
          </div>
        `;
      }
    }

    // Archive project
    async function archiveProject(projectId) {
      if (!confirm('Archive this project?')) return;
      try {
        await fetch('/api/projects/' + encodeURIComponent(projectId) + '/archive', { method: 'POST' });
        renderProjectDetail(projectId);
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // Unarchive project
    async function unarchiveProject(projectId) {
      try {
        await fetch('/api/projects/' + encodeURIComponent(projectId) + '/unarchive', { method: 'POST' });
        renderProjectDetail(projectId);
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // Load self-hosting status
    async function loadSelfhostStatus(projectId) {
      var section = document.getElementById('selfhost-section');
      if (!section) return;

      section.innerHTML = '<div class="card"><div class="loading">Loading Self-Hosting Status...</div></div>';

      try {
        var res = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/selfhost/status');
        var data = await res.json();

        if (data.error) {
          section.innerHTML = '<div class="card"><div class="error-message">Error: ' + escapeHtml(data.message) + '</div></div>';
          return;
        }

        var panelClass = data.canApply ? 'ready' : 'blocked';
        var checkIcon = function(passed) {
          return passed
            ? '<span class="check-icon pass">&#10003;</span>'
            : '<span class="check-icon fail">&#10007;</span>';
        };

        var checksHtml =
          '<div class="selfhost-checks">' +
            '<div class="selfhost-check">' + checkIcon(data.checks.devDirExists) + '<span>Dev directory exists</span></div>' +
            '<div class="selfhost-check">' + checkIcon(data.checks.gateAllPass) + '<span>gate:all passed</span></div>' +
            '<div class="selfhost-check">' + checkIcon(data.checks.evidencePresent) + '<span>EVIDENCE.md present</span></div>' +
          '</div>';

        var artifactsHtml = '';
        if (data.artifacts.gateLogPath || data.artifacts.evidencePath) {
          artifactsHtml = '<div style="margin-bottom: 16px; font-size: 0.85rem; color: #6b7280;">' +
            (data.artifacts.gateLogPath ? '<div>Gate log: ' + escapeHtml(data.artifacts.gateLogPath) + '</div>' : '') +
            (data.artifacts.evidencePath ? '<div>Evidence: ' + escapeHtml(data.artifacts.evidencePath) + '</div>' : '') +
          '</div>';
        }

        var applyPlanHtml = '';
        if (data.applyPlan && data.applyPlan.length > 0) {
          applyPlanHtml = '<div class="selfhost-apply-plan">' +
            '<strong>Apply Plan:</strong>' +
            '<ol style="margin: 8px 0 0 20px; padding: 0;">' +
            data.applyPlan.map(function(step) {
              return '<li style="margin: 4px 0;">' + escapeHtml(step) + '</li>';
            }).join('') +
            '</ol>' +
          '</div>';
        }

        var blockReasonHtml = data.blockReason
          ? '<div style="margin-top: 12px; padding: 8px 12px; background: #fef2f2; border-radius: 4px; color: #991b1b; font-size: 0.9rem;">' +
              '<strong>Blocked:</strong> ' + escapeHtml(data.blockReason) +
            '</div>'
          : '';

        var applyButton = data.canApply
          ? '<button class="btn btn-primary" onclick="applySelfhost(\'' + escapeHtml(projectId) + '\')" style="margin-top: 16px;">Create Apply Artifacts</button>'
          : '';

        var devHeadHtml = data.devHead
          ? '<div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 8px;">Dev HEAD: <code>' + escapeHtml(data.devHead) + '</code></div>'
          : '';

        section.innerHTML =
          '<div class="card selfhost-panel ' + panelClass + '">' +
            '<h4>' + (data.canApply ? '&#9989;' : '&#9888;') + ' Self-Hosting / Apply</h4>' +
            devHeadHtml +
            checksHtml +
            artifactsHtml +
            applyPlanHtml +
            blockReasonHtml +
            applyButton +
          '</div>';

      } catch (e) {
        section.innerHTML = '<div class="card"><div class="error-message">Error loading self-hosting status: ' + escapeHtml(e.message) + '</div></div>';
      }
    }

    // Apply self-hosting (create artifacts)
    async function applySelfhost(projectId) {
      if (!confirm('Create apply artifacts for self-hosting promotion?\\n\\nThis will NOT execute git commands - it only creates the apply plan files.')) return;

      try {
        var res = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/selfhost/apply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        var data = await res.json();

        if (data.error) {
          alert('Apply failed: ' + data.message);
          loadSelfhostStatus(projectId);
          return;
        }

        var resumeInfo = data.resumeUrl ? '\\n\\nResume URL: ' + window.location.origin + data.resumeUrl + '\\n\\nApply ID: ' + data.applyId : '';
        alert('Apply artifacts created!' + resumeInfo + '\\n\\nArtifact directory: ' + data.artifactDir + '\\n\\nApply plan saved to: ' + data.applyPlanPath);
        loadSelfhostStatus(projectId);
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // Render resume info panel
    function renderResumeInfo(info) {
      var section = document.getElementById('resume-info-section');
      if (!section) return;

      var expectedState = info.expectedState || {};
      var currentState = info.currentState || {};
      var stateMatch = info.stateMatch || {};

      var awaitingMatch = stateMatch.awaitingResponseMatch ? 'match' : 'mismatch';
      var awaitingIcon = stateMatch.awaitingResponseMatch ? '&#10004;' : '&#10060;';

      section.innerHTML =
        '<div class="card resume-panel ' + awaitingMatch + '">' +
          '<h4>&#128260; Resume from Apply: ' + escapeHtml(info.applyId) + '</h4>' +
          '<div class="resume-details">' +
            '<div class="resume-detail-item">' +
              '<label>Created At</label>' +
              '<value>' + formatFullDate(info.createdAt) + '</value>' +
            '</div>' +
            '<div class="resume-detail-item">' +
              '<label>Expected AWAITING_RESPONSE</label>' +
              '<value>' + (expectedState.awaitingResponse ? 'Yes' : 'No') + '</value>' +
            '</div>' +
            '<div class="resume-detail-item">' +
              '<label>Current AWAITING_RESPONSE</label>' +
              '<value>' + (currentState.awaitingResponse ? 'Yes' : 'No') + ' ' + awaitingIcon + '</value>' +
            '</div>' +
            (expectedState.latestRunId ? '<div class="resume-detail-item"><label>Expected Run ID</label><value>' + escapeHtml(expectedState.latestRunId) + '</value></div>' : '') +
            (currentState.latestRunId ? '<div class="resume-detail-item"><label>Current Run ID</label><value>' + escapeHtml(currentState.latestRunId) + '</value></div>' : '') +
          '</div>' +
          '<div class="resume-state-message ' + awaitingMatch + '">' +
            (stateMatch.awaitingResponseMatch
              ? '&#10004; AWAITING_RESPONSE state preserved across restart'
              : '&#9888; AWAITING_RESPONSE state changed after restart') +
          '</div>' +
        '</div>';
    }

    // Render Chat page
    async function renderChat(projectId) {
      app.innerHTML = '<div class="loading">Loading Chat</div>';

      try {
        // Fetch project and conversation in parallel
        const [projectRes, conversationRes] = await Promise.all([
          fetch('/api/projects/' + encodeURIComponent(projectId)).then(r => r.json()),
          fetch('/api/projects/' + encodeURIComponent(projectId) + '/conversation').then(r => r.json())
        ]);

        if (projectRes.error) throw new Error(projectRes.message);

        const project = projectRes.project;
        const messages = conversationRes.messages || [];
        const awaitingResponse = conversationRes.awaitingResponse;
        const awaitingMessage = conversationRes.awaitingMessage;

        const backBtn = '<a href="/projects/' + encodeURIComponent(projectId) + '" class="back-btn" onclick="event.preventDefault(); navigate(\'/projects/' + encodeURIComponent(projectId) + '\')">Back to Project</a>';

        // Build message list
        const messageItems = messages.length > 0
          ? messages.map(function(m) {
              var roleClass = m.role;
              var statusBadge = '';
              if (m.status === 'processing') {
                statusBadge = '<span class="badge badge-running">Processing</span>';
              } else if (m.status === 'awaiting_response') {
                statusBadge = '<span class="badge badge-needs_response">Awaiting Response</span>';
              } else if (m.status === 'error') {
                statusBadge = '<span class="badge badge-error">Error</span>';
              }
              var meta = '<div class="chat-bubble-meta">' + formatDate(m.timestamp) + ' ' + statusBadge + '</div>';
              return '<div class="chat-message ' + roleClass + '">' +
                '<div class="chat-bubble">' + escapeHtml(m.content) + meta + '</div>' +
              '</div>';
            }).join('')
          : '<div class="empty-state" style="padding: 40px; text-align: center;"><p>No messages yet. Start a conversation!</p></div>';

        // Determine input mode
        var inputPlaceholder = awaitingResponse 
          ? 'Type your response...' 
          : 'Type a message to start a new task...';
        var sendBtnClass = awaitingResponse ? 'chat-send-btn respond-mode' : 'chat-send-btn';
        var sendBtnText = awaitingResponse ? 'Respond' : 'Send';
        var inputClass = awaitingResponse ? 'chat-input respond-mode' : 'chat-input';

        // Status bar for awaiting response
        var statusBar = '';
        if (awaitingResponse && awaitingMessage) {
          var question = awaitingMessage.metadata && awaitingMessage.metadata.clarificationQuestion 
            ? awaitingMessage.metadata.clarificationQuestion 
            : 'The assistant is waiting for your response.';
          statusBar = '<div class="chat-status awaiting">' +
            '<strong>Awaiting Response:</strong> ' + escapeHtml(question) +
          '</div>';
        }

        app.innerHTML = 
          '<div class="page-header">' +
            '<h2>Chat: ' + escapeHtml(project.alias || project.projectPath) + '</h2>' +
            '<div class="action-bar">' +
              backBtn +
              '<button class="refresh-btn" onclick="renderChat(\'' + escapeHtml(projectId) + '\')">Refresh</button>' +
              '<button class="btn btn-secondary" onclick="openProjectSettings(\'' + escapeHtml(projectId) + '\')">Settings</button>' +
            '</div>' +
          '</div>' +
          '<div class="card chat-container">' +
            '<div class="chat-messages" id="chat-messages">' + messageItems + '</div>' +
            statusBar +
            '<div class="chat-input-container">' +
              '<div class="chat-input-wrapper">' +
                '<textarea class="' + inputClass + '" id="chat-input" placeholder="' + inputPlaceholder + '" rows="1" onkeydown="handleChatKeydown(event, \'' + escapeHtml(projectId) + '\', ' + (awaitingResponse ? 'true' : 'false') + ')"></textarea>' +
                '<button class="' + sendBtnClass + '" id="chat-send-btn" onclick="sendChatMessage(\'' + escapeHtml(projectId) + '\', ' + (awaitingResponse ? 'true' : 'false') + ')">' + sendBtnText + '</button>' +
              '</div>' +
            '</div>' +
          '</div>';

        // Scroll to bottom
        var chatMessages = document.getElementById('chat-messages');
        if (chatMessages) {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Focus input
        var chatInput = document.getElementById('chat-input');
        if (chatInput) chatInput.focus();

      } catch (error) {
        app.innerHTML = 
          '<div class="card">' +
            '<div class="error-message">Error: ' + escapeHtml(error.message) + '</div>' +
            '<a href="/dashboard" class="btn btn-secondary" onclick="event.preventDefault(); navigate(\'/dashboard\')">Back to Dashboard</a>' +
          '</div>';
      }
    }

    // Handle chat input keydown (Enter to send)
    function handleChatKeydown(event, projectId, isRespond) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage(projectId, isRespond);
      }
    }

    // Send chat message
    async function sendChatMessage(projectId, isRespond) {
      var input = document.getElementById('chat-input');
      var sendBtn = document.getElementById('chat-send-btn');
      var content = input.value.trim();

      if (!content) return;

      // Disable input while sending
      input.disabled = true;
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      try {
        var endpoint = isRespond 
          ? '/api/projects/' + encodeURIComponent(projectId) + '/respond'
          : '/api/projects/' + encodeURIComponent(projectId) + '/chat';

        var response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: content })
        });

        var data = await response.json();
        if (data.error) throw new Error(data.message);

        // Refresh chat
        renderChat(projectId);

      } catch (error) {
        alert('Error: ' + error.message);
        input.disabled = false;
        sendBtn.disabled = false;
        sendBtn.textContent = isRespond ? 'Respond' : 'Send';
      }
    }

    // Open project settings modal
    async function openProjectSettings(projectId) {
      try {
        var res = await fetch('/api/projects/' + encodeURIComponent(projectId)).then(function(r) { return r.json(); });
        if (res.error) throw new Error(res.message);

        var project = res.project;
        var bootstrapPrompt = project.bootstrapPrompt || '';
        var projectType = project.projectType || 'normal';

        // Create modal
        var modal = document.createElement('div');
        modal.id = 'settings-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;';
        modal.innerHTML = 
          '<div style="background: white; padding: 24px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">' +
            '<h3 style="margin-bottom: 16px;">Project Settings</h3>' +
            '<div class="form-group">' +
              '<label>Project Type</label>' +
              '<select id="project-type-select">' +
                '<option value="normal"' + (projectType === 'normal' ? ' selected' : '') + '>Normal</option>' +
                '<option value="runner-dev"' + (projectType === 'runner-dev' ? ' selected' : '') + '>Runner Dev (Self-modification)</option>' +
              '</select>' +
            '</div>' +
            '<div class="form-group">' +
              '<label>Bootstrap Prompt (injected at the start of every task)</label>' +
              '<textarea id="bootstrap-prompt-input" rows="6" style="font-family: monospace;">' + escapeHtml(bootstrapPrompt) + '</textarea>' +
            '</div>' +
            '<div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">' +
              '<button class="btn btn-secondary" onclick="closeSettingsModal()">Cancel</button>' +
              '<button class="btn btn-primary" onclick="saveChatProjectSettings(\'' + escapeHtml(projectId) + '\')">Save</button>' +
            '</div>' +
          '</div>';

        document.body.appendChild(modal);

        // Close on backdrop click
        modal.addEventListener('click', function(e) {
          if (e.target === modal) closeSettingsModal();
        });

      } catch (error) {
        alert('Error loading settings: ' + error.message);
      }
    }

    // Close settings modal
    function closeSettingsModal() {
      var modal = document.getElementById('settings-modal');
      if (modal) modal.remove();
    }

    // Save project settings (Chat MVP settings modal)
    async function saveChatProjectSettings(projectId) {
      var projectType = document.getElementById('project-type-select').value;
      var bootstrapPrompt = document.getElementById('bootstrap-prompt-input').value;

      try {
        var response = await fetch('/api/projects/' + encodeURIComponent(projectId), {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            projectType: projectType,
            bootstrapPrompt: bootstrapPrompt 
          })
        });

        var data = await response.json();
        if (data.error) throw new Error(data.message);

        closeSettingsModal();
        
        // Refresh current page
        var path = window.location.pathname;
        if (path.startsWith('/chat/')) {
          renderChat(projectId);
        } else {
          renderProjectDetail(projectId);
        }

      } catch (error) {
        alert('Error saving settings: ' + error.message);
      }
    }


    // Render Session Detail page
    async function renderSessionDetail(sessionId) {
      app.innerHTML = '<div class="loading">Loading Session</div>';

      try {
        const data = await fetch('/api/sessions/' + encodeURIComponent(sessionId)).then(r => r.json());
        if (data.error) throw new Error(data.message);

        const session = data.session;
        const runs = data.runs || [];

        const backBtn = session.projectId 
          ? '<a href="/projects/' + encodeURIComponent(session.projectId) + '" class="back-btn" onclick="event.preventDefault(); navigate(\'/projects/' + encodeURIComponent(session.projectId) + '\')">Back to Project</a>'
          : '<a href="/dashboard" class="back-btn" onclick="event.preventDefault(); navigate(\'/dashboard\')">Back to Dashboard</a>';

        const runItems = runs.length > 0
          ? runs.map(r => `
              <div class="list-item" onclick="navigate('/runs/${encodeURIComponent(r.runId)}')">
                <div class="list-item-main">
                  <div class="list-item-title">${escapeHtml(r.taskRunId)}</div>
                  <div class="list-item-meta">
                    <span class="badge badge-${r.status === 'COMPLETE' ? 'complete' : r.status === 'RUNNING' ? 'running' : r.status === 'ERROR' ? 'error' : 'queued'}">${r.status}</span>
                    Started: ${formatDate(r.startedAt)}
                  </div>
                </div>
                <span class="list-item-arrow">&#8250;</span>
              </div>
            `).join('')
          : '<div class="empty-state"><p>No runs yet.</p></div>';

        app.innerHTML = `
          <div class="page-header">
            <h2>Session</h2>
            <div class="action-bar">
              ${backBtn}
              <button class="refresh-btn" onclick="renderSessionDetail('${escapeHtml(sessionId)}')">Refresh</button>
            </div>
          </div>

          <div class="card">
            <h3>Session Details</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Session ID</label>
                <value>${escapeHtml(session.sessionId)}</value>
              </div>
              <div class="detail-item">
                <label>Status</label>
                <value><span class="badge badge-${session.status === 'active' ? 'running' : 'complete'}">${session.status}</span></value>
              </div>
              <div class="detail-item">
                <label>Started</label>
                <value>${formatFullDate(session.startedAt)}</value>
              </div>
              <div class="detail-item">
                <label>Total Runs</label>
                <value>${session.totalRuns}</value>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Runs (${runs.length})</h3>
            ${runItems}
          </div>
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <a href="/dashboard" class="btn btn-secondary" onclick="event.preventDefault(); navigate('/dashboard')">Back to Dashboard</a>
          </div>
        `;
      }
    }

    // Render Run Detail page
    async function renderRunDetail(runId) {
      app.innerHTML = '<div class="loading">Loading Run</div>';

      try {
        const data = await fetch('/api/runs/' + encodeURIComponent(runId)).then(r => r.json());
        if (data.error) throw new Error(data.message);

        const run = data.run;
        const events = data.events || [];

        const backBtn = run.sessionId 
          ? '<a href="/sessions/' + encodeURIComponent(run.sessionId) + '" class="back-btn" onclick="event.preventDefault(); navigate(\'/sessions/' + encodeURIComponent(run.sessionId) + '\')">Back to Session</a>'
          : '<a href="/dashboard" class="back-btn" onclick="event.preventDefault(); navigate(\'/dashboard\')">Back to Dashboard</a>';

        const eventLog = events.length > 0
          ? events.map(e => `
              <div class="log-entry ${e.level === 'error' ? 'error' : ''}">
                <div class="log-time">${formatFullDate(e.timestamp)}</div>
                <div class="log-type">${escapeHtml(e.type)}</div>
                <div class="log-content">${escapeHtml(e.message)}</div>
              </div>
            `).join('')
          : '<p style="color: #6b7280;">No events recorded.</p>';

        app.innerHTML = `
          <div class="page-header">
            <h2>Run Detail</h2>
            <div class="action-bar">
              ${backBtn}
              <button class="refresh-btn" onclick="renderRunDetail('${escapeHtml(runId)}')">Refresh</button>
              <button class="btn btn-secondary" onclick="generateInspectionPacket('${escapeHtml(runId)}')">Generate Inspection Packet</button>
            </div>
          </div>

          <div class="card">
            <h3>Run Details</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Run ID</label>
                <value>${escapeHtml(run.runId)}</value>
              </div>
              <div class="detail-item">
                <label>Task Run ID</label>
                <value>${escapeHtml(run.taskRunId)}</value>
              </div>
              <div class="detail-item">
                <label>Status</label>
                <value><span class="badge badge-${run.status === 'COMPLETE' ? 'complete' : run.status === 'RUNNING' ? 'running' : run.status === 'ERROR' ? 'error' : 'queued'}">${run.status}</span></value>
              </div>
              <div class="detail-item">
                <label>Started</label>
                <value>${formatFullDate(run.startedAt)}</value>
              </div>
              ${run.endedAt ? '<div class="detail-item"><label>Ended</label><value>' + formatFullDate(run.endedAt) + '</value></div>' : ''}
              <div class="detail-item">
                <label>Event Count</label>
                <value>${run.eventCount}</value>
              </div>
            </div>
          </div>

          ${run.prompt ? '<div class="card"><h3>Prompt</h3><div class="prompt-box">' + escapeHtml(run.prompt) + '</div></div>' : ''}

          <div class="card">
            <h3>Events (${events.length})</h3>
            ${eventLog}
          </div>
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <a href="/dashboard" class="btn btn-secondary" onclick="event.preventDefault(); navigate('/dashboard')">Back to Dashboard</a>
          </div>
        `;
      }
    }

    // Generate Inspection Packet
    async function generateInspectionPacket(runId) {
      try {
        const response = await fetch('/api/inspection/run/' + encodeURIComponent(runId), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ generatedBy: 'user' }),
        });
        const packet = await response.json();
        if (packet.error) throw new Error(packet.message);

        // Open clipboard format in new window
        const clipboardUrl = '/api/inspection/' + encodeURIComponent(packet.packetId) + '/clipboard';
        alert('Inspection packet generated: ' + packet.packetId + '\n\nYou can copy it for ChatGPT from:\n' + clipboardUrl);
      } catch (error) {
        alert('Error generating packet: ' + error.message);
      }
    }

    
    // Router
    function router() {
      const path = window.location.pathname;
      const search = new URLSearchParams(window.location.search);
      currentPath = path;
      updateNav(path);

      if (path === '/dashboard') {
        renderDashboard();
      } else if (path === '/' || path === '') {
        renderTaskGroupList();
      } else if (path === '/activity') {
        renderActivity();
      } else if (path.startsWith('/task-groups/')) {
        const taskGroupId = decodeURIComponent(path.split('/task-groups/')[1]);
        renderTaskList(taskGroupId);
      } else if (path.startsWith('/tasks/')) {
        const taskId = decodeURIComponent(path.split('/tasks/')[1]);
        renderTaskDetail(taskId);
      } else if (path.startsWith('/projects/')) {
        const projectId = decodeURIComponent(path.split('/projects/')[1]);
        const resumeId = search.get('resume');
        renderProjectDetail(projectId, resumeId);
      } else if (path.startsWith('/runs/')) {
        const runId = decodeURIComponent(path.split('/runs/')[1]);
        renderRunDetail(runId);
      } else if (path.startsWith('/sessions/')) {
        const sessionId = decodeURIComponent(path.split('/sessions/')[1]);
        renderSessionDetail(sessionId);
      } else if (path === '/new') {
        const group = search.get('group') || '';
        renderNewCommandForm(group);
      } else if (path === '/agent') {
        renderAgentLauncher();
      } else if (path.startsWith('/chat/')) {
        const projectId = decodeURIComponent(path.split('/chat/')[1]);
        renderChat(projectId);
      } else if (path === '/settings') {
        renderSettings();
      } else {
        app.innerHTML = `
          <div class="card">
            <h2>404 - Page Not Found</h2>
            <p>The page you're looking for doesn't exist.</p>
            <button class="btn btn-primary" onclick="navigate('/')" style="margin-top: 16px;">Go Home</button>
          </div>
        `;
      }
    }

    // Navigate
    function navigate(path) {
      history.pushState(null, '', path);
      router();
    }

    // Handle back/forward
    window.addEventListener('popstate', router);

    // Handle navigation links
    document.querySelectorAll('#main-nav a').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        navigate(link.getAttribute('href'));
      });
    });

    // Current namespace state
    let currentNamespace = '';
    let runnerRefreshInterval = null;

    // Load namespaces and populate selector
    async function loadNamespaces() {
      try {
        // Don't pass namespace param to /namespaces - it returns all namespaces
        const response = await fetch('/api/namespaces');
        const data = await response.json();

        const selector = document.getElementById('namespace-selector');
        const select = document.getElementById('namespace-select');

        if (!selector || !select) return;

        // Set current namespace only if not already set by user selection
        if (!currentNamespace) {
          currentNamespace = data.current_namespace;
        }
        const namespaces = data.namespaces || [];

        // Build options
        let options = '';
        if (namespaces.length === 0) {
          // No namespaces from scan, just show current
          options = `<option value="${escapeHtml(currentNamespace)}">${escapeHtml(currentNamespace)}</option>`;
        } else {
          options = namespaces.map(ns => {
            const selected = ns.namespace === currentNamespace ? 'selected' : '';
            const counts = `(${ns.queued_count}Q/${ns.running_count}R/${ns.task_count}T)`;
            return `<option value="${escapeHtml(ns.namespace)}" ${selected}>${escapeHtml(ns.namespace)} ${counts}</option>`;
          }).join('');
        }

        select.innerHTML = options;
        selector.style.display = 'flex';

        // Load runners for current namespace
        loadRunnerStatus();
      } catch (e) {
        console.warn('Failed to load namespaces:', e);
      }
    }

    // Handle namespace change
    function onNamespaceChange(namespace) {
      if (namespace === currentNamespace) return;

      // Update current namespace and reload data
      currentNamespace = namespace;

      // Reload runner status for new namespace
      loadRunnerStatus();

      // Re-navigate to refresh current page data with new namespace
      navigate(currentPath);
    }

    // Load runner status
    async function loadRunnerStatus() {
      try {
        const data = await api('/runners');
        const runners = data.runners || [];

        const dot = document.getElementById('runner-dot');
        const text = document.getElementById('runner-text');

        if (!dot || !text) return;

        const aliveCount = runners.filter(r => r.is_alive).length;
        const totalCount = runners.length;

        if (aliveCount > 0) {
          dot.className = 'runner-dot alive';
          text.textContent = aliveCount + ' runner' + (aliveCount > 1 ? 's' : '') + ' active';
        } else if (totalCount > 0) {
          dot.className = 'runner-dot dead';
          text.textContent = 'No active runners';
        } else {
          dot.className = 'runner-dot dead';
          text.textContent = 'No runners';
        }
      } catch (e) {
        console.warn('Failed to load runner status:', e);
        const dot = document.getElementById('runner-dot');
        const text = document.getElementById('runner-text');
        if (dot) dot.className = 'runner-dot dead';
        if (text) text.textContent = 'Error';
      }
    }

    // Start periodic runner status refresh
    function startRunnerRefresh() {
      // Refresh every 30 seconds
      runnerRefreshInterval = setInterval(loadRunnerStatus, 30000);
    }

    // Stop runner refresh
    function stopRunnerRefresh() {
      if (runnerRefreshInterval) {
        clearInterval(runnerRefreshInterval);
        runnerRefreshInterval = null;
      }
    }

    // =========================================================================
    // Web Dev Mode Functions
    // =========================================================================

    function getWebDevModeKey(projectId) {
      return 'webDevMode_' + projectId;
    }

    function isWebDevModeEnabled(projectId) {
      return localStorage.getItem(getWebDevModeKey(projectId)) === 'enabled';
    }

    function setWebDevModeEnabled(projectId, enabled) {
      if (enabled) {
        localStorage.setItem(getWebDevModeKey(projectId), 'enabled');
      } else {
        localStorage.removeItem(getWebDevModeKey(projectId));
      }
    }

    function renderWebDevModeSection(projectId) {
      var section = document.getElementById('web-dev-mode-section');
      if (!section) return;

      var enabled = isWebDevModeEnabled(projectId);

      section.innerHTML = `
        <div class="card web-dev-mode-card">
          <div class="web-dev-mode-header">
            <h3>
              Web Dev Mode
              <span class="web-dev-mode-status ${enabled ? 'enabled' : 'disabled'}">
                ${enabled ? 'Enabled' : 'Disabled'}
              </span>
            </h3>
            <div class="web-dev-mode-toggle ${enabled ? 'enabled' : ''}"
                 onclick="toggleWebDevMode('${escapeHtml(projectId)}')"
                 title="${enabled ? 'Click to disable' : 'Click to enable'}">
            </div>
          </div>
          <p class="web-dev-mode-description">
            Web Dev Mode allows you to develop this project directly from the Web UI,
            including running commands, viewing logs, and managing git operations.
          </p>
          ${enabled ? `
            <div class="web-dev-mode-warning">
              <strong>Safety Notice</strong>
              Web Dev Mode is enabled. Git push and destructive operations will require confirmation.
              Always verify gate:all passes before pushing.
            </div>
          ` : ''}
        </div>
      `;
    }

    function toggleWebDevMode(projectId) {
      var currentlyEnabled = isWebDevModeEnabled(projectId);

      if (currentlyEnabled) {
        // Disabling - just disable without confirmation
        setWebDevModeEnabled(projectId, false);
        renderWebDevModeSection(projectId);
        // Hide dev console
        var devSection = document.getElementById('dev-console-section');
        if (devSection) devSection.innerHTML = '';
      } else {
        // Enabling - show confirmation dialog
        showSafetyDialog(
          'Enable Web Dev Mode?',
          'Enabling Web Dev Mode allows you to run commands and modify code directly from the Web UI. ' +
          'This is intended for development of this PM Orchestrator Runner project itself. ' +
          'Git push requires gate:all to pass first.',
          'Enable',
          function() {
            setWebDevModeEnabled(projectId, true);
            renderWebDevModeSection(projectId);
            renderDevConsole(projectId);
          }
        );
      }
    }

    function showSafetyDialog(title, message, confirmText, onConfirm) {
      var overlay = document.createElement('div');
      overlay.className = 'safety-dialog-overlay';
      overlay.innerHTML = `
        <div class="safety-dialog">
          <h4>‚ö†Ô∏è ${escapeHtml(title)}</h4>
          <p>${escapeHtml(message)}</p>
          <div class="safety-dialog-actions">
            <button class="btn btn-secondary" onclick="closeSafetyDialog()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmSafetyDialog()">
              ${escapeHtml(confirmText)}
            </button>
          </div>
        </div>
      `;

      window.safetyDialogCallback = onConfirm;
      document.body.appendChild(overlay);
    }

    function closeSafetyDialog() {
      var overlay = document.querySelector('.safety-dialog-overlay');
      if (overlay) {
        overlay.remove();
      }
      window.safetyDialogCallback = null;
    }

    function confirmSafetyDialog() {
      var callback = window.safetyDialogCallback;
      closeSafetyDialog();
      if (callback) {
        callback();
      }
    }

    // =========================================================================
    // Dev Console Functions (runner-dev projects only)
    // =========================================================================

    var devConsoleState = {
      projectId: null,
      currentPath: '.',
      currentFile: null,
      cmdHistory: [],
      activeRunId: null,
      pollInterval: null
    };

    function renderDevConsole(projectId) {
      devConsoleState.projectId = projectId;
      devConsoleState.currentPath = '.';
      devConsoleState.currentFile = null;

      var section = document.getElementById('dev-console-section');
      if (!section) return;

      section.innerHTML = `
        <div class="card dev-console">
          <h3>Dev Console</h3>
          <div class="dev-console-layout">
            <div class="dev-file-tree">
              <div class="dev-file-tree-header">
                <input type="text" id="dev-search-input" placeholder="Search files..." onkeydown="if(event.key==='Enter')devSearch()">
              </div>
              <div id="dev-search-results" class="dev-search-results" style="display:none;"></div>
              <div id="dev-file-list" class="dev-file-list">
                <div class="loading">Loading...</div>
              </div>
            </div>
            <div class="dev-content-area">
              <div class="dev-file-view">
                <div class="dev-file-view-header">
                  <span id="dev-file-path">No file selected</span>
                </div>
                <div id="dev-file-content" class="dev-file-view-content">Select a file to view its contents.</div>
              </div>
              <div class="dev-patch-section">
                <h4>Apply Patch (unified diff)</h4>
                <textarea id="dev-patch-input" class="dev-patch-textarea" placeholder="Paste unified diff here..."></textarea>
                <div style="margin-top: 8px;">
                  <button class="btn btn-primary" onclick="devApplyPatch()">Apply Patch</button>
                  <span id="dev-patch-status" style="margin-left: 8px;"></span>
                </div>
              </div>
            </div>
            <div class="dev-cmd-section">
              <h4>Command Execution</h4>
              <!-- Runbook Preset Buttons -->
              <div class="runbook-presets" id="runbook-presets">
                <button class="runbook-btn" onclick="devRunRunbook('sync')" id="runbook-sync">
                  <span class="btn-icon">üîÑ</span> SYNC
                </button>
                <button class="runbook-btn" onclick="devRunRunbook('build')" id="runbook-build">
                  <span class="btn-icon">üî®</span> BUILD
                </button>
                <button class="runbook-btn" onclick="devRunRunbook('test')" id="runbook-test">
                  <span class="btn-icon">üß™</span> TEST
                </button>
                <button class="runbook-btn" onclick="devRunRunbook('gate')" id="runbook-gate">
                  <span class="btn-icon">üö¶</span> GATE
                </button>
                <button class="runbook-btn" onclick="devRunRunbook('e2e')" id="runbook-e2e">
                  <span class="btn-icon">üé≠</span> E2E
                </button>
              </div>
              <div class="dev-cmd-input-row">
                <input type="text" id="dev-cmd-input" class="dev-cmd-input" placeholder="Enter command (e.g., npm run gate:all)" onkeydown="if(event.key==='Enter')devRunCmd()">
                <button class="btn btn-primary" onclick="devRunCmd()">Run</button>
                <button class="btn btn-secondary" onclick="devLoadCmdHistory()">History</button>
              </div>
              <div id="dev-cmd-log" class="dev-cmd-log">Ready. Enter a command above.</div>
              <div id="dev-cmd-history" class="dev-cmd-history" style="display:none;"></div>
            </div>
            <!-- Session Log Tree -->
            <div class="session-log-tree" id="session-log-tree">
              <div class="session-log-tree-header">
                <h4>Session Log Tree</h4>
                <div class="session-log-tree-actions">
                  <button class="btn btn-secondary btn-sm" onclick="devRefreshSessionTree()">Refresh</button>
                  <button class="btn btn-secondary btn-sm" onclick="devCollapseAllSessions()">Collapse All</button>
                </div>
              </div>
              <div class="session-log-tree-content" id="session-tree-content">
                <div class="loading">Loading session tree...</div>
              </div>
            </div>
            <!-- Session Log Detail Panel -->
            <div class="session-log-detail" id="session-log-detail" style="display:none;">
              <div class="session-log-detail-header">
                <h4 id="session-log-detail-title">Run Details</h4>
                <button class="btn btn-secondary btn-sm" onclick="devCloseLogDetail()">Close</button>
              </div>
              <div class="session-log-detail-meta" id="session-log-detail-meta"></div>
              <div class="session-log-detail-content" id="session-log-detail-content"></div>
            </div>
            <div class="dev-git-section">
              <h4>Git Operations</h4>
              <div id="dev-git-status" class="dev-git-status">Loading git status...</div>
              <div class="dev-git-actions">
                <button class="btn btn-secondary" onclick="devGitRefresh()">Refresh</button>
                <button class="btn btn-secondary" onclick="devGitShowDiff()">Show Diff</button>
                <button class="btn btn-secondary" onclick="devGitShowDiff(true)">Show Staged</button>
              </div>
              <div id="dev-git-diff" class="dev-git-diff" style="display:none;"></div>
              <div class="dev-git-commit-section">
                <div id="dev-git-gate-status" class="dev-git-gate-status"></div>
                <input type="text" id="dev-git-commit-msg" class="dev-cmd-input" placeholder="Commit message..." onkeydown="if(event.key==='Enter')devGitCommit()">
                <div class="dev-git-actions" style="margin-top: 8px;">
                  <button class="btn btn-primary" onclick="devGitCommit()" id="dev-git-commit-btn" disabled>Commit</button>
                  <button class="btn btn-warning" onclick="devGitPush()" id="dev-git-push-btn" disabled>Push</button>
                </div>
                <div id="dev-git-result" class="dev-git-result"></div>
              </div>
            </div>
          </div>
        </div>
      `;

      devLoadTree('.');
      devLoadCmdHistory();
      devGitRefresh();
      devLoadSessionTree();
    }

    async function devLoadTree(dirPath) {
      var projectId = devConsoleState.projectId;
      if (!projectId) return;

      devConsoleState.currentPath = dirPath;
      var listEl = document.getElementById('dev-file-list');
      if (!listEl) return;

      listEl.innerHTML = '<div class="loading">Loading...</div>';

      try {
        var resp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/dev/fs/tree?root=' + encodeURIComponent(dirPath));
        var data = await resp.json();

        if (data.error) {
          listEl.innerHTML = '<div class="error-message">' + escapeHtml(data.message) + '</div>';
          return;
        }

        var html = '';
        if (dirPath !== '.') {
          var parentPath = dirPath.split('/').slice(0, -1).join('/') || '.';
          html += '<div class="dev-file-item parent" onclick="devLoadTree(\'' + escapeHtml(parentPath) + '\')">.. (parent)</div>';
        }

        for (var entry of data.entries) {
          if (entry.type === 'directory') {
            html += '<div class="dev-file-item directory" onclick="devLoadTree(\'' + escapeHtml(entry.relPath) + '\')">' + escapeHtml(entry.name) + '</div>';
          } else {
            html += '<div class="dev-file-item file" onclick="devReadFile(\'' + escapeHtml(entry.relPath) + '\')">' + escapeHtml(entry.name) + '</div>';
          }
        }

        listEl.innerHTML = html || '<div class="empty-state">Empty directory</div>';
      } catch (err) {
        listEl.innerHTML = '<div class="error-message">Error: ' + escapeHtml(err.message) + '</div>';
      }
    }

    async function devReadFile(filePath) {
      var projectId = devConsoleState.projectId;
      if (!projectId) return;

      devConsoleState.currentFile = filePath;
      var pathEl = document.getElementById('dev-file-path');
      var contentEl = document.getElementById('dev-file-content');
      if (!pathEl || !contentEl) return;

      pathEl.textContent = filePath;
      contentEl.textContent = 'Loading...';

      try {
        var resp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/dev/fs/read?path=' + encodeURIComponent(filePath));
        var data = await resp.json();

        if (data.error) {
          contentEl.textContent = 'Error: ' + data.message;
          return;
        }

        contentEl.textContent = data.content;
      } catch (err) {
        contentEl.textContent = 'Error: ' + err.message;
      }
    }

    async function devSearch() {
      var projectId = devConsoleState.projectId;
      if (!projectId) return;

      var input = document.getElementById('dev-search-input');
      var resultsEl = document.getElementById('dev-search-results');
      if (!input || !resultsEl) return;

      var query = input.value.trim();
      if (!query) {
        resultsEl.style.display = 'none';
        return;
      }

      resultsEl.innerHTML = '<div class="loading">Searching...</div>';
      resultsEl.style.display = 'block';

      try {
        var resp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/dev/fs/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: query })
        });
        var results = await resp.json();

        if (results.error) {
          resultsEl.innerHTML = '<div class="error-message">' + escapeHtml(results.message) + '</div>';
          return;
        }

        if (results.length === 0) {
          resultsEl.innerHTML = '<div class="empty-state">No results found</div>';
          return;
        }

        var html = results.slice(0, 50).map(function(r) {
          return '<div class="dev-search-result" onclick="devReadFile(\'' + escapeHtml(r.relPath) + '\')">' +
            '<span class="path">' + escapeHtml(r.relPath) + '</span>' +
            '<span class="line">:' + r.line + '</span><br>' +
            '<span class="text">' + escapeHtml(r.text.substring(0, 100)) + '</span>' +
            '</div>';
        }).join('');

        resultsEl.innerHTML = html;
      } catch (err) {
        resultsEl.innerHTML = '<div class="error-message">Error: ' + escapeHtml(err.message) + '</div>';
      }
    }

    async function devApplyPatch() {
      var projectId = devConsoleState.projectId;
      if (!projectId) return;

      var input = document.getElementById('dev-patch-input');
      var statusEl = document.getElementById('dev-patch-status');
      if (!input || !statusEl) return;

      var patch = input.value.trim();
      if (!patch) {
        statusEl.innerHTML = '<span style="color:#dc2626;">No patch provided</span>';
        return;
      }

      statusEl.innerHTML = '<span style="color:#2563eb;">Applying...</span>';

      try {
        var resp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/dev/fs/applyPatch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ patch: patch })
        });
        var result = await resp.json();

        if (result.ok) {
          statusEl.innerHTML = '<span style="color:#16a34a;">Success! Changed: ' + escapeHtml(result.changedFiles.join(', ')) + '</span>';
          input.value = '';
          // Refresh file view if current file was changed
          if (devConsoleState.currentFile && result.changedFiles.includes(devConsoleState.currentFile)) {
            devReadFile(devConsoleState.currentFile);
          }
        } else {
          statusEl.innerHTML = '<span style="color:#dc2626;">Failed: ' + escapeHtml(result.error) + '</span>';
        }
      } catch (err) {
        statusEl.innerHTML = '<span style="color:#dc2626;">Error: ' + escapeHtml(err.message) + '</span>';
      }
    }

    async function devRunCmd() {
      var projectId = devConsoleState.projectId;
      if (!projectId) return;

      var input = document.getElementById('dev-cmd-input');
      var logEl = document.getElementById('dev-cmd-log');
      if (!input || !logEl) return;

      var command = input.value.trim();
      if (!command) return;

      logEl.innerHTML = '<span class="system">$ ' + escapeHtml(command) + '</span>\n<span class="system">Starting...</span>\n';

      try {
        var resp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/dev/cmd/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command: command })
        });
        var result = await resp.json();

        if (result.error) {
          logEl.innerHTML += '<span class="stderr">Error: ' + escapeHtml(result.message) + '</span>\n';
          return;
        }

        devConsoleState.activeRunId = result.runId;
        input.value = '';

        // Start polling for logs
        devStartLogPolling(result.runId);
      } catch (err) {
        logEl.innerHTML += '<span class="stderr">Error: ' + escapeHtml(err.message) + '</span>\n';
      }
    }

    function devStartLogPolling(runId) {
      // Clear any existing interval
      if (devConsoleState.pollInterval) {
        clearInterval(devConsoleState.pollInterval);
      }

      var lastLogCount = 0;

      devConsoleState.pollInterval = setInterval(async function() {
        var projectId = devConsoleState.projectId;
        if (!projectId) return;

        try {
          var resp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/dev/cmd/' + encodeURIComponent(runId) + '/log');
          var data = await resp.json();

          if (data.error) return;

          var logEl = document.getElementById('dev-cmd-log');
          if (!logEl) return;

          // Render all logs
          var html = '';
          for (var entry of data.logs) {
            var cls = entry.stream;
            html += '<span class="' + cls + '">' + escapeHtml(entry.text) + '</span>';
          }
          logEl.innerHTML = html;
          logEl.scrollTop = logEl.scrollHeight;

          // Stop polling if completed
          if (data.status === 'completed' || data.status === 'failed') {
            clearInterval(devConsoleState.pollInterval);
            devConsoleState.pollInterval = null;
            devConsoleState.activeRunId = null;
            devLoadCmdHistory();
          }
        } catch (err) {
          console.warn('Log polling error:', err);
        }
      }, 1000);
    }

    async function devLoadCmdHistory() {
      var projectId = devConsoleState.projectId;
      if (!projectId) return;

      var historyEl = document.getElementById('dev-cmd-history');
      if (!historyEl) return;

      try {
        var resp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/dev/cmd/list');
        var data = await resp.json();

        if (data.error || !data.runs || data.runs.length === 0) {
          historyEl.style.display = 'none';
          return;
        }

        var html = '<div style="font-size:0.8rem;color:#6b7280;margin-bottom:4px;">Recent commands:</div>';
        for (var run of data.runs.slice(0, 5)) {
          var statusColor = run.status === 'completed' ? '#16a34a' : run.status === 'failed' ? '#dc2626' : '#2563eb';
          html += '<div class="dev-cmd-history-item" onclick="devViewLog(\'' + escapeHtml(run.runId) + '\')">' +
            '<span>' + escapeHtml(run.command.substring(0, 40)) + (run.command.length > 40 ? '...' : '') + '</span>' +
            '<span style="color:' + statusColor + ';">' + run.status + '</span>' +
            '</div>';
        }

        historyEl.innerHTML = html;
        historyEl.style.display = 'block';
      } catch (err) {
        console.warn('Failed to load cmd history:', err);
      }
    }

    async function devViewLog(runId) {
      var projectId = devConsoleState.projectId;
      if (!projectId) return;

      var logEl = document.getElementById('dev-cmd-log');
      if (!logEl) return;

      logEl.innerHTML = '<span class="system">Loading log...</span>\n';

      try {
        var resp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/dev/cmd/' + encodeURIComponent(runId) + '/log');
        var data = await resp.json();

        if (data.error) {
          logEl.innerHTML = '<span class="stderr">Error: ' + escapeHtml(data.message) + '</span>\n';
          return;
        }

        var html = '';
        for (var entry of data.logs) {
          var cls = entry.stream;
          html += '<span class="' + cls + '">' + escapeHtml(entry.text) + '</span>';
        }
        logEl.innerHTML = html || '<span class="system">No logs</span>';
        logEl.scrollTop = logEl.scrollHeight;
      } catch (err) {
        logEl.innerHTML = '<span class="stderr">Error: ' + escapeHtml(err.message) + '</span>\n';
      }
    }

    // =========================================================================
    // Session Log Tree Functions
    // =========================================================================

    var sessionTreeState = {
      expandedNodes: new Set(),
      selectedRunId: null
    };

    async function devLoadSessionTree() {
      var projectId = devConsoleState.projectId;
      if (!projectId) return;

      var contentEl = document.getElementById('session-tree-content');
      if (!contentEl) return;

      contentEl.innerHTML = '<div class="loading">Loading session tree...</div>';

      try {
        var resp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/session-logs/tree');
        var data = await resp.json();

        if (data.error) {
          contentEl.innerHTML = '<div class="error-message">' + escapeHtml(data.message || data.error) + '</div>';
          return;
        }

        if (!data.tree || data.tree.length === 0) {
          contentEl.innerHTML = '<div class="empty-state">No session logs yet. Run commands to generate logs.</div>';
          return;
        }

        var html = renderSessionTreeNodes(data.tree);
        contentEl.innerHTML = html;
      } catch (err) {
        contentEl.innerHTML = '<div class="error-message">Error: ' + escapeHtml(err.message) + '</div>';
      }
    }

    function renderSessionTreeNodes(nodes, level) {
      level = level || 0;
      var html = '';

      for (var node of nodes) {
        var isExpanded = sessionTreeState.expandedNodes.has(node.id);
        var isSelected = node.type === 'run' && sessionTreeState.selectedRunId === node.id;
        var statusClass = node.status ? ' status-' + node.status : '';
        var expandedClass = isExpanded ? ' expanded' : '';
        var selectedClass = isSelected ? ' selected' : '';
        var hasChildren = node.children && node.children.length > 0;

        html += '<div class="session-tree-node type-' + node.type + statusClass + expandedClass + selectedClass + '" ' +
          'data-node-id="' + escapeHtml(node.id) + '" ' +
          'data-node-type="' + node.type + '" ' +
          'onclick="devToggleSessionNode(\'' + escapeHtml(node.id) + '\', \'' + node.type + '\')">';

        html += '<span class="node-icon">' + (hasChildren ? (isExpanded ? '‚ñº' : '‚ñ∂') : '') + '</span>';
        html += '<span class="node-label">' + escapeHtml(node.label) + '</span>';

        if (node.status) {
          html += '<span class="node-status ' + node.status + '">' + node.status + '</span>';
        }

        html += '</div>';

        if (hasChildren && isExpanded) {
          html += '<div class="session-tree-children">';
          html += renderSessionTreeNodes(node.children, level + 1);
          html += '</div>';
        }
      }

      return html;
    }

    function devToggleSessionNode(nodeId, nodeType) {
      if (nodeType === 'run') {
        // For run nodes, show detail
        sessionTreeState.selectedRunId = nodeId;
        devShowRunDetail(nodeId);
        devRefreshSessionTree();
      } else {
        // For date and session nodes, toggle expansion
        if (sessionTreeState.expandedNodes.has(nodeId)) {
          sessionTreeState.expandedNodes.delete(nodeId);
        } else {
          sessionTreeState.expandedNodes.add(nodeId);
        }
        devRefreshSessionTree();
      }
    }

    function devRefreshSessionTree() {
      devLoadSessionTree();
    }

    function devCollapseAllSessions() {
      sessionTreeState.expandedNodes.clear();
      devRefreshSessionTree();
    }

    async function devShowRunDetail(runId) {
      var projectId = devConsoleState.projectId;
      if (!projectId) return;

      var detailPanel = document.getElementById('session-log-detail');
      var titleEl = document.getElementById('session-log-detail-title');
      var metaEl = document.getElementById('session-log-detail-meta');
      var contentEl = document.getElementById('session-log-detail-content');

      if (!detailPanel || !titleEl || !metaEl || !contentEl) return;

      detailPanel.style.display = 'block';
      titleEl.textContent = 'Loading...';
      metaEl.innerHTML = '';
      contentEl.innerHTML = '<span class="log-system">Loading logs...</span>';

      try {
        var resp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/session-logs/run/' + encodeURIComponent(runId));
        var data = await resp.json();

        if (data.error) {
          titleEl.textContent = 'Error';
          contentEl.innerHTML = '<span class="log-stderr">Error: ' + escapeHtml(data.message || data.error) + '</span>';
          return;
        }

        // API returns run data directly (not wrapped in data.run)
        var run = data;
        titleEl.textContent = 'Run: ' + (run.command || runId);

        // Render metadata
        var metaHtml = '';
        metaHtml += '<div class="meta-item"><span class="meta-label">Run ID</span><span class="meta-value">' + escapeHtml(run.runId) + '</span></div>';
        metaHtml += '<div class="meta-item"><span class="meta-label">Status</span><span class="meta-value">' + escapeHtml(run.status) + '</span></div>';
        metaHtml += '<div class="meta-item"><span class="meta-label">Started</span><span class="meta-value">' + escapeHtml(run.startedAt) + '</span></div>';
        if (run.endedAt) {
          metaHtml += '<div class="meta-item"><span class="meta-label">Ended</span><span class="meta-value">' + escapeHtml(run.endedAt) + '</span></div>';
        }
        if (run.exitCode !== undefined) {
          metaHtml += '<div class="meta-item"><span class="meta-label">Exit Code</span><span class="meta-value">' + run.exitCode + '</span></div>';
        }
        if (run.sessionId) {
          metaHtml += '<div class="meta-item"><span class="meta-label">Session</span><span class="meta-value">' + escapeHtml(run.sessionId) + '</span></div>';
        }
        metaEl.innerHTML = metaHtml;

        // Render logs
        if (data.logs && data.logs.length > 0) {
          var logsHtml = '';
          for (var entry of data.logs) {
            var cls = 'log-' + (entry.stream || 'stdout');
            logsHtml += '<span class="' + cls + '">' + escapeHtml(entry.text || '') + '</span>';
          }
          contentEl.innerHTML = logsHtml;
        } else {
          contentEl.innerHTML = '<span class="log-system">No logs available</span>';
        }

        contentEl.scrollTop = 0;
      } catch (err) {
        titleEl.textContent = 'Error';
        contentEl.innerHTML = '<span class="log-stderr">Error: ' + escapeHtml(err.message) + '</span>';
      }
    }

    function devCloseLogDetail() {
      var detailPanel = document.getElementById('session-log-detail');
      if (detailPanel) {
        detailPanel.style.display = 'none';
      }
      sessionTreeState.selectedRunId = null;
      devRefreshSessionTree();
    }

    // =========================================================================
    // Runbook Preset Functions
    // =========================================================================

    var runbookCommands = {
      sync: 'git pull --rebase',
      build: 'npm run build',
      test: 'npm test',
      gate: 'npm run gate:all',
      e2e: 'npm run test:e2e'
    };

    var runbookState = {
      activeRunbook: null
    };

    async function devRunRunbook(preset) {
      if (runbookState.activeRunbook) {
        alert('A runbook command is already running: ' + runbookState.activeRunbook);
        return;
      }

      var command = runbookCommands[preset];
      if (!command) {
        alert('Unknown runbook preset: ' + preset);
        return;
      }

      var projectId = devConsoleState.projectId;
      if (!projectId) return;

      var btnEl = document.getElementById('runbook-' + preset);
      var logEl = document.getElementById('dev-cmd-log');

      // Update button state
      if (btnEl) {
        btnEl.classList.add('running');
        btnEl.classList.remove('success', 'error');
      }

      runbookState.activeRunbook = preset;

      if (logEl) {
        logEl.innerHTML = '<span class="system">$ ' + escapeHtml(command) + '</span>\n<span class="system">Starting ' + preset.toUpperCase() + '...</span>\n';
      }

      try {
        var resp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/dev/cmd/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command: command, preset: preset })
        });
        var result = await resp.json();

        if (result.error) {
          if (logEl) {
            logEl.innerHTML += '<span class="stderr">Error: ' + escapeHtml(result.message) + '</span>\n';
          }
          devRunbookComplete(preset, false);
          return;
        }

        devConsoleState.activeRunId = result.runId;

        // Start polling for logs with runbook completion handling
        devStartRunbookPolling(result.runId, preset);
      } catch (err) {
        if (logEl) {
          logEl.innerHTML += '<span class="stderr">Error: ' + escapeHtml(err.message) + '</span>\n';
        }
        devRunbookComplete(preset, false);
      }
    }

    function devStartRunbookPolling(runId, preset) {
      // Clear any existing interval
      if (devConsoleState.pollInterval) {
        clearInterval(devConsoleState.pollInterval);
      }

      devConsoleState.pollInterval = setInterval(async function() {
        var projectId = devConsoleState.projectId;
        if (!projectId) return;

        try {
          var resp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/dev/cmd/' + encodeURIComponent(runId) + '/log');
          var data = await resp.json();

          if (data.error) return;

          var logEl = document.getElementById('dev-cmd-log');
          if (logEl) {
            var html = '';
            for (var entry of data.logs) {
              var cls = entry.stream;
              html += '<span class="' + cls + '">' + escapeHtml(entry.text) + '</span>';
            }
            logEl.innerHTML = html;
            logEl.scrollTop = logEl.scrollHeight;
          }

          // Stop polling if completed
          if (data.status === 'completed' || data.status === 'failed') {
            clearInterval(devConsoleState.pollInterval);
            devConsoleState.pollInterval = null;
            devConsoleState.activeRunId = null;

            var success = data.status === 'completed' && data.exitCode === 0;
            devRunbookComplete(preset, success);

            devLoadCmdHistory();
            devRefreshSessionTree();

            // Refresh git status after gate command
            if (preset === 'gate' && success) {
              devGitRefresh();
            }
          }
        } catch (err) {
          console.warn('Log polling error:', err);
        }
      }, 1000);
    }

    function devRunbookComplete(preset, success) {
      runbookState.activeRunbook = null;

      var btnEl = document.getElementById('runbook-' + preset);
      if (btnEl) {
        btnEl.classList.remove('running');
        if (success) {
          btnEl.classList.add('success');
        } else {
          btnEl.classList.add('error');
        }

        // Clear status after 5 seconds
        setTimeout(function() {
          btnEl.classList.remove('success', 'error');
        }, 5000);
      }
    }

    // =========================================================================
    // Git Functions
    // =========================================================================

    async function devGitRefresh() {
      var projectId = devConsoleState.projectId;
      if (!projectId) return;

      var statusEl = document.getElementById('dev-git-status');
      var gateStatusEl = document.getElementById('dev-git-gate-status');
      var commitBtn = document.getElementById('dev-git-commit-btn');
      var pushBtn = document.getElementById('dev-git-push-btn');

      if (statusEl) statusEl.innerHTML = '<span class="loading">Loading git status...</span>';

      try {
        // Fetch git status
        var statusResp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/dev/git/status');
        var status = await statusResp.json();

        if (status.error) {
          if (statusEl) statusEl.innerHTML = '<span class="error-message">Error: ' + escapeHtml(status.message) + '</span>';
          return;
        }

        // Build status display
        var html = '<div class="git-branch">Branch: <strong>' + escapeHtml(status.branch) + '</strong>';
        if (status.ahead > 0) html += ' <span class="git-ahead">+' + status.ahead + ' ahead</span>';
        if (status.behind > 0) html += ' <span class="git-behind">-' + status.behind + ' behind</span>';
        html += '</div>';

        if (status.staged.length > 0) {
          html += '<div class="git-staged"><strong>Staged (' + status.staged.length + '):</strong><ul>';
          for (var f of status.staged.slice(0, 10)) {
            html += '<li>' + escapeHtml(f) + '</li>';
          }
          if (status.staged.length > 10) html += '<li>... and ' + (status.staged.length - 10) + ' more</li>';
          html += '</ul></div>';
        }

        if (status.unstaged.length > 0) {
          html += '<div class="git-unstaged"><strong>Unstaged (' + status.unstaged.length + '):</strong><ul>';
          for (var f of status.unstaged.slice(0, 10)) {
            html += '<li>' + escapeHtml(f) + '</li>';
          }
          if (status.unstaged.length > 10) html += '<li>... and ' + (status.unstaged.length - 10) + ' more</li>';
          html += '</ul></div>';
        }

        if (status.untracked.length > 0) {
          html += '<div class="git-untracked"><strong>Untracked (' + status.untracked.length + '):</strong><ul>';
          for (var f of status.untracked.slice(0, 5)) {
            html += '<li>' + escapeHtml(f) + '</li>';
          }
          if (status.untracked.length > 5) html += '<li>... and ' + (status.untracked.length - 5) + ' more</li>';
          html += '</ul></div>';
        }

        if (status.staged.length === 0 && status.unstaged.length === 0 && status.untracked.length === 0) {
          html += '<div class="git-clean">Working tree clean</div>';
        }

        if (statusEl) statusEl.innerHTML = html;

        // Fetch gate status
        var gateResp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/dev/git/gateStatus');
        var gateData = await gateResp.json();

        if (gateData.hasPass) {
          if (gateStatusEl) {
            gateStatusEl.innerHTML = '<span class="gate-pass">gate:all PASS found (run: ' + escapeHtml(gateData.gatePass.runId) + ')</span>';
          }
          // Enable commit button if there are staged changes
          if (commitBtn && status.staged.length > 0) {
            commitBtn.disabled = false;
          }
          // Enable push button if ahead of remote
          if (pushBtn && status.ahead > 0) {
            pushBtn.disabled = false;
          }
        } else {
          if (gateStatusEl) {
            gateStatusEl.innerHTML = '<span class="gate-fail">No gate:all PASS found. Run "npm run gate:all" first.</span>';
          }
          if (commitBtn) commitBtn.disabled = true;
          if (pushBtn) pushBtn.disabled = true;
        }

      } catch (err) {
        if (statusEl) statusEl.innerHTML = '<span class="error-message">Error: ' + escapeHtml(err.message) + '</span>';
      }
    }

    async function devGitShowDiff(staged) {
      var projectId = devConsoleState.projectId;
      if (!projectId) return;

      var diffEl = document.getElementById('dev-git-diff');
      if (!diffEl) return;

      diffEl.style.display = 'block';
      diffEl.innerHTML = '<span class="loading">Loading diff...</span>';

      try {
        var url = '/api/projects/' + encodeURIComponent(projectId) + '/dev/git/diff';
        if (staged) url += '?staged=true';

        var resp = await fetch(url);
        var data = await resp.json();

        if (data.error) {
          diffEl.innerHTML = '<span class="error-message">Error: ' + escapeHtml(data.message) + '</span>';
          return;
        }

        if (!data.diff || data.diff.trim() === '') {
          diffEl.innerHTML = '<span class="system">No ' + (staged ? 'staged ' : '') + 'changes</span>';
        } else {
          diffEl.innerHTML = '<pre>' + escapeHtml(data.diff) + '</pre>';
        }
      } catch (err) {
        diffEl.innerHTML = '<span class="error-message">Error: ' + escapeHtml(err.message) + '</span>';
      }
    }

    async function devGitCommit() {
      var projectId = devConsoleState.projectId;
      if (!projectId) return;

      var msgInput = document.getElementById('dev-git-commit-msg');
      var resultEl = document.getElementById('dev-git-result');
      if (!msgInput || !resultEl) return;

      var message = msgInput.value.trim();
      if (!message) {
        resultEl.innerHTML = '<span class="error-message">Please enter a commit message</span>';
        return;
      }

      resultEl.innerHTML = '<span class="loading">Committing...</span>';

      try {
        var resp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/dev/git/commit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: message })
        });
        var data = await resp.json();

        if (data.error) {
          resultEl.innerHTML = '<span class="error-message">' + escapeHtml(data.error) + ': ' + escapeHtml(data.message) + '</span>';
          if (data.reason) {
            resultEl.innerHTML += '<br><span class="system">Reason: ' + escapeHtml(data.reason) + '</span>';
          }
          return;
        }

        resultEl.innerHTML = '<span class="success">Commit created: ' + escapeHtml(data.commitHash) + '</span>';
        msgInput.value = '';
        devGitRefresh();
      } catch (err) {
        resultEl.innerHTML = '<span class="error-message">Error: ' + escapeHtml(err.message) + '</span>';
      }
    }

    async function devGitPush() {
      var projectId = devConsoleState.projectId;
      if (!projectId) return;

      // Show safety confirmation
      showSafetyDialog(
        'Push to Remote?',
        'You are about to push commits to the remote repository. ' +
        'Make sure gate:all has passed before pushing. ' +
        'This action cannot be easily undone.',
        'Push',
        function() {
          doGitPush(projectId);
        }
      );
    }

    async function doGitPush(projectId) {
      var resultEl = document.getElementById('dev-git-result');
      if (!resultEl) return;

      resultEl.innerHTML = '<span class="loading">Pushing...</span>';

      try {
        var resp = await fetch('/api/projects/' + encodeURIComponent(projectId) + '/dev/git/push', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        var data = await resp.json();

        if (data.error) {
          resultEl.innerHTML = '<span class="error-message">' + escapeHtml(data.error) + ': ' + escapeHtml(data.message) + '</span>';
          if (data.reason) {
            resultEl.innerHTML += '<br><span class="system">Reason: ' + escapeHtml(data.reason) + '</span>';
          }
          return;
        }

        resultEl.innerHTML = '<span class="success">Pushed ' + data.pushed + ' commit(s) successfully!</span>';
        devGitRefresh();
      } catch (err) {
        resultEl.innerHTML = '<span class="error-message">Error: ' + escapeHtml(err.message) + '</span>';
      }
    }

    // =========================================================================
    // End Dev Console Functions
    // =========================================================================

    // Initial load
    loadNamespaces();
    startRunnerRefresh();
    router();
  </script>
</body>
</html>
