<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PM Orchestrator Runner - Web UI</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: #2563eb;
      color: white;
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 1.3rem;
      font-weight: 600;
      cursor: pointer;
    }

    .namespace-badge {
      background: rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 12px;
      font-family: monospace;
    }

    .namespace-badge.auto-derived {
      background: rgba(34, 197, 94, 0.3);
    }

    .namespace-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .namespace-selector select {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-family: monospace;
      cursor: pointer;
    }

    .namespace-selector select:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.5);
    }

    .namespace-selector select option {
      background: #2563eb;
      color: white;
    }

    .runner-status {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .runner-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .runner-dot.alive {
      background: #22c55e;
      box-shadow: 0 0 4px #22c55e;
    }

    .runner-dot.dead {
      background: #ef4444;
    }

    .runner-count {
      margin-left: 4px;
    }

    nav {
      display: flex;
      gap: 16px;
    }

    nav a {
      color: rgba(255, 255, 255, 0.9);
      text-decoration: none;
      font-size: 0.9rem;
      padding: 8px 16px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    nav a:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    nav a.active {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .page-header h2 {
      font-size: 1.5rem;
      color: #1f2937;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #e5e7eb;
      color: #374151;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.2s;
    }

    .back-btn:hover {
      background: #d1d5db;
    }

    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 16px;
    }

    .card h3 {
      font-size: 1.1rem;
      margin-bottom: 16px;
      color: #1f2937;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 8px;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .list-item:hover {
      background: #f9fafb;
      border-color: #2563eb;
      transform: translateX(4px);
    }

    .list-item-main {
      flex: 1;
    }

    .list-item-title {
      font-weight: 500;
      color: #111827;
    }

    .list-item-meta {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 4px;
    }

    .list-item-arrow {
      color: #9ca3af;
      font-size: 1.2rem;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-right: 8px;
    }

    .badge-queued {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-running {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge-complete {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-error {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-cancelled {
      background: #e5e7eb;
      color: #4b5563;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: #374151;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }

    .btn {
      display: inline-block;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-primary:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .detail-item {
      background: #f9fafb;
      padding: 12px;
      border-radius: 6px;
    }

    .detail-item label {
      display: block;
      font-size: 0.8rem;
      color: #6b7280;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .detail-item value {
      display: block;
      font-weight: 500;
      color: #1f2937;
      word-break: break-all;
    }

    .prompt-box {
      background: #f9fafb;
      padding: 16px;
      border-radius: 6px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      word-break: break-word;
      border-left: 4px solid #2563eb;
    }

    .log-section {
      margin-top: 20px;
    }

    .log-entry {
      padding: 12px;
      border-left: 3px solid #e5e7eb;
      margin-bottom: 8px;
      background: #fafafa;
    }

    .log-entry.user-input {
      border-left-color: #2563eb;
    }

    .log-entry.task-started {
      border-left-color: #f59e0b;
    }

    .log-entry.task-completed {
      border-left-color: #10b981;
    }

    .log-entry.error {
      border-left-color: #ef4444;
      background: #fef2f2;
    }

    .log-time {
      font-size: 0.75rem;
      color: #6b7280;
      font-family: monospace;
    }

    .log-type {
      font-size: 0.8rem;
      font-weight: 600;
      color: #374151;
      margin: 4px 0;
    }

    .log-content {
      font-size: 0.9rem;
      color: #1f2937;
      white-space: pre-wrap;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .empty-state p {
      margin-bottom: 16px;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    .success-message {
      background: #d1fae5;
      color: #065f46;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    .refresh-btn {
      background: none;
      border: 1px solid #d1d5db;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      color: #6b7280;
    }

    .refresh-btn:hover {
      background: #f3f4f6;
    }

    .action-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    @media (max-width: 600px) {
      .container {
        padding: 12px;
      }

      header {
        padding: 12px 16px;
      }

      .header-content {
        flex-direction: column;
        gap: 12px;
      }

      header h1 {
        font-size: 1.1rem;
      }

      nav {
        width: 100%;
        justify-content: center;
      }

      .card {
        padding: 16px;
      }

      .page-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
      }

      .detail-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1 onclick="navigate('/')">PM Orchestrator Runner</h1>
      <div class="namespace-selector" id="namespace-selector" style="display: none;">
        <select id="namespace-select" onchange="onNamespaceChange(this.value)">
          <!-- Populated by JavaScript -->
        </select>
        <div class="runner-status" id="runner-status">
          <span class="runner-dot" id="runner-dot"></span>
          <span id="runner-text">-</span>
        </div>
      </div>
      <nav id="main-nav">
        <a href="/dashboard" data-nav="dashboard">Dashboard</a>
        <a href="/" data-nav="home">Task Groups</a>
        <a href="/activity" data-nav="activity">Activity</a>
        <a href="/new" data-nav="new">+ New</a>
        <a href="/agent" data-nav="agent">Agent</a>
        <a href="/settings" data-nav="settings">Settings</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <div id="app">
      <div class="loading">Loading</div>
    </div>
  </main>

  <script>
    const app = document.getElementById('app');
    let currentPath = '/';

    // API helper with namespace support
    async function api(path, options = {}) {
      // Add namespace query parameter if currentNamespace is set
      let url = `/api${path}`;
      if (typeof currentNamespace !== 'undefined' && currentNamespace) {
        const separator = path.includes('?') ? '&' : '?';
        url = `${url}${separator}namespace=${encodeURIComponent(currentNamespace)}`;
      }
      const response = await fetch(url, {
        headers: { 'Content-Type': 'application/json' },
        ...options,
      });
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.message || 'Request failed');
      }
      return data;
    }

    // Format date
    function formatDate(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleString('ja-JP', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
      });
    }

    // Format full date
    function formatFullDate(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
      });
    }

    // Get status badge class
    function getStatusBadgeClass(status) {
      const map = {
        'QUEUED': 'badge-queued',
        'RUNNING': 'badge-running',
        'COMPLETE': 'badge-complete',
        'ERROR': 'badge-error',
        'CANCELLED': 'badge-cancelled',
      };
      return map[status] || 'badge-queued';
    }

    // Escape HTML
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Update nav active state
    function updateNav(path) {
      document.querySelectorAll('#main-nav a').forEach(link => {
        link.classList.remove('active');
        if (path === '/dashboard' && link.dataset.nav === 'dashboard') {
          link.classList.add('active');
        } else if (path === '/' && link.dataset.nav === 'home') {
          link.classList.add('active');
        } else if (path === '/activity' && link.dataset.nav === 'activity') {
          link.classList.add('active');
        } else if (path === '/new' && link.dataset.nav === 'new') {
          link.classList.add('active');
        } else if (path === '/agent' && link.dataset.nav === 'agent') {
          link.classList.add('active');
        } else if (path === '/settings' && link.dataset.nav === 'settings') {
          link.classList.add('active');
        } else if (path.startsWith('/projects/')) {
          link.classList.add('active');
        } else if (path.startsWith('/runs/')) {
          link.classList.add('active');
        }
      });
    }

    // Render task group list (Home)
    async function renderTaskGroupList() {
      app.innerHTML = '<div class="loading">Loading</div>';

      try {
        const data = await api('/task-groups');
        const groups = data.task_groups || [];

        if (groups.length === 0) {
          app.innerHTML = `
            <div class="page-header">
              <h2>Task Groups</h2>
              <button class="refresh-btn" onclick="renderTaskGroupList()">Refresh</button>
            </div>
            <div class="card">
              <div class="empty-state">
                <p>No task groups yet.</p>
                <button class="btn btn-primary" onclick="navigate('/new')">+ Create New Command</button>
              </div>
            </div>
          `;
          return;
        }

        const items = groups.map(g => `
          <div class="list-item" onclick="navigate('/task-groups/${encodeURIComponent(g.task_group_id)}')">
            <div class="list-item-main">
              <div class="list-item-title">${escapeHtml(g.task_group_id)}</div>
              <div class="list-item-meta">
                ${g.task_count} task(s) | Created: ${formatDate(g.created_at)}
              </div>
            </div>
            <span class="list-item-arrow">›</span>
          </div>
        `).join('');

        app.innerHTML = `
          <div class="page-header">
            <h2>Task Groups</h2>
            <button class="refresh-btn" onclick="renderTaskGroupList()">Refresh</button>
          </div>
          <div class="card">
            ${items}
          </div>
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="page-header">
            <h2>Task Groups</h2>
          </div>
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <button class="btn btn-secondary" onclick="renderTaskGroupList()">Retry</button>
          </div>
        `;
      }
    }

    // Render task list for a task group
    async function renderTaskList(taskGroupId) {
      app.innerHTML = '<div class="loading">Loading</div>';

      try {
        const data = await api(`/task-groups/${encodeURIComponent(taskGroupId)}/tasks`);
        const tasks = data.tasks || [];

        const backBtn = `<a href="/" class="back-btn" onclick="event.preventDefault(); navigate('/')">← Back to Groups</a>`;

        if (tasks.length === 0) {
          app.innerHTML = `
            <div class="page-header">
              <h2>${escapeHtml(taskGroupId)}</h2>
              <div class="action-bar">
                ${backBtn}
                <button class="refresh-btn" onclick="renderTaskList('${escapeHtml(taskGroupId)}')">Refresh</button>
              </div>
            </div>
            <div class="card">
              <div class="empty-state">
                <p>No tasks in this group yet.</p>
                <button class="btn btn-primary" onclick="navigate('/new?group=${encodeURIComponent(taskGroupId)}')">+ Add Task</button>
              </div>
            </div>
          `;
          return;
        }

        const items = tasks.map(t => `
          <div class="list-item" onclick="navigate('/tasks/${encodeURIComponent(t.task_id)}')">
            <div class="list-item-main">
              <span class="badge ${getStatusBadgeClass(t.status)}">${t.status}</span>
              <span class="list-item-title">${escapeHtml(t.task_id)}</span>
              <div class="list-item-meta">
                ${escapeHtml(t.prompt.substring(0, 80))}${t.prompt.length > 80 ? '...' : ''}
              </div>
              <div class="list-item-meta">
                ${formatDate(t.created_at)}
              </div>
            </div>
            <span class="list-item-arrow">›</span>
          </div>
        `).join('');

        app.innerHTML = `
          <div class="page-header">
            <h2>${escapeHtml(taskGroupId)}</h2>
            <div class="action-bar">
              ${backBtn}
              <button class="refresh-btn" onclick="renderTaskList('${escapeHtml(taskGroupId)}')">Refresh</button>
            </div>
          </div>
          <div class="card">
            <h3>Tasks (${tasks.length})</h3>
            ${items}
          </div>
          <div style="text-align: center; margin-top: 16px;">
            <button class="btn btn-primary" onclick="navigate('/new?group=${encodeURIComponent(taskGroupId)}')">+ Add Task to This Group</button>
          </div>
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="page-header">
            <h2>${escapeHtml(taskGroupId)}</h2>
            <a href="/" class="back-btn" onclick="event.preventDefault(); navigate('/')">← Back</a>
          </div>
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <button class="btn btn-secondary" onclick="renderTaskList('${escapeHtml(taskGroupId)}')">Retry</button>
          </div>
        `;
      }
    }

    // Render task detail with logs
    async function renderTaskDetail(taskId) {
      app.innerHTML = '<div class="loading">Loading</div>';

      try {
        const task = await api(`/tasks/${encodeURIComponent(taskId)}`);

        const backBtn = `<a href="/task-groups/${encodeURIComponent(task.task_group_id)}" class="back-btn" onclick="event.preventDefault(); navigate('/task-groups/${encodeURIComponent(task.task_group_id)}')">← Back to Tasks</a>`;

        let errorSection = '';
        if (task.error_message) {
          errorSection = `
            <div class="card">
              <h3>Error</h3>
              <div class="log-entry error">
                <div class="log-content">${escapeHtml(task.error_message)}</div>
              </div>
            </div>
          `;
        }

        // Log entries (simulated based on task status)
        let logEntries = '';
        if (task.status !== 'QUEUED') {
          logEntries = `
            <div class="card log-section">
              <h3>Execution Log</h3>
              <div class="log-entry user-input">
                <div class="log-time">${formatFullDate(task.created_at)}</div>
                <div class="log-type">USER INPUT</div>
                <div class="log-content">${escapeHtml(task.prompt)}</div>
              </div>
              ${task.status === 'RUNNING' ? `
              <div class="log-entry task-started">
                <div class="log-time">${formatFullDate(task.updated_at)}</div>
                <div class="log-type">TASK STARTED</div>
                <div class="log-content">Task is currently running...</div>
              </div>
              ` : ''}
              ${task.status === 'COMPLETE' ? `
              <div class="log-entry task-completed">
                <div class="log-time">${formatFullDate(task.updated_at)}</div>
                <div class="log-type">TASK COMPLETED</div>
                <div class="log-content">Task completed successfully.</div>
              </div>
              ` : ''}
              ${task.status === 'ERROR' ? `
              <div class="log-entry error">
                <div class="log-time">${formatFullDate(task.updated_at)}</div>
                <div class="log-type">TASK ERROR</div>
                <div class="log-content">${escapeHtml(task.error_message || 'Unknown error')}</div>
              </div>
              ` : ''}
              ${task.status === 'CANCELLED' ? `
              <div class="log-entry" style="border-left-color: #6b7280;">
                <div class="log-time">${formatFullDate(task.updated_at)}</div>
                <div class="log-type">TASK CANCELLED</div>
                <div class="log-content">Task was cancelled by user.</div>
              </div>
              ` : ''}
            </div>
          `;
        }

        app.innerHTML = `
          <div class="page-header">
            <h2>Task Detail</h2>
            <div class="action-bar">
              ${backBtn}
              <button class="refresh-btn" onclick="renderTaskDetail('${escapeHtml(taskId)}')">Refresh</button>
            </div>
          </div>

          <div class="card">
            <h3>Status</h3>
            <div style="display: flex; align-items: center; gap: 16px;">
              <span class="badge ${getStatusBadgeClass(task.status)}" style="font-size: 1rem; padding: 8px 16px;">${task.status}</span>
              ${(task.status === 'QUEUED' || task.status === 'RUNNING') ? `
                <button class="btn btn-secondary" onclick="cancelTask('${escapeHtml(task.task_id)}')" style="padding: 8px 16px;">Cancel Task</button>
              ` : ''}
            </div>
          </div>

          <div class="card">
            <h3>Details</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Task ID</label>
                <value>${escapeHtml(task.task_id)}</value>
              </div>
              <div class="detail-item">
                <label>Task Group</label>
                <value><a href="/task-groups/${encodeURIComponent(task.task_group_id)}" onclick="event.preventDefault(); navigate('/task-groups/${encodeURIComponent(task.task_group_id)}')">${escapeHtml(task.task_group_id)}</a></value>
              </div>
              <div class="detail-item">
                <label>Session ID</label>
                <value>${escapeHtml(task.session_id)}</value>
              </div>
              <div class="detail-item">
                <label>Created</label>
                <value>${formatFullDate(task.created_at)}</value>
              </div>
              <div class="detail-item">
                <label>Updated</label>
                <value>${formatFullDate(task.updated_at)}</value>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Prompt</h3>
            <div class="prompt-box">${escapeHtml(task.prompt)}</div>
          </div>

          ${errorSection}
          ${logEntries}
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="page-header">
            <h2>Task Detail</h2>
            <a href="/" class="back-btn" onclick="event.preventDefault(); navigate('/')">← Back</a>
          </div>
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <button class="btn btn-secondary" onclick="renderTaskDetail('${escapeHtml(taskId)}')">Retry</button>
          </div>
        `;
      }
    }

    // Render new command form
    async function renderNewCommandForm(prefilledGroup = '') {
      let taskGroups = [];
      try {
        const data = await api('/task-groups');
        taskGroups = data.task_groups || [];
      } catch (error) {
        // Ignore - we can still create new task groups
      }

      const options = taskGroups.length > 0
        ? taskGroups.map(g => `<option value="${escapeHtml(g.task_group_id)}">${escapeHtml(g.task_group_id)}</option>`).join('')
        : '';

      const backBtn = `<a href="/" class="back-btn" onclick="event.preventDefault(); navigate('/')">← Back to Groups</a>`;

      app.innerHTML = `
        <div class="page-header">
          <h2>New Command</h2>
          ${backBtn}
        </div>

        <div class="card">
          <form id="new-command-form">
            <div class="form-group">
              <label for="task_group_id">Task Group ID</label>
              <input type="text" id="task_group_id" name="task_group_id"
                placeholder="Enter new or select existing"
                list="task-groups-list"
                value="${escapeHtml(prefilledGroup)}"
                required>
              <datalist id="task-groups-list">
                ${options}
              </datalist>
            </div>

            <div class="form-group">
              <label for="prompt">Command / Prompt</label>
              <textarea id="prompt" name="prompt"
                placeholder="Enter your command or prompt here..." required></textarea>
            </div>

            <div id="form-message"></div>

            <button type="submit" class="btn btn-primary" id="submit-btn">Submit to Queue</button>
          </form>
        </div>

        <div class="card" style="background: #fffbeb; border-left: 4px solid #f59e0b;">
          <p style="color: #92400e; font-size: 0.9rem;">
            <strong>Note:</strong> This adds a task to the queue. The Runner will pick it up and execute it automatically.
          </p>
        </div>
      `;

      // Form submission
      document.getElementById('new-command-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const submitBtn = document.getElementById('submit-btn');
        const messageDiv = document.getElementById('form-message');

        const taskGroupId = form.task_group_id.value.trim();
        const prompt = form.prompt.value.trim();

        if (!taskGroupId || !prompt) {
          messageDiv.innerHTML = '<div class="error-message">Please fill in all fields.</div>';
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        try {
          const result = await api('/tasks', {
            method: 'POST',
            body: JSON.stringify({ task_group_id: taskGroupId, prompt }),
          });

          messageDiv.innerHTML = `
            <div class="success-message">
              Task queued successfully!<br>
              Task ID: <strong>${escapeHtml(result.task_id)}</strong>
            </div>
          `;

          // Clear prompt only
          form.prompt.value = '';

          // Navigate to task detail after delay
          setTimeout(() => {
            navigate(`/tasks/${encodeURIComponent(result.task_id)}`);
          }, 1000);
        } catch (error) {
          messageDiv.innerHTML = `<div class="error-message">Error: ${escapeHtml(error.message)}</div>`;
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit to Queue';
        }
      });
    }

    // Cancel task
    async function cancelTask(taskId) {
      if (!confirm('Are you sure you want to cancel this task?')) {
        return;
      }

      try {
        const result = await fetch(`/api/tasks/${encodeURIComponent(taskId)}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'CANCELLED' }),
        });

        const data = await result.json();

        if (!result.ok) {
          alert(`Error: ${data.message || 'Failed to cancel task'}`);
          return;
        }

        // Refresh the task detail page
        renderTaskDetail(taskId);
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Settings state
    let settingsTab = 'global'; // 'global' or 'project'
    let settingsData = {
      apiKeys: { anthropic: null, openai: null },
      globalSettings: { llm: {}, preferences: {}, maxTokens: 4096, temperature: 0.7 },
      projectOverrides: {},
      namespace: ''
    };

    // Render Settings page - dispatcher based on current tab
    async function renderSettings() {
      app.innerHTML = '<div class="loading">Loading Settings...</div>';

      try {
        // Fetch all settings data in parallel
        const [apiKeyRes, projectRes, namespaceRes] = await Promise.all([
          fetch('/api/settings/api-key/status'),
          fetch('/api/settings/project'),
          fetch('/api/namespace')
        ]);

        settingsData.apiKeys = await apiKeyRes.json();
        const projectData = await projectRes.json();
        const namespaceData = await namespaceRes.json();
        settingsData.namespace = namespaceData.namespace;
        settingsData.globalSettings = {
          llm: projectData.llm || { provider: 'anthropic', model: 'claude-sonnet-4-20250514' },
          preferences: projectData.preferences || {},
          maxTokens: 4096,
          temperature: 0.7
        };
        // Project overrides: fields explicitly set for this project
        settingsData.projectOverrides = projectData.overrides || {};

        // Render based on current tab
        if (settingsTab === 'global') {
          renderSettingsGlobal();
        } else {
          renderSettingsProject();
        }
      } catch (error) {
        app.innerHTML = `
          <div class="card">
            <h2>Error Loading Settings</h2>
            <p>${escapeHtml(error.message)}</p>
            <button class="btn btn-primary" onclick="renderSettings()" style="margin-top: 16px;">Retry</button>
          </div>
        `;
      }
    }

    // Render GLOBAL settings tab
    function renderSettingsGlobal() {
      const { apiKeys, globalSettings, namespace } = settingsData;

      const renderProviderStatus = (provider, status) => {
        const configured = status?.configured === true;
        const masked = status?.masked || '';
        const statusClass = configured ? 'status-configured' : 'status-not-configured';
        const statusText = configured ? 'Configured' : 'Not Configured';
        const providerId = provider.toLowerCase();

        return `
          <div class="settings-provider" data-testid="settings-provider-${providerId}">
            <div class="provider-header">
              <span class="provider-name">${escapeHtml(provider)}</span>
              <span class="provider-status ${statusClass}">${statusText}</span>
            </div>
            ${configured ? `<div class="provider-masked">Key: ${escapeHtml(masked)}</div>` : ''}
            <div class="provider-actions">
              <input type="password" id="apikey-${providerId}" placeholder="Enter API Key" class="settings-input" />
              <button class="btn btn-sm" onclick="saveApiKey('${providerId}')">Save ${provider} Key</button>
              ${configured ? `<button class="btn btn-sm btn-danger" onclick="deleteApiKey('${providerId}')">Delete</button>` : ''}
            </div>
          </div>
        `;
      };

      app.innerHTML = `
        <div data-testid="settings-root" data-scope="global" class="settings-page">
          <div class="page-header">
            <h2>Settings</h2>
            <span class="project-indicator">Project: ${escapeHtml(namespace)}</span>
            <button class="refresh-btn" onclick="renderSettings()">Refresh</button>
          </div>

          <!-- Tabs -->
          <div data-testid="settings-tabs" class="settings-tabs">
            <button data-testid="settings-tab-global" class="tab-btn ${settingsTab === 'global' ? 'active' : ''}" onclick="switchSettingsTab('global')">Global</button>
            <button data-testid="settings-tab-project" class="tab-btn ${settingsTab === 'project' ? 'active' : ''}" onclick="switchSettingsTab('project')">Project</button>
          </div>

          <!-- Global: Environment Info -->
          <div data-testid="settings-envinfo" class="card settings-section">
            <h3>Environment Info</h3>
            <div class="env-info-grid">
              <div class="env-item">
                <label>Namespace:</label>
                <span>${escapeHtml(namespace)}</span>
              </div>
              <div class="env-item">
                <label>Scope:</label>
                <span>Global (applies to all projects)</span>
              </div>
            </div>
          </div>

          <!-- Global: API Keys (ONLY in Global tab) -->
          <div data-testid="settings-apikeys" class="card settings-section">
            <h3>API Keys</h3>
            <p class="settings-hint">API keys are stored globally and shared across all projects.</p>
            <div class="settings-list">
              ${renderProviderStatus('Anthropic', apiKeys.anthropic)}
              ${renderProviderStatus('OpenAI', apiKeys.openai)}
            </div>
          </div>

          <!-- Global: LLM Configuration -->
          <div class="card settings-section">
            <h3>Default LLM Configuration</h3>
            <p class="settings-hint">These are the default values used when no project override is set.</p>
            <div class="settings-form">
              <div class="form-group">
                <label for="settings-provider" data-testid="settings-provider-label">Provider</label>
                <select id="settings-provider" data-testid="settings-provider" class="settings-select">
                  <option value="anthropic" ${globalSettings.llm?.provider === 'anthropic' ? 'selected' : ''}>Anthropic</option>
                  <option value="openai" ${globalSettings.llm?.provider === 'openai' ? 'selected' : ''}>OpenAI</option>
                </select>
              </div>
              <div class="form-group">
                <label for="settings-model" data-testid="settings-model-label">Model</label>
                <select id="settings-model" data-testid="settings-model" class="settings-select">
                  <option value="claude-sonnet-4-20250514" ${globalSettings.llm?.model === 'claude-sonnet-4-20250514' ? 'selected' : ''}>Claude Sonnet 4</option>
                  <option value="claude-3-5-sonnet-20241022" ${globalSettings.llm?.model === 'claude-3-5-sonnet-20241022' ? 'selected' : ''}>Claude 3.5 Sonnet</option>
                  <option value="gpt-4o" ${globalSettings.llm?.model === 'gpt-4o' ? 'selected' : ''}>GPT-4o</option>
                  <option value="gpt-4-turbo" ${globalSettings.llm?.model === 'gpt-4-turbo' ? 'selected' : ''}>GPT-4 Turbo</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Global: Generation Parameters -->
          <div class="card settings-section">
            <h3>Default Generation Parameters</h3>
            <div class="settings-form">
              <div class="form-group">
                <label for="settings-max-tokens" data-testid="settings-max-tokens-label">Max Tokens</label>
                <input type="number" id="settings-max-tokens" data-testid="settings-max-tokens" class="settings-input" value="${globalSettings.maxTokens}" min="1" max="128000" />
              </div>
              <div class="form-group">
                <label for="settings-temperature" data-testid="settings-temperature-label">Temperature</label>
                <input type="number" id="settings-temperature" data-testid="settings-temperature" class="settings-input" value="${globalSettings.temperature}" min="0" max="2" step="0.1" />
              </div>
            </div>
          </div>

          <!-- Global: Save Buttons -->
          <div class="settings-actions">
            <button class="btn btn-primary" onclick="saveGlobalSettings()">Save Global Settings</button>
            <button class="btn btn-secondary" onclick="resetSettings()">Reset to Defaults</button>
          </div>
        </div>
        ${getSettingsStyles()}
      `;
    }

    // Render PROJECT settings tab (overrides)
    function renderSettingsProject() {
      const { globalSettings, projectOverrides, namespace } = settingsData;

      // Helper to render override status badge
      const overrideBadge = (fieldName) => {
        const isOverridden = projectOverrides && projectOverrides[fieldName] !== undefined;
        if (isOverridden) {
          return '<span class="override-badge overridden">Overridden</span>';
        }
        return '<span class="override-badge inherited">Inherited (Global)</span>';
      };

      // Get effective value (override or global default)
      const getEffectiveValue = (fieldName, globalValue) => {
        if (projectOverrides && projectOverrides[fieldName] !== undefined) {
          return projectOverrides[fieldName];
        }
        return globalValue;
      };

      app.innerHTML = `
        <div data-testid="settings-root" data-scope="project" class="settings-page">
          <div class="page-header">
            <h2>Settings</h2>
            <span class="project-indicator">Project: ${escapeHtml(namespace)}</span>
            <button class="refresh-btn" onclick="renderSettings()">Refresh</button>
          </div>

          <!-- Tabs -->
          <div data-testid="settings-tabs" class="settings-tabs">
            <button data-testid="settings-tab-global" class="tab-btn ${settingsTab === 'global' ? 'active' : ''}" onclick="switchSettingsTab('global')">Global</button>
            <button data-testid="settings-tab-project" class="tab-btn ${settingsTab === 'project' ? 'active' : ''}" onclick="switchSettingsTab('project')">Project</button>
          </div>

          <!-- Project: Header with namespace -->
          <div data-testid="settings-project-overrides" class="card settings-section project-overrides-card">
            <h3>Project Overrides</h3>
            <p class="settings-hint">Override global settings for this project only. Unchecked fields inherit from Global settings.</p>
            <div class="project-namespace-info">
              <strong>Namespace:</strong> <code>${escapeHtml(namespace)}</code>
            </div>
          </div>

          <!-- Project: API Keys info (read-only, no edit) -->
          <div class="card settings-section api-keys-info">
            <h3>API Keys</h3>
            <p class="settings-hint-readonly">API keys are managed in the Global tab. Projects use the globally configured keys.</p>
            <div class="global-keys-indicator">Global keys are used for this project</div>
          </div>

          <!-- Project: LLM Override -->
          <div class="card settings-section">
            <h3>LLM Configuration Override</h3>
            <div class="settings-form">
              <div class="form-group override-group">
                <div class="override-header">
                  <input type="checkbox" id="override-provider" ${projectOverrides?.provider !== undefined ? 'checked' : ''} onchange="toggleOverride('provider')" />
                  <label for="override-provider">Override Provider</label>
                  ${overrideBadge('provider')}
                </div>
                <select id="project-provider" class="settings-select ${projectOverrides?.provider === undefined ? 'inherited' : ''}" ${projectOverrides?.provider === undefined ? 'disabled' : ''}>
                  <option value="anthropic" ${getEffectiveValue('provider', globalSettings.llm?.provider) === 'anthropic' ? 'selected' : ''}>Anthropic</option>
                  <option value="openai" ${getEffectiveValue('provider', globalSettings.llm?.provider) === 'openai' ? 'selected' : ''}>OpenAI</option>
                </select>
              </div>
              <div class="form-group override-group">
                <div class="override-header">
                  <input type="checkbox" id="override-model" ${projectOverrides?.model !== undefined ? 'checked' : ''} onchange="toggleOverride('model')" />
                  <label for="override-model">Override Model</label>
                  ${overrideBadge('model')}
                </div>
                <select id="project-model" class="settings-select ${projectOverrides?.model === undefined ? 'inherited' : ''}" ${projectOverrides?.model === undefined ? 'disabled' : ''}>
                  <option value="claude-sonnet-4-20250514" ${getEffectiveValue('model', globalSettings.llm?.model) === 'claude-sonnet-4-20250514' ? 'selected' : ''}>Claude Sonnet 4</option>
                  <option value="claude-3-5-sonnet-20241022" ${getEffectiveValue('model', globalSettings.llm?.model) === 'claude-3-5-sonnet-20241022' ? 'selected' : ''}>Claude 3.5 Sonnet</option>
                  <option value="gpt-4o" ${getEffectiveValue('model', globalSettings.llm?.model) === 'gpt-4o' ? 'selected' : ''}>GPT-4o</option>
                  <option value="gpt-4-turbo" ${getEffectiveValue('model', globalSettings.llm?.model) === 'gpt-4-turbo' ? 'selected' : ''}>GPT-4 Turbo</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Project: Generation Parameters Override -->
          <div class="card settings-section">
            <h3>Generation Parameters Override</h3>
            <div class="settings-form">
              <div class="form-group override-group">
                <div class="override-header">
                  <input type="checkbox" id="override-maxTokens" ${projectOverrides?.maxTokens !== undefined ? 'checked' : ''} onchange="toggleOverride('maxTokens')" />
                  <label for="override-maxTokens">Override Max Tokens</label>
                  ${overrideBadge('maxTokens')}
                </div>
                <input type="number" id="project-maxTokens" class="settings-input ${projectOverrides?.maxTokens === undefined ? 'inherited' : ''}" value="${getEffectiveValue('maxTokens', globalSettings.maxTokens)}" min="1" max="128000" ${projectOverrides?.maxTokens === undefined ? 'disabled' : ''} />
              </div>
              <div class="form-group override-group">
                <div class="override-header">
                  <input type="checkbox" id="override-temperature" ${projectOverrides?.temperature !== undefined ? 'checked' : ''} onchange="toggleOverride('temperature')" />
                  <label for="override-temperature">Override Temperature</label>
                  ${overrideBadge('temperature')}
                </div>
                <input type="number" id="project-temperature" class="settings-input ${projectOverrides?.temperature === undefined ? 'inherited' : ''}" value="${getEffectiveValue('temperature', globalSettings.temperature)}" min="0" max="2" step="0.1" ${projectOverrides?.temperature === undefined ? 'disabled' : ''} />
              </div>
            </div>
          </div>

          <!-- Project: Save Buttons -->
          <div class="settings-actions">
            <button class="btn btn-primary" onclick="saveProjectSettings()">Save Project Overrides</button>
            <button class="btn btn-secondary" onclick="clearProjectOverrides()">Clear All Overrides</button>
          </div>
        </div>
        ${getSettingsStyles()}
      `;
    }

    // Settings styles (shared)
    function getSettingsStyles() {
      return `
        <style>
          .settings-page { max-width: 800px; }
          .project-indicator { font-size: 0.9rem; color: #6b7280; margin-left: 16px; }
          .settings-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
          .tab-btn { padding: 8px 16px; border: 1px solid #e5e7eb; background: #fff; border-radius: 6px; cursor: pointer; font-weight: 500; }
          .tab-btn.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }
          .settings-section { margin-bottom: 16px; }
          .settings-hint { font-size: 0.85rem; color: #6b7280; margin-bottom: 12px; }
          .settings-hint-readonly { font-size: 0.85rem; color: #9ca3af; font-style: italic; margin-bottom: 12px; }
          .env-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
          .env-item { display: flex; flex-direction: column; gap: 4px; }
          .env-item label { font-size: 0.85rem; color: #6b7280; font-weight: 500; }
          .env-item span { font-family: monospace; font-size: 0.9rem; word-break: break-all; }
          .settings-form { display: flex; flex-direction: column; gap: 16px; }
          .form-group { display: flex; flex-direction: column; gap: 6px; }
          .form-group label { font-size: 0.9rem; font-weight: 500; }
          .settings-input, .settings-select { padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.95rem; }
          .settings-select { background: #fff; }
          .settings-input.inherited, .settings-select.inherited { background: #f3f4f6; color: #9ca3af; }
          .checkbox-group { flex-direction: row; align-items: center; gap: 8px; }
          .checkbox-group input { width: 18px; height: 18px; }
          .settings-list { display: flex; flex-direction: column; gap: 16px; margin-top: 16px; }
          .settings-provider { padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; }
          .provider-header { display: flex; justify-content: space-between; align-items: center; }
          .provider-name { font-weight: 600; font-size: 1rem; }
          .provider-status { padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 500; }
          .status-configured { background: #dcfce7; color: #166534; }
          .status-not-configured { background: #fee2e2; color: #991b1b; }
          .provider-masked { margin-top: 8px; font-family: monospace; font-size: 0.85rem; color: #6b7280; }
          .provider-actions { display: flex; gap: 8px; margin-top: 12px; align-items: center; flex-wrap: wrap; }
          .provider-actions input { flex: 1; min-width: 200px; }
          .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
          .btn-danger { background: #ef4444; color: #fff; }
          .btn-danger:hover { background: #dc2626; }
          .settings-actions { display: flex; gap: 12px; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e5e7eb; }
          /* Project overrides specific */
          .project-overrides-card { background: #fffbeb; border-left: 4px solid #f59e0b; }
          .project-namespace-info { margin-top: 12px; padding: 8px 12px; background: #fef3c7; border-radius: 6px; font-size: 0.9rem; }
          .project-namespace-info code { background: #fde68a; padding: 2px 6px; border-radius: 4px; }
          .api-keys-info { background: #f3f4f6; }
          .global-keys-indicator { padding: 12px; background: #e5e7eb; border-radius: 6px; color: #6b7280; font-size: 0.9rem; text-align: center; }
          .override-group { padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; }
          .override-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
          .override-header input[type="checkbox"] { width: 18px; height: 18px; }
          .override-badge { padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 500; margin-left: auto; }
          .override-badge.inherited { background: #e5e7eb; color: #6b7280; }
          .override-badge.overridden { background: #dbeafe; color: #1e40af; }
        </style>
      `;
    }

    // Toggle override checkbox
    function toggleOverride(fieldName) {
      const checkbox = document.getElementById(`override-${fieldName}`);
      const input = document.getElementById(`project-${fieldName}`);
      if (!checkbox || !input) return;

      if (checkbox.checked) {
        input.disabled = false;
        input.classList.remove('inherited');
      } else {
        input.disabled = true;
        input.classList.add('inherited');
      }
    }

    // Switch settings tab
    function switchSettingsTab(tab) {
      settingsTab = tab;
      // Re-render with already loaded data
      if (tab === 'global') {
        renderSettingsGlobal();
      } else {
        renderSettingsProject();
      }
    }

    // Save API key
    async function saveApiKey(provider) {
      const input = document.getElementById(`apikey-${provider}`);
      const apiKey = input?.value?.trim();
      if (!apiKey) {
        alert('Please enter an API key');
        return;
      }

      try {
        const response = await fetch('/api/settings/api-key', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider, api_key: apiKey })
        });
        const data = await response.json();
        if (data.success) {
          renderSettings();
        } else {
          alert(data.message || 'Failed to save API key');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Delete API key
    async function deleteApiKey(provider) {
      if (!confirm(`Delete ${provider} API key?`)) return;

      try {
        const response = await fetch('/api/settings/api-key', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider })
        });
        const data = await response.json();
        if (data.success) {
          renderSettings();
        } else {
          alert(data.message || 'Failed to delete API key');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Save Global settings (no projectId)
    async function saveGlobalSettings() {
      const provider = document.getElementById('settings-provider')?.value;
      const model = document.getElementById('settings-model')?.value;
      const maxTokens = parseInt(document.getElementById('settings-max-tokens')?.value) || 4096;
      const temperature = parseFloat(document.getElementById('settings-temperature')?.value) || 0.7;

      try {
        // PUT /api/settings (no projectId = global)
        const response = await fetch('/api/settings/project', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            llm: { provider, model },
            preferences: { autoChunking: true, costWarningEnabled: true, costWarningThreshold: 0.5 }
          })
        });
        const data = await response.json();
        if (data.success) {
          alert('Global settings saved successfully');
          renderSettings();
        } else {
          alert(data.message || 'Failed to save settings');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Save Project overrides (with projectId)
    async function saveProjectSettings() {
      // Collect only overridden values
      const overrides = {};

      if (document.getElementById('override-provider')?.checked) {
        overrides.provider = document.getElementById('project-provider')?.value;
      }
      if (document.getElementById('override-model')?.checked) {
        overrides.model = document.getElementById('project-model')?.value;
      }
      if (document.getElementById('override-maxTokens')?.checked) {
        overrides.maxTokens = parseInt(document.getElementById('project-maxTokens')?.value);
      }
      if (document.getElementById('override-temperature')?.checked) {
        overrides.temperature = parseFloat(document.getElementById('project-temperature')?.value);
      }

      try {
        // PUT /api/settings/project?projectId=... (with projectId = project override)
        const namespace = settingsData.namespace;
        const response = await fetch(`/api/settings/project?projectId=${encodeURIComponent(namespace)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            overrides: overrides
          })
        });
        const data = await response.json();
        if (data.success) {
          alert('Project overrides saved successfully');
          renderSettings();
        } else {
          alert(data.message || 'Failed to save project overrides');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Clear all project overrides
    async function clearProjectOverrides() {
      if (!confirm('Clear all project overrides? This project will inherit all settings from Global.')) return;

      try {
        const namespace = settingsData.namespace;
        const response = await fetch(`/api/settings/project?projectId=${encodeURIComponent(namespace)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ overrides: {} })
        });
        const data = await response.json();
        if (data.success) {
          settingsData.projectOverrides = {};
          renderSettings();
        } else {
          alert(data.message || 'Failed to clear overrides');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Reset settings to defaults
    async function resetSettings() {
      if (!confirm('Reset all settings to defaults?')) return;

      try {
        await fetch('/api/settings/project', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            llm: { provider: 'anthropic', model: 'claude-sonnet-4-20250514' },
            preferences: { autoChunking: true, costWarningEnabled: true, costWarningThreshold: 0.5 }
          })
        });
        renderSettings();
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // ===================
    // Agent Launcher
    // ===================
    let agentData = null;

    async function renderAgentLauncher() {
      app.innerHTML = `
        <div class="page-header">
          <h2>Agent Launcher</h2>
        </div>
        <div class="card" data-testid="agent-launcher-root">
          <h3>Select Project Folder</h3>
          <p class="hint" style="color: #6b7280; margin-bottom: 12px;">
            Enter the path to a project folder to inspect its agent configuration.
          </p>
          <div style="display: flex; gap: 8px; margin-bottom: 16px;">
            <input type="text" id="folder-input" data-testid="folder-input"
              placeholder="/path/to/project"
              style="flex: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; font-size: 0.9rem;">
            <button class="btn btn-primary" onclick="inspectFolder()">Inspect</button>
          </div>
          <div id="agent-result" data-testid="agent-result"></div>
        </div>
        <style>
          .agent-info-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-top: 16px; }
          .agent-info-row { display: flex; margin-bottom: 8px; }
          .agent-info-label { width: 140px; font-weight: 600; color: #374151; }
          .agent-info-value { flex: 1; font-family: monospace; color: #1f2937; word-break: break-all; }
          .agent-list { margin-top: 16px; }
          .agent-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px; }
          .agent-item .agent-name { font-weight: 500; color: #1f2937; }
          .agent-item .agent-path { font-size: 0.85rem; color: #6b7280; font-family: monospace; }
          .no-agents { padding: 16px; background: #fef3c7; border-radius: 6px; color: #92400e; }
          .agent-status { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 500; }
          .agent-status.found { background: #d1fae5; color: #065f46; }
          .agent-status.not-found { background: #fef3c7; color: #92400e; }
        </style>
      `;
    }

    async function inspectFolder() {
      const folderInput = document.getElementById('folder-input');
      const resultDiv = document.getElementById('agent-result');
      const folder = folderInput?.value?.trim();

      if (!folder) {
        resultDiv.innerHTML = '<p style="color: #dc2626;">Please enter a folder path.</p>';
        return;
      }

      resultDiv.innerHTML = '<p>Inspecting folder...</p>';

      try {
        const response = await fetch(`/api/agents?folder=${encodeURIComponent(folder)}`);
        const data = await response.json();

        if (!response.ok) {
          resultDiv.innerHTML = `<p style="color: #dc2626;">Error: ${data.message || 'Failed to inspect folder'}</p>`;
          return;
        }

        // Store for later use
        agentData = data;

        // Save to JSON file for evidence (via console)
        console.log('[AGENT-INSPECT]', JSON.stringify(data, null, 2));

        const agentsHtml = data.agents.length > 0
          ? data.agents.map(a => `
              <div class="agent-item">
                <span class="agent-name">${a.name}</span>
                <span class="agent-path">${a.path}</span>
              </div>
            `).join('')
          : '<div class="no-agents">No agents found in .claude/agents/ directory</div>';

        resultDiv.innerHTML = `
          <div class="agent-info-card" data-testid="agent-info-card">
            <div class="agent-info-row">
              <span class="agent-info-label">Selected Folder:</span>
              <span class="agent-info-value" data-testid="selected-folder">${data.folder}</span>
            </div>
            <div class="agent-info-row">
              <span class="agent-info-label">Effective CWD:</span>
              <span class="agent-info-value" data-testid="effective-cwd">${data.effectiveCwd}</span>
            </div>
            <div class="agent-info-row">
              <span class="agent-info-label">Namespace:</span>
              <span class="agent-info-value" data-testid="namespace">${data.namespace}</span>
            </div>
            <div class="agent-info-row">
              <span class="agent-info-label">State Directory:</span>
              <span class="agent-info-value" data-testid="state-dir">${data.stateDir}</span>
            </div>
            <div class="agent-info-row">
              <span class="agent-info-label">Agents Directory:</span>
              <span class="agent-info-value">
                <span class="agent-status ${data.hasAgentsDir ? 'found' : 'not-found'}" data-testid="agents-dir-status">
                  ${data.hasAgentsDir ? 'Found' : 'Not Found'}
                </span>
              </span>
            </div>
            <div class="agent-info-row">
              <span class="agent-info-label">Agent Count:</span>
              <span class="agent-info-value" data-testid="agent-count">${data.agentCount}</span>
            </div>
            <div class="agent-list" data-testid="agent-list">
              <h4 style="margin-bottom: 8px;">Agents:</h4>
              ${agentsHtml}
            </div>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `<p style="color: #dc2626;">Error: ${error.message}</p>`;
      }
    }

    // ===================
    // Dashboard & Activity Pages
    // ===================

    // Render Dashboard
    async function renderDashboard() {
      app.innerHTML = '<div class="loading">Loading Dashboard</div>';

      try {
        const data = await fetch('/api/dashboard').then(r => r.json());
        const projects = data.projects || [];
        const recentActivity = data.recentActivity || [];
        const stats = data.stats || {};

        const projectCards = projects.length > 0
          ? projects.map(p => `
              <div class="list-item" onclick="navigate('/projects/${encodeURIComponent(p.projectId)}')">
                <div class="list-item-main">
                  <div class="list-item-title">
                    ${p.favorite ? '<span style="color: #f59e0b;">&#9733;</span> ' : ''}
                    ${escapeHtml(p.alias || p.projectPath)}
                  </div>
                  <div class="list-item-meta">
                    <span class="badge badge-${p.status === 'running' ? 'running' : p.status === 'error' ? 'error' : 'queued'}">${p.status}</span>
                    ${p.sessionCount} sessions | Updated: ${formatDate(p.updatedAt)}
                  </div>
                </div>
                <span class="list-item-arrow">&#8250;</span>
              </div>
            `).join('')
          : '<div class="empty-state"><p>No projects yet. Create a project to get started.</p></div>';

        const activityItems = recentActivity.length > 0
          ? recentActivity.slice(0, 5).map(e => `
              <div class="log-entry ${e.type === 'error' ? 'error' : ''}">
                <div class="log-time">${formatDate(e.timestamp)}</div>
                <div class="log-type">${escapeHtml(e.type)}</div>
                <div class="log-content">${escapeHtml(e.summary || '')}</div>
              </div>
            `).join('')
          : '<p style="color: #6b7280;">No recent activity</p>';

        app.innerHTML = `
          <div class="page-header">
            <h2>Dashboard</h2>
            <button class="refresh-btn" onclick="renderDashboard()">Refresh</button>
          </div>

          <div class="detail-grid" style="margin-bottom: 20px;">
            <div class="card" style="text-align: center;">
              <div style="font-size: 2rem; font-weight: bold; color: #2563eb;">${stats.projects || 0}</div>
              <div style="color: #6b7280;">Projects</div>
            </div>
            <div class="card" style="text-align: center;">
              <div style="font-size: 2rem; font-weight: bold; color: #10b981;">${stats.sessions || 0}</div>
              <div style="color: #6b7280;">Sessions</div>
            </div>
            <div class="card" style="text-align: center;">
              <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;">${stats.runs || 0}</div>
              <div style="color: #6b7280;">Runs</div>
            </div>
            <div class="card" style="text-align: center;">
              <div style="font-size: 2rem; font-weight: bold; color: #8b5cf6;">${stats.events || 0}</div>
              <div style="color: #6b7280;">Events</div>
            </div>
          </div>

          <div class="card">
            <h3>Projects</h3>
            ${projectCards}
            <div style="margin-top: 16px; text-align: center;">
              <button class="btn btn-primary" onclick="showCreateProjectDialog()">+ New Project</button>
            </div>
          </div>

          <div class="card">
            <h3>Recent Activity</h3>
            ${activityItems}
            ${recentActivity.length > 5 ? '<a href="/activity" onclick="event.preventDefault(); navigate(\'\'/activity\'\')" style="display: block; text-align: center; margin-top: 12px;">View All Activity</a>' : ''}
          </div>
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="card">
            <div class="error-message">Error loading dashboard: ${escapeHtml(error.message)}</div>
            <button class="btn btn-secondary" onclick="renderDashboard()">Retry</button>
          </div>
        `;
      }
    }

    // Show create project dialog
    function showCreateProjectDialog() {
      const projectPath = prompt('Enter project path:');
      if (!projectPath) return;

      const alias = prompt('Enter project alias (optional):');

      fetch('/api/projects', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ projectPath, alias: alias || undefined }),
      })
        .then(r => r.json())
        .then(data => {
          if (data.error) {
            alert('Error: ' + data.message);
          } else {
            navigate('/projects/' + encodeURIComponent(data.projectId));
          }
        })
        .catch(e => alert('Error: ' + e.message));
    }

    // Render Activity page
    async function renderActivity() {
      app.innerHTML = '<div class="loading">Loading Activity</div>';

      try {
        const data = await fetch('/api/activity?limit=50').then(r => r.json());
        const events = data.events || [];

        const eventItems = events.length > 0
          ? events.map(e => `
              <div class="log-entry ${e.importance === 'high' ? 'error' : ''}">
                <div class="log-time">${formatFullDate(e.timestamp)}</div>
                <div class="log-type">${escapeHtml(e.type)}</div>
                <div class="log-content">${escapeHtml(e.summary || '')}</div>
                ${e.projectAlias ? '<div style="font-size: 0.85rem; color: #6b7280;">Project: ' + escapeHtml(e.projectAlias) + '</div>' : ''}
              </div>
            `).join('')
          : '<div class="empty-state"><p>No activity events yet.</p></div>';

        app.innerHTML = `
          <div class="page-header">
            <h2>Activity</h2>
            <button class="refresh-btn" onclick="renderActivity()">Refresh</button>
          </div>

          <div class="card">
            <h3>Recent Events</h3>
            ${eventItems}
          </div>
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <button class="btn btn-secondary" onclick="renderActivity()">Retry</button>
          </div>
        `;
      }
    }

    // Render Project Detail page
    async function renderProjectDetail(projectId) {
      app.innerHTML = '<div class="loading">Loading Project</div>';

      try {
        const data = await fetch('/api/projects/' + encodeURIComponent(projectId)).then(r => r.json());
        if (data.error) throw new Error(data.message);

        const project = data.project;
        const sessions = data.sessions || [];

        const backBtn = '<a href="/dashboard" class="back-btn" onclick="event.preventDefault(); navigate(\'/dashboard\')">Back to Dashboard</a>';

        const sessionItems = sessions.length > 0
          ? sessions.map(s => `
              <div class="list-item" onclick="navigate('/sessions/${encodeURIComponent(s.sessionId)}')">
                <div class="list-item-main">
                  <div class="list-item-title">${escapeHtml(s.sessionId)}</div>
                  <div class="list-item-meta">
                    <span class="badge badge-${s.status === 'active' ? 'running' : 'complete'}">${s.status}</span>
                    ${s.totalRuns} runs | Started: ${formatDate(s.startedAt)}
                  </div>
                </div>
                <span class="list-item-arrow">&#8250;</span>
              </div>
            `).join('')
          : '<div class="empty-state"><p>No sessions yet.</p></div>';

        app.innerHTML = `
          <div class="page-header">
            <h2>${escapeHtml(project.alias || 'Project')}</h2>
            <div class="action-bar">
              ${backBtn}
              <button class="refresh-btn" onclick="renderProjectDetail('${escapeHtml(projectId)}')">Refresh</button>
            </div>
          </div>

          <div class="card">
            <h3>Project Details</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Project ID</label>
                <value>${escapeHtml(project.projectId)}</value>
              </div>
              <div class="detail-item">
                <label>Path</label>
                <value>${escapeHtml(project.projectPath)}</value>
              </div>
              <div class="detail-item">
                <label>Status</label>
                <value><span class="badge badge-${project.status === 'running' ? 'running' : project.status === 'error' ? 'error' : 'queued'}">${project.status}</span></value>
              </div>
              <div class="detail-item">
                <label>Last Activity</label>
                <value>${formatFullDate(project.lastActivityAt)}</value>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Sessions (${sessions.length})</h3>
            ${sessionItems}
          </div>

          <div class="action-bar" style="margin-top: 16px;">
            ${!project.archived 
              ? '<button class="btn btn-secondary" onclick="archiveProject(\'' + escapeHtml(projectId) + '\')">Archive Project</button>'
              : '<button class="btn btn-primary" onclick="unarchiveProject(\'' + escapeHtml(projectId) + '\')">Unarchive Project</button>'
            }
          </div>
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <a href="/dashboard" class="btn btn-secondary" onclick="event.preventDefault(); navigate('/dashboard')">Back to Dashboard</a>
          </div>
        `;
      }
    }

    // Archive project
    async function archiveProject(projectId) {
      if (!confirm('Archive this project?')) return;
      try {
        await fetch('/api/projects/' + encodeURIComponent(projectId) + '/archive', { method: 'POST' });
        renderProjectDetail(projectId);
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // Unarchive project
    async function unarchiveProject(projectId) {
      try {
        await fetch('/api/projects/' + encodeURIComponent(projectId) + '/unarchive', { method: 'POST' });
        renderProjectDetail(projectId);
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // Render Session Detail page
    async function renderSessionDetail(sessionId) {
      app.innerHTML = '<div class="loading">Loading Session</div>';

      try {
        const data = await fetch('/api/sessions/' + encodeURIComponent(sessionId)).then(r => r.json());
        if (data.error) throw new Error(data.message);

        const session = data.session;
        const runs = data.runs || [];

        const backBtn = session.projectId 
          ? '<a href="/projects/' + encodeURIComponent(session.projectId) + '" class="back-btn" onclick="event.preventDefault(); navigate(\'/projects/' + encodeURIComponent(session.projectId) + '\')">Back to Project</a>'
          : '<a href="/dashboard" class="back-btn" onclick="event.preventDefault(); navigate(\'/dashboard\')">Back to Dashboard</a>';

        const runItems = runs.length > 0
          ? runs.map(r => `
              <div class="list-item" onclick="navigate('/runs/${encodeURIComponent(r.runId)}')">
                <div class="list-item-main">
                  <div class="list-item-title">${escapeHtml(r.taskRunId)}</div>
                  <div class="list-item-meta">
                    <span class="badge badge-${r.status === 'COMPLETE' ? 'complete' : r.status === 'RUNNING' ? 'running' : r.status === 'ERROR' ? 'error' : 'queued'}">${r.status}</span>
                    Started: ${formatDate(r.startedAt)}
                  </div>
                </div>
                <span class="list-item-arrow">&#8250;</span>
              </div>
            `).join('')
          : '<div class="empty-state"><p>No runs yet.</p></div>';

        app.innerHTML = `
          <div class="page-header">
            <h2>Session</h2>
            <div class="action-bar">
              ${backBtn}
              <button class="refresh-btn" onclick="renderSessionDetail('${escapeHtml(sessionId)}')">Refresh</button>
            </div>
          </div>

          <div class="card">
            <h3>Session Details</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Session ID</label>
                <value>${escapeHtml(session.sessionId)}</value>
              </div>
              <div class="detail-item">
                <label>Status</label>
                <value><span class="badge badge-${session.status === 'active' ? 'running' : 'complete'}">${session.status}</span></value>
              </div>
              <div class="detail-item">
                <label>Started</label>
                <value>${formatFullDate(session.startedAt)}</value>
              </div>
              <div class="detail-item">
                <label>Total Runs</label>
                <value>${session.totalRuns}</value>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Runs (${runs.length})</h3>
            ${runItems}
          </div>
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <a href="/dashboard" class="btn btn-secondary" onclick="event.preventDefault(); navigate('/dashboard')">Back to Dashboard</a>
          </div>
        `;
      }
    }

    // Render Run Detail page
    async function renderRunDetail(runId) {
      app.innerHTML = '<div class="loading">Loading Run</div>';

      try {
        const data = await fetch('/api/runs/' + encodeURIComponent(runId)).then(r => r.json());
        if (data.error) throw new Error(data.message);

        const run = data.run;
        const events = data.events || [];

        const backBtn = run.sessionId 
          ? '<a href="/sessions/' + encodeURIComponent(run.sessionId) + '" class="back-btn" onclick="event.preventDefault(); navigate(\'/sessions/' + encodeURIComponent(run.sessionId) + '\')">Back to Session</a>'
          : '<a href="/dashboard" class="back-btn" onclick="event.preventDefault(); navigate(\'/dashboard\')">Back to Dashboard</a>';

        const eventLog = events.length > 0
          ? events.map(e => `
              <div class="log-entry ${e.level === 'error' ? 'error' : ''}">
                <div class="log-time">${formatFullDate(e.timestamp)}</div>
                <div class="log-type">${escapeHtml(e.type)}</div>
                <div class="log-content">${escapeHtml(e.message)}</div>
              </div>
            `).join('')
          : '<p style="color: #6b7280;">No events recorded.</p>';

        app.innerHTML = `
          <div class="page-header">
            <h2>Run Detail</h2>
            <div class="action-bar">
              ${backBtn}
              <button class="refresh-btn" onclick="renderRunDetail('${escapeHtml(runId)}')">Refresh</button>
              <button class="btn btn-secondary" onclick="generateInspectionPacket('${escapeHtml(runId)}')">Generate Inspection Packet</button>
            </div>
          </div>

          <div class="card">
            <h3>Run Details</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Run ID</label>
                <value>${escapeHtml(run.runId)}</value>
              </div>
              <div class="detail-item">
                <label>Task Run ID</label>
                <value>${escapeHtml(run.taskRunId)}</value>
              </div>
              <div class="detail-item">
                <label>Status</label>
                <value><span class="badge badge-${run.status === 'COMPLETE' ? 'complete' : run.status === 'RUNNING' ? 'running' : run.status === 'ERROR' ? 'error' : 'queued'}">${run.status}</span></value>
              </div>
              <div class="detail-item">
                <label>Started</label>
                <value>${formatFullDate(run.startedAt)}</value>
              </div>
              ${run.endedAt ? '<div class="detail-item"><label>Ended</label><value>' + formatFullDate(run.endedAt) + '</value></div>' : ''}
              <div class="detail-item">
                <label>Event Count</label>
                <value>${run.eventCount}</value>
              </div>
            </div>
          </div>

          ${run.prompt ? '<div class="card"><h3>Prompt</h3><div class="prompt-box">' + escapeHtml(run.prompt) + '</div></div>' : ''}

          <div class="card">
            <h3>Events (${events.length})</h3>
            ${eventLog}
          </div>
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <a href="/dashboard" class="btn btn-secondary" onclick="event.preventDefault(); navigate('/dashboard')">Back to Dashboard</a>
          </div>
        `;
      }
    }

    // Generate Inspection Packet
    async function generateInspectionPacket(runId) {
      try {
        const response = await fetch('/api/inspection/run/' + encodeURIComponent(runId), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ generatedBy: 'user' }),
        });
        const packet = await response.json();
        if (packet.error) throw new Error(packet.message);

        // Open clipboard format in new window
        const clipboardUrl = '/api/inspection/' + encodeURIComponent(packet.packetId) + '/clipboard';
        alert('Inspection packet generated: ' + packet.packetId + '\n\nYou can copy it for ChatGPT from:\n' + clipboardUrl);
      } catch (error) {
        alert('Error generating packet: ' + error.message);
      }
    }

    
    // Router
    function router() {
      const path = window.location.pathname;
      const search = new URLSearchParams(window.location.search);
      currentPath = path;
      updateNav(path);

      if (path === '/dashboard') {
        renderDashboard();
      } else if (path === '/' || path === '') {
        renderTaskGroupList();
      } else if (path === '/activity') {
        renderActivity();
      } else if (path.startsWith('/task-groups/')) {
        const taskGroupId = decodeURIComponent(path.split('/task-groups/')[1]);
        renderTaskList(taskGroupId);
      } else if (path.startsWith('/tasks/')) {
        const taskId = decodeURIComponent(path.split('/tasks/')[1]);
        renderTaskDetail(taskId);
      } else if (path.startsWith('/projects/')) {
        const projectId = decodeURIComponent(path.split('/projects/')[1]);
        renderProjectDetail(projectId);
      } else if (path.startsWith('/runs/')) {
        const runId = decodeURIComponent(path.split('/runs/')[1]);
        renderRunDetail(runId);
      } else if (path.startsWith('/sessions/')) {
        const sessionId = decodeURIComponent(path.split('/sessions/')[1]);
        renderSessionDetail(sessionId);
      } else if (path === '/new') {
        const group = search.get('group') || '';
        renderNewCommandForm(group);
      } else if (path === '/agent') {
        renderAgentLauncher();
      } else if (path === '/settings') {
        renderSettings();
      } else {
        app.innerHTML = `
          <div class="card">
            <h2>404 - Page Not Found</h2>
            <p>The page you're looking for doesn't exist.</p>
            <button class="btn btn-primary" onclick="navigate('/')" style="margin-top: 16px;">Go Home</button>
          </div>
        `;
      }
    }

    // Navigate
    function navigate(path) {
      history.pushState(null, '', path);
      router();
    }

    // Handle back/forward
    window.addEventListener('popstate', router);

    // Handle navigation links
    document.querySelectorAll('#main-nav a').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        navigate(link.getAttribute('href'));
      });
    });

    // Current namespace state
    let currentNamespace = '';
    let runnerRefreshInterval = null;

    // Load namespaces and populate selector
    async function loadNamespaces() {
      try {
        // Don't pass namespace param to /namespaces - it returns all namespaces
        const response = await fetch('/api/namespaces');
        const data = await response.json();

        const selector = document.getElementById('namespace-selector');
        const select = document.getElementById('namespace-select');

        if (!selector || !select) return;

        // Set current namespace only if not already set by user selection
        if (!currentNamespace) {
          currentNamespace = data.current_namespace;
        }
        const namespaces = data.namespaces || [];

        // Build options
        let options = '';
        if (namespaces.length === 0) {
          // No namespaces from scan, just show current
          options = `<option value="${escapeHtml(currentNamespace)}">${escapeHtml(currentNamespace)}</option>`;
        } else {
          options = namespaces.map(ns => {
            const selected = ns.namespace === currentNamespace ? 'selected' : '';
            const counts = `(${ns.queued_count}Q/${ns.running_count}R/${ns.task_count}T)`;
            return `<option value="${escapeHtml(ns.namespace)}" ${selected}>${escapeHtml(ns.namespace)} ${counts}</option>`;
          }).join('');
        }

        select.innerHTML = options;
        selector.style.display = 'flex';

        // Load runners for current namespace
        loadRunnerStatus();
      } catch (e) {
        console.warn('Failed to load namespaces:', e);
      }
    }

    // Handle namespace change
    function onNamespaceChange(namespace) {
      if (namespace === currentNamespace) return;

      // Update current namespace and reload data
      currentNamespace = namespace;

      // Reload runner status for new namespace
      loadRunnerStatus();

      // Re-navigate to refresh current page data with new namespace
      navigate(currentPath);
    }

    // Load runner status
    async function loadRunnerStatus() {
      try {
        const data = await api('/runners');
        const runners = data.runners || [];

        const dot = document.getElementById('runner-dot');
        const text = document.getElementById('runner-text');

        if (!dot || !text) return;

        const aliveCount = runners.filter(r => r.is_alive).length;
        const totalCount = runners.length;

        if (aliveCount > 0) {
          dot.className = 'runner-dot alive';
          text.textContent = aliveCount + ' runner' + (aliveCount > 1 ? 's' : '') + ' active';
        } else if (totalCount > 0) {
          dot.className = 'runner-dot dead';
          text.textContent = 'No active runners';
        } else {
          dot.className = 'runner-dot dead';
          text.textContent = 'No runners';
        }
      } catch (e) {
        console.warn('Failed to load runner status:', e);
        const dot = document.getElementById('runner-dot');
        const text = document.getElementById('runner-text');
        if (dot) dot.className = 'runner-dot dead';
        if (text) text.textContent = 'Error';
      }
    }

    // Start periodic runner status refresh
    function startRunnerRefresh() {
      // Refresh every 30 seconds
      runnerRefreshInterval = setInterval(loadRunnerStatus, 30000);
    }

    // Stop runner refresh
    function stopRunnerRefresh() {
      if (runnerRefreshInterval) {
        clearInterval(runnerRefreshInterval);
        runnerRefreshInterval = null;
      }
    }

    // Initial load
    loadNamespaces();
    startRunnerRefresh();
    router();
  </script>
</body>
</html>
