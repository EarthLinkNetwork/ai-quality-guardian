<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PM Orchestrator Runner - Web UI</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: #2563eb;
      color: white;
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 1.3rem;
      font-weight: 600;
      cursor: pointer;
    }

    .namespace-badge {
      background: rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 12px;
      font-family: monospace;
    }

    .namespace-badge.auto-derived {
      background: rgba(34, 197, 94, 0.3);
    }

    nav {
      display: flex;
      gap: 16px;
    }

    nav a {
      color: rgba(255, 255, 255, 0.9);
      text-decoration: none;
      font-size: 0.9rem;
      padding: 8px 16px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    nav a:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    nav a.active {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .page-header h2 {
      font-size: 1.5rem;
      color: #1f2937;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #e5e7eb;
      color: #374151;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.2s;
    }

    .back-btn:hover {
      background: #d1d5db;
    }

    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 16px;
    }

    .card h3 {
      font-size: 1.1rem;
      margin-bottom: 16px;
      color: #1f2937;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 8px;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .list-item:hover {
      background: #f9fafb;
      border-color: #2563eb;
      transform: translateX(4px);
    }

    .list-item-main {
      flex: 1;
    }

    .list-item-title {
      font-weight: 500;
      color: #111827;
    }

    .list-item-meta {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 4px;
    }

    .list-item-arrow {
      color: #9ca3af;
      font-size: 1.2rem;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-right: 8px;
    }

    .badge-queued {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-running {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge-complete {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-error {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-cancelled {
      background: #e5e7eb;
      color: #4b5563;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: #374151;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }

    .btn {
      display: inline-block;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-primary:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .detail-item {
      background: #f9fafb;
      padding: 12px;
      border-radius: 6px;
    }

    .detail-item label {
      display: block;
      font-size: 0.8rem;
      color: #6b7280;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .detail-item value {
      display: block;
      font-weight: 500;
      color: #1f2937;
      word-break: break-all;
    }

    .prompt-box {
      background: #f9fafb;
      padding: 16px;
      border-radius: 6px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      word-break: break-word;
      border-left: 4px solid #2563eb;
    }

    .log-section {
      margin-top: 20px;
    }

    .log-entry {
      padding: 12px;
      border-left: 3px solid #e5e7eb;
      margin-bottom: 8px;
      background: #fafafa;
    }

    .log-entry.user-input {
      border-left-color: #2563eb;
    }

    .log-entry.task-started {
      border-left-color: #f59e0b;
    }

    .log-entry.task-completed {
      border-left-color: #10b981;
    }

    .log-entry.error {
      border-left-color: #ef4444;
      background: #fef2f2;
    }

    .log-time {
      font-size: 0.75rem;
      color: #6b7280;
      font-family: monospace;
    }

    .log-type {
      font-size: 0.8rem;
      font-weight: 600;
      color: #374151;
      margin: 4px 0;
    }

    .log-content {
      font-size: 0.9rem;
      color: #1f2937;
      white-space: pre-wrap;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .empty-state p {
      margin-bottom: 16px;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    .success-message {
      background: #d1fae5;
      color: #065f46;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    .refresh-btn {
      background: none;
      border: 1px solid #d1d5db;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      color: #6b7280;
    }

    .refresh-btn:hover {
      background: #f3f4f6;
    }

    .action-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    @media (max-width: 600px) {
      .container {
        padding: 12px;
      }

      header {
        padding: 12px 16px;
      }

      .header-content {
        flex-direction: column;
        gap: 12px;
      }

      header h1 {
        font-size: 1.1rem;
      }

      nav {
        width: 100%;
        justify-content: center;
      }

      .card {
        padding: 16px;
      }

      .page-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
      }

      .detail-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1 onclick="navigate('/')">PM Orchestrator Runner</h1>
      <span id="namespace-badge" class="namespace-badge" style="display: none;"></span>
      <nav id="main-nav">
        <a href="/" data-nav="home">Task Groups</a>
        <a href="/new" data-nav="new">+ New Command</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <div id="app">
      <div class="loading">Loading</div>
    </div>
  </main>

  <script>
    const app = document.getElementById('app');
    let currentPath = '/';

    // API helper
    async function api(path, options = {}) {
      const response = await fetch(`/api${path}`, {
        headers: { 'Content-Type': 'application/json' },
        ...options,
      });
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.message || 'Request failed');
      }
      return data;
    }

    // Format date
    function formatDate(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleString('ja-JP', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
      });
    }

    // Format full date
    function formatFullDate(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
      });
    }

    // Get status badge class
    function getStatusBadgeClass(status) {
      const map = {
        'QUEUED': 'badge-queued',
        'RUNNING': 'badge-running',
        'COMPLETE': 'badge-complete',
        'ERROR': 'badge-error',
        'CANCELLED': 'badge-cancelled',
      };
      return map[status] || 'badge-queued';
    }

    // Escape HTML
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Update nav active state
    function updateNav(path) {
      document.querySelectorAll('#main-nav a').forEach(link => {
        link.classList.remove('active');
        if (path === '/' && link.dataset.nav === 'home') {
          link.classList.add('active');
        } else if (path === '/new' && link.dataset.nav === 'new') {
          link.classList.add('active');
        }
      });
    }

    // Render task group list (Home)
    async function renderTaskGroupList() {
      app.innerHTML = '<div class="loading">Loading</div>';

      try {
        const data = await api('/task-groups');
        const groups = data.task_groups || [];

        if (groups.length === 0) {
          app.innerHTML = `
            <div class="page-header">
              <h2>Task Groups</h2>
              <button class="refresh-btn" onclick="renderTaskGroupList()">Refresh</button>
            </div>
            <div class="card">
              <div class="empty-state">
                <p>No task groups yet.</p>
                <button class="btn btn-primary" onclick="navigate('/new')">+ Create New Command</button>
              </div>
            </div>
          `;
          return;
        }

        const items = groups.map(g => `
          <div class="list-item" onclick="navigate('/task-groups/${encodeURIComponent(g.task_group_id)}')">
            <div class="list-item-main">
              <div class="list-item-title">${escapeHtml(g.task_group_id)}</div>
              <div class="list-item-meta">
                ${g.task_count} task(s) | Created: ${formatDate(g.created_at)}
              </div>
            </div>
            <span class="list-item-arrow">›</span>
          </div>
        `).join('');

        app.innerHTML = `
          <div class="page-header">
            <h2>Task Groups</h2>
            <button class="refresh-btn" onclick="renderTaskGroupList()">Refresh</button>
          </div>
          <div class="card">
            ${items}
          </div>
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="page-header">
            <h2>Task Groups</h2>
          </div>
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <button class="btn btn-secondary" onclick="renderTaskGroupList()">Retry</button>
          </div>
        `;
      }
    }

    // Render task list for a task group
    async function renderTaskList(taskGroupId) {
      app.innerHTML = '<div class="loading">Loading</div>';

      try {
        const data = await api(`/task-groups/${encodeURIComponent(taskGroupId)}/tasks`);
        const tasks = data.tasks || [];

        const backBtn = `<a href="/" class="back-btn" onclick="event.preventDefault(); navigate('/')">← Back to Groups</a>`;

        if (tasks.length === 0) {
          app.innerHTML = `
            <div class="page-header">
              <h2>${escapeHtml(taskGroupId)}</h2>
              <div class="action-bar">
                ${backBtn}
                <button class="refresh-btn" onclick="renderTaskList('${escapeHtml(taskGroupId)}')">Refresh</button>
              </div>
            </div>
            <div class="card">
              <div class="empty-state">
                <p>No tasks in this group yet.</p>
                <button class="btn btn-primary" onclick="navigate('/new?group=${encodeURIComponent(taskGroupId)}')">+ Add Task</button>
              </div>
            </div>
          `;
          return;
        }

        const items = tasks.map(t => `
          <div class="list-item" onclick="navigate('/tasks/${encodeURIComponent(t.task_id)}')">
            <div class="list-item-main">
              <span class="badge ${getStatusBadgeClass(t.status)}">${t.status}</span>
              <span class="list-item-title">${escapeHtml(t.task_id)}</span>
              <div class="list-item-meta">
                ${escapeHtml(t.prompt.substring(0, 80))}${t.prompt.length > 80 ? '...' : ''}
              </div>
              <div class="list-item-meta">
                ${formatDate(t.created_at)}
              </div>
            </div>
            <span class="list-item-arrow">›</span>
          </div>
        `).join('');

        app.innerHTML = `
          <div class="page-header">
            <h2>${escapeHtml(taskGroupId)}</h2>
            <div class="action-bar">
              ${backBtn}
              <button class="refresh-btn" onclick="renderTaskList('${escapeHtml(taskGroupId)}')">Refresh</button>
            </div>
          </div>
          <div class="card">
            <h3>Tasks (${tasks.length})</h3>
            ${items}
          </div>
          <div style="text-align: center; margin-top: 16px;">
            <button class="btn btn-primary" onclick="navigate('/new?group=${encodeURIComponent(taskGroupId)}')">+ Add Task to This Group</button>
          </div>
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="page-header">
            <h2>${escapeHtml(taskGroupId)}</h2>
            <a href="/" class="back-btn" onclick="event.preventDefault(); navigate('/')">← Back</a>
          </div>
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <button class="btn btn-secondary" onclick="renderTaskList('${escapeHtml(taskGroupId)}')">Retry</button>
          </div>
        `;
      }
    }

    // Render task detail with logs
    async function renderTaskDetail(taskId) {
      app.innerHTML = '<div class="loading">Loading</div>';

      try {
        const task = await api(`/tasks/${encodeURIComponent(taskId)}`);

        const backBtn = `<a href="/task-groups/${encodeURIComponent(task.task_group_id)}" class="back-btn" onclick="event.preventDefault(); navigate('/task-groups/${encodeURIComponent(task.task_group_id)}')">← Back to Tasks</a>`;

        let errorSection = '';
        if (task.error_message) {
          errorSection = `
            <div class="card">
              <h3>Error</h3>
              <div class="log-entry error">
                <div class="log-content">${escapeHtml(task.error_message)}</div>
              </div>
            </div>
          `;
        }

        // Log entries (simulated based on task status)
        let logEntries = '';
        if (task.status !== 'QUEUED') {
          logEntries = `
            <div class="card log-section">
              <h3>Execution Log</h3>
              <div class="log-entry user-input">
                <div class="log-time">${formatFullDate(task.created_at)}</div>
                <div class="log-type">USER INPUT</div>
                <div class="log-content">${escapeHtml(task.prompt)}</div>
              </div>
              ${task.status === 'RUNNING' ? `
              <div class="log-entry task-started">
                <div class="log-time">${formatFullDate(task.updated_at)}</div>
                <div class="log-type">TASK STARTED</div>
                <div class="log-content">Task is currently running...</div>
              </div>
              ` : ''}
              ${task.status === 'COMPLETE' ? `
              <div class="log-entry task-completed">
                <div class="log-time">${formatFullDate(task.updated_at)}</div>
                <div class="log-type">TASK COMPLETED</div>
                <div class="log-content">Task completed successfully.</div>
              </div>
              ` : ''}
              ${task.status === 'ERROR' ? `
              <div class="log-entry error">
                <div class="log-time">${formatFullDate(task.updated_at)}</div>
                <div class="log-type">TASK ERROR</div>
                <div class="log-content">${escapeHtml(task.error_message || 'Unknown error')}</div>
              </div>
              ` : ''}
              ${task.status === 'CANCELLED' ? `
              <div class="log-entry" style="border-left-color: #6b7280;">
                <div class="log-time">${formatFullDate(task.updated_at)}</div>
                <div class="log-type">TASK CANCELLED</div>
                <div class="log-content">Task was cancelled by user.</div>
              </div>
              ` : ''}
            </div>
          `;
        }

        app.innerHTML = `
          <div class="page-header">
            <h2>Task Detail</h2>
            <div class="action-bar">
              ${backBtn}
              <button class="refresh-btn" onclick="renderTaskDetail('${escapeHtml(taskId)}')">Refresh</button>
            </div>
          </div>

          <div class="card">
            <h3>Status</h3>
            <div style="display: flex; align-items: center; gap: 16px;">
              <span class="badge ${getStatusBadgeClass(task.status)}" style="font-size: 1rem; padding: 8px 16px;">${task.status}</span>
              ${(task.status === 'QUEUED' || task.status === 'RUNNING') ? `
                <button class="btn btn-secondary" onclick="cancelTask('${escapeHtml(task.task_id)}')" style="padding: 8px 16px;">Cancel Task</button>
              ` : ''}
            </div>
          </div>

          <div class="card">
            <h3>Details</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Task ID</label>
                <value>${escapeHtml(task.task_id)}</value>
              </div>
              <div class="detail-item">
                <label>Task Group</label>
                <value><a href="/task-groups/${encodeURIComponent(task.task_group_id)}" onclick="event.preventDefault(); navigate('/task-groups/${encodeURIComponent(task.task_group_id)}')">${escapeHtml(task.task_group_id)}</a></value>
              </div>
              <div class="detail-item">
                <label>Session ID</label>
                <value>${escapeHtml(task.session_id)}</value>
              </div>
              <div class="detail-item">
                <label>Created</label>
                <value>${formatFullDate(task.created_at)}</value>
              </div>
              <div class="detail-item">
                <label>Updated</label>
                <value>${formatFullDate(task.updated_at)}</value>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Prompt</h3>
            <div class="prompt-box">${escapeHtml(task.prompt)}</div>
          </div>

          ${errorSection}
          ${logEntries}
        `;
      } catch (error) {
        app.innerHTML = `
          <div class="page-header">
            <h2>Task Detail</h2>
            <a href="/" class="back-btn" onclick="event.preventDefault(); navigate('/')">← Back</a>
          </div>
          <div class="card">
            <div class="error-message">Error: ${escapeHtml(error.message)}</div>
            <button class="btn btn-secondary" onclick="renderTaskDetail('${escapeHtml(taskId)}')">Retry</button>
          </div>
        `;
      }
    }

    // Render new command form
    async function renderNewCommandForm(prefilledGroup = '') {
      let taskGroups = [];
      try {
        const data = await api('/task-groups');
        taskGroups = data.task_groups || [];
      } catch (error) {
        // Ignore - we can still create new task groups
      }

      const options = taskGroups.length > 0
        ? taskGroups.map(g => `<option value="${escapeHtml(g.task_group_id)}">${escapeHtml(g.task_group_id)}</option>`).join('')
        : '';

      const backBtn = `<a href="/" class="back-btn" onclick="event.preventDefault(); navigate('/')">← Back to Groups</a>`;

      app.innerHTML = `
        <div class="page-header">
          <h2>New Command</h2>
          ${backBtn}
        </div>

        <div class="card">
          <form id="new-command-form">
            <div class="form-group">
              <label for="task_group_id">Task Group ID</label>
              <input type="text" id="task_group_id" name="task_group_id"
                placeholder="Enter new or select existing"
                list="task-groups-list"
                value="${escapeHtml(prefilledGroup)}"
                required>
              <datalist id="task-groups-list">
                ${options}
              </datalist>
            </div>

            <div class="form-group">
              <label for="prompt">Command / Prompt</label>
              <textarea id="prompt" name="prompt"
                placeholder="Enter your command or prompt here..." required></textarea>
            </div>

            <div id="form-message"></div>

            <button type="submit" class="btn btn-primary" id="submit-btn">Submit to Queue</button>
          </form>
        </div>

        <div class="card" style="background: #fffbeb; border-left: 4px solid #f59e0b;">
          <p style="color: #92400e; font-size: 0.9rem;">
            <strong>Note:</strong> This adds a task to the queue. The Runner will pick it up and execute it automatically.
          </p>
        </div>
      `;

      // Form submission
      document.getElementById('new-command-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const submitBtn = document.getElementById('submit-btn');
        const messageDiv = document.getElementById('form-message');

        const taskGroupId = form.task_group_id.value.trim();
        const prompt = form.prompt.value.trim();

        if (!taskGroupId || !prompt) {
          messageDiv.innerHTML = '<div class="error-message">Please fill in all fields.</div>';
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        try {
          const result = await api('/tasks', {
            method: 'POST',
            body: JSON.stringify({ task_group_id: taskGroupId, prompt }),
          });

          messageDiv.innerHTML = `
            <div class="success-message">
              Task queued successfully!<br>
              Task ID: <strong>${escapeHtml(result.task_id)}</strong>
            </div>
          `;

          // Clear prompt only
          form.prompt.value = '';

          // Navigate to task detail after delay
          setTimeout(() => {
            navigate(`/tasks/${encodeURIComponent(result.task_id)}`);
          }, 1000);
        } catch (error) {
          messageDiv.innerHTML = `<div class="error-message">Error: ${escapeHtml(error.message)}</div>`;
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit to Queue';
        }
      });
    }

    // Cancel task
    async function cancelTask(taskId) {
      if (!confirm('Are you sure you want to cancel this task?')) {
        return;
      }

      try {
        const result = await fetch(`/api/tasks/${encodeURIComponent(taskId)}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'CANCELLED' }),
        });

        const data = await result.json();

        if (!result.ok) {
          alert(`Error: ${data.message || 'Failed to cancel task'}`);
          return;
        }

        // Refresh the task detail page
        renderTaskDetail(taskId);
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Router
    function router() {
      const path = window.location.pathname;
      const search = new URLSearchParams(window.location.search);
      currentPath = path;
      updateNav(path);

      if (path === '/' || path === '') {
        renderTaskGroupList();
      } else if (path.startsWith('/task-groups/')) {
        const taskGroupId = decodeURIComponent(path.split('/task-groups/')[1]);
        renderTaskList(taskGroupId);
      } else if (path.startsWith('/tasks/')) {
        const taskId = decodeURIComponent(path.split('/tasks/')[1]);
        renderTaskDetail(taskId);
      } else if (path === '/new') {
        const group = search.get('group') || '';
        renderNewCommandForm(group);
      } else {
        app.innerHTML = `
          <div class="card">
            <h2>404 - Page Not Found</h2>
            <p>The page you're looking for doesn't exist.</p>
            <button class="btn btn-primary" onclick="navigate('/')" style="margin-top: 16px;">Go Home</button>
          </div>
        `;
      }
    }

    // Navigate
    function navigate(path) {
      history.pushState(null, '', path);
      router();
    }

    // Handle back/forward
    window.addEventListener('popstate', router);

    // Handle navigation links
    document.querySelectorAll('#main-nav a').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        navigate(link.getAttribute('href'));
      });
    });

    // Load namespace info
    async function loadNamespaceInfo() {
      try {
        const data = await api('/namespace');
        const badge = document.getElementById('namespace-badge');
        if (badge && data.namespace) {
          badge.textContent = data.namespace;
          badge.style.display = 'inline-block';
          if (data.auto_derived) {
            badge.classList.add('auto-derived');
            badge.title = 'Auto-derived from project folder';
          } else {
            badge.title = 'Explicitly configured namespace';
          }
        }
      } catch (e) {
        console.warn('Failed to load namespace info:', e);
      }
    }

    // Initial load
    loadNamespaceInfo();
    router();
  </script>
</body>
</html>
