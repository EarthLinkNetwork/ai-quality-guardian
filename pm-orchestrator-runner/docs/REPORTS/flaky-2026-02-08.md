# Flaky Test Fix Report: ECONNRESET on App Recreation

**Date**: 2026-02-08
**Status**: RESOLVED

## Issue Summary

Test: `E2E: Open Chat Creates Task Group / Chat Task Groups persist across restart / should persist chat-created Task Groups after store recreation`

Error: `Error: read ECONNRESET`

## Root Cause Analysis

### PHASE 1: Reproduction Attempt

- Single test isolation: 30/30 PASS (0% failure rate)
- Full test suite: 3/3 PASS after initial failure
- Conclusion: Failure was timing-dependent, related to test execution order

### PHASE 2: Code Analysis

**Root Cause Identified**: The test recreates an Express app (`app2`) immediately after making requests to `app1`. When supertest's internal HTTP agent maintains keep-alive sockets, the socket can be reset during app transition.

```typescript
// Before fix:
const res1 = await request(app).get('/api/task-groups').expect(200);
// <-- No wait here, immediate transition
const queueStore2 = new FileQueueStore({ ... });
const app2 = createApp({ ... });
const res2 = await request(app2).get('/api/task-groups').expect(200);
```

**Failure Mechanism**:
1. supertest sends request to app1
2. Connection established with keep-alive
3. Test immediately creates app2 (new Express instance)
4. Request to app2 may use cached socket intended for app1
5. Socket reset â†’ ECONNRESET

### PHASE 3: Fix Implementation

Added I/O drain delay before app recreation:

```typescript
// FLAKY FIX: Wait for any pending I/O to complete before recreating app
await new Promise(resolve => setTimeout(resolve, 50));
```

This 50ms delay allows:
- Pending HTTP responses to complete
- Keep-alive sockets to settle
- Clean transition between app instances

### PHASE 4: Verification

**Flake Guard Gate Added**: `diagnostics/flake-guard.check.ts`

- Runs flaky-prone tests 10 consecutive times
- Any failure = gate FAIL
- Added to `gate:all`

**Results After Fix**:
- `persist chat-created Task Groups`: 10/10 PASS
- `Real Restart Verification`: 10/10 PASS

### PHASE 5: Final Verification

```
npm test (full suite): 3004 passing, 102 pending, 0 failing
gate:all: ALL PASS (including gate:flake-guard)
Flake Guard: 2/2 test patterns stable (10/10 each)
```

## Files Changed

1. `test/e2e/open-chat-creates-task-group.e2e.test.ts`
   - Added 50ms delay before app recreation

2. `diagnostics/flake-guard.check.ts` (NEW)
   - Flake Guard gate: runs flaky-prone tests 10x

3. `package.json`
   - Added `gate:flake-guard` script
   - Added `gate:flake-guard` to `gate:all`

## Prevention Measures

1. **Flake Guard Gate**: Permanently monitors flaky-prone tests
2. **I/O Drain Pattern**: Use delays when recreating network-bound resources in tests
3. **Test Isolation**: Each test should be independent of internal HTTP agent state
