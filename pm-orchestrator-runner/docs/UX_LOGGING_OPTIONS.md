# UX改善設計: ログ割り込みとファイル出力場所

本ドキュメントでは pm-orchestrator-runner の2つのUX課題について設計提案を整理する。


1. REPL中のログ割り込み問題

1-1. 現状の痛み

REPLでタスク実行中、バックグラウンド処理のログがユーザー入力に割り込む。入力中の文字列がログで分断され、何を入力していたか分からなくなる。結果として「壊れている」という印象を与える。

1-2. 解決案

案A: バッファリング方式
- ログを内部バッファに蓄積し、タスク完了後に一括出力する
- 利点: ユーザー入力が絶対に中断されない、既存コードへの影響が小さい
- 欠点: 長時間タスクで固まったように見える、エラー発生時の即時フィードバックがない

案B: 静音モード + 進捗1行方式
- デフォルトでログを非表示とし、進捗は1行だけ表示する（例: Processing task-xxx...）
- 完了時に結果サマリーを表示する
- 利点: 初心者に優しい、入力を妨げない、進捗は確認できる
- 欠点: 詳細ログを見たいときに切り替えが必要

案C: ログはファイルへ出力
- 画面にはプロンプトと結果サマリーのみ表示
- 詳細ログは $HOME/.pm-runner/logs/session-xxx.log に書き出す
- /logs コマンドで後から確認可能
- 利点: 完全な分離、ログを後から確認可能
- 欠点: 別ターミナルやコマンドでの確認が必要

1-3. 推奨案

案Bを推奨する（静音モード + 進捗1行）。

デフォルト挙動: 進捗は1行のみ更新表示、完了時に結果サマリーを出力する。
/verbose: 全ログをリアルタイム表示に切り替える（デバッグ用途）。
/logs: バッファされたログや過去のログを後から確認する。

この構成により、初心者はログで混乱せず、上級者は必要に応じて詳細を確認できる。


2. 成果物の生成場所が直感とズレる問題

2-1. 現状仕様の明文化

現在、pm repl を実行すると Project が temp ディレクトリ（例: /var/folders/.../pm-runner-xxxxx）に作られる。タスクで生成されたファイルもその temp 配下に出力される。

この設計の意図は以下の通り。
- セッション分離: 各セッションが独立したワークスペースを持つ
- 安全性: ユーザーの既存ファイルを誤って上書きしない
- 再現性: セッション単位でファイル状態を管理できる

しかし、ユーザーの期待と衝突している。ユーザーは pm を実行したカレントディレクトリにファイルができると直感的に期待する。実際には別フォルダに生成されるため、どこにファイルができたのか分からない、成果物をすぐに編集やgit管理できない、ちゃんと動いているのか分からないという不信感につながる。

2-2. 解決案

必須案1: 明示的 Project Root 指定型

pm repl --project . でカレントディレクトリを Project Root にする。pm repl --project /path/to/project で任意のパスを指定する。指定がなければ従来通り temp を使用する。

- 利点: 直感的、既存ワークフローと統合しやすい、git管理下で直接作業可能
- 欠点: 誤操作リスク（重要ファイルの上書き）、既存ファイルとの競合、セッション分離ができない
- 誤操作リスク軽減: 指定時に警告メッセージを表示し、確認を求める

必須案2: temp実行 + export/apply型

タスクは temp で実行する。完了後に /files コマンドで生成されたファイル一覧を表示する。ユーザーが明示的に /export . や /export /path で持ち出す。

- 利点: 安全（元のディレクトリを汚さない）、確認してからexportできる、複数の出力先にexport可能、失敗しても元に戻せる
- 欠点: 2ステップ必要、exportを忘れるリスク、リアルタイムでファイルを確認できない

必須案3: 初回モード選択

起動時にモードを選択させる。選択肢は temp mode（安全、検証向け）、working directory mode（実務向け、カレントに出力）、path指定。

- 利点: 初回に明示的な選択を強制するため混乱を最小化、ユーザーが意識的に決定する
- 欠点: 毎回選択が必要（設定で記憶可能だが実装が必要）、初心者には選択肢が多すぎる可能性

2-3. デフォルト結論

評価軸は以下の4点。
- 初見ユーザーの混乱を最小にするか
- 事故（意図しないファイル生成や上書き）を防げるか
- 既存の .claude 設計と整合するか（グローバル設定は $HOME/.claude、プロジェクト設定は起動ディレクトリの ./.claude）
- 後方互換を維持できるか

結論: デフォルトは temp のまま維持する。ただし --project オプションを追加し、ユーザーが明示的に指定した場合のみ working directory mode で動作する。

理由: temp をデフォルトとすることで既存の動作と後方互換を維持し、事故を防ぐ。--project . を指定すれば直感的な動作になる。既存の .claude 設計とも整合する（temp の場合は temp/.claude、--project . の場合は ./.claude を使用）。

段階的提案:
- 今すぐ: --project オプションを追加、Task Started 時に Project Root を必ず表示
- 将来: /export コマンドを追加、初回起動時のモード選択UIを追加、設定の永続化

2-4. ログとUIとの連携

Task Started（または Task Queued）時に必ず以下を表示する。
- Project Root: 実際のパス（例: /Users/user/my-project または /var/folders/.../pm-runner-xxxxx）
- Project Mode: temp または working-directory または path-specified
- Files will be created here: Project Root と同じパスを明示

表示例: Task Started, Task ID: task-xxx, Project Root: /Users/user/my-project, Mode: working-directory, Files will be created here.

/status または /info コマンドでいつでも以下を確認できるようにする。
- Session ID
- Project Root
- Project Mode
- 現在のセッションで生成されたファイル一覧
- タスク数（完了、実行中、キュー中）


3. まとめ

テーマ1（ログ割り込み問題）の推奨案: 静音モード + 進捗1行をデフォルトとし、/verbose で詳細表示、/logs で後から確認。

テーマ2（ファイル出力場所問題）の推奨案: デフォルトは temp のまま維持し、--project オプションで明示的に指定した場合のみ working directory mode で動作。Task Started 時に Project Root と Mode を必ず表示する。
