{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "version": "2.0.0",
  "description": "TaskCategory definitions for PM Orchestrator (with IMPLEMENTATION_MULTI_AGENT support)",
  "categories": {
    "BACKUP_MIGRATION": {
      "description": "GCS バケットへのバックアップ取得、backupdata ディレクトリの更新、sandbox/production のバックアップ検証タスク",
      "keywords": [
        "backup", "バックアップ", "GCS", "gsutil", "gcloud",
        "backupdata", "migration", "マイグレーション",
        "sandbox", "production", "本番", "検証"
      ],
      "completionRequirements": {
        "check_gcs_paths": {
          "description": "実際に gsutil 等で ls した結果に基づき、存在するパスのみを採用。日付やファイル名を推測して回答してはならない",
          "required": true,
          "evidenceType": "command_output",
          "validationRule": "must_have_actual_ls_output"
        },
        "check_backup_pairs": {
          "description": "sandbox/production それぞれについて、対象のバックアップ日付、対応する検証ログパス、それらの対応関係を明示",
          "required": true,
          "evidenceType": "structured_data",
          "validationRule": "must_have_environment_date_mapping"
        },
        "check_integrity": {
          "description": "必要に応じてファイル数やサイズなど、最低限の整合性チェック",
          "required": false,
          "evidenceType": "command_output",
          "validationRule": "optional_size_count_check"
        }
      },
      "requiredEvidence": {
        "executed_commands": {
          "description": "実際に実行したコマンド例 (gsutil ls … など)",
          "required": true,
          "format": "array_of_strings"
        },
        "command_output_summary": {
          "description": "コマンドの出力サマリ（存在確認の証拠になる範囲）",
          "required": true,
          "format": "string"
        },
        "gcs_paths_by_environment": {
          "description": "sandbox/production ごとの GCS パス一覧",
          "required": true,
          "format": {
            "sandbox": {
              "fhir_validation_logs": ["gs://..."],
              "database_validation_logs": ["gs://..."]
            },
            "production": {
              "fhir_validation_logs": ["gs://..."],
              "database_validation_logs": ["gs://..."]
            }
          }
        }
      },
      "completionStatusRules": {
        "COMPLETE": "全ての requiredEvidence が揃っており、check_gcs_paths と check_backup_pairs が OK",
        "PARTIAL": "一部の evidence が欠けている、または一部の環境のみ確認済み",
        "BLOCKED": "gcloud/gsutil が実行できない、認証エラー、ネットワークエラー等で確認不能"
      },
      "prohibitions": [
        "推測で GCS パスを埋めて COMPLETE にすること",
        "ls 結果なしに「たぶんこのパスだろう」と回答すること",
        "sandbox/production の区別を曖昧にすること",
        "日付の対応関係を明示しないまま完了報告すること"
      ]
    },
    "CODE_CHANGE": {
      "description": "ソースコードの追加・変更・削除を伴うタスク",
      "keywords": [
        "implement", "実装", "add", "追加", "modify", "変更",
        "refactor", "リファクタ", "fix", "修正", "bug"
      ],
      "completionRequirements": {
        "tests_pass": {
          "description": "全てのテストが通過すること",
          "required": true,
          "evidenceType": "command_output"
        },
        "lint_pass": {
          "description": "Lint エラーがないこと",
          "required": true,
          "evidenceType": "command_output"
        },
        "build_pass": {
          "description": "ビルドが成功すること",
          "required": true,
          "evidenceType": "command_output"
        }
      },
      "requiredEvidence": {
        "test_output": {
          "description": "テスト実行結果",
          "required": true,
          "format": "string"
        },
        "changed_files": {
          "description": "変更されたファイル一覧",
          "required": true,
          "format": "array_of_strings"
        }
      }
    },
    "CONFIG_CHANGE": {
      "description": "設定ファイルの変更タスク（CI/CD, hooks, settings 等）",
      "keywords": [
        "config", "設定", "CI", "CD", "hook", "settings",
        "yaml", "yml", "json", ".github"
      ],
      "completionRequirements": {
        "syntax_valid": {
          "description": "設定ファイルの構文が有効であること",
          "required": true,
          "evidenceType": "command_output"
        },
        "template_sync": {
          "description": "テンプレートとの同期が完了していること",
          "required": true,
          "evidenceType": "command_output"
        }
      }
    },
    "PACKAGE_UPDATE": {
      "description": "npm パッケージの更新・配布に関するタスク",
      "keywords": [
        "npm", "publish", "package", "version", "バージョン",
        "release", "リリース", "distribute", "配布"
      ],
      "completionRequirements": {
        "local_tests_pass": {
          "description": "ローカルでのテストが通過すること",
          "required": true,
          "evidenceType": "command_output"
        },
        "external_install_test": {
          "description": "別リポジトリにインストールして動作確認",
          "required": true,
          "evidenceType": "command_output"
        }
      },
      "requiredEvidence": {
        "test_location": {
          "description": "テスト実行場所（local / external）",
          "required": true,
          "format": "enum",
          "values": ["local_only", "external_verified"]
        },
        "external_repo_path": {
          "description": "外部テストを実行したリポジトリのパス",
          "required": false,
          "format": "string"
        },
        "install_log": {
          "description": "npm install の実行ログ",
          "required": true,
          "format": "string"
        }
      },
      "workflow": {
        "steps": [
          "1. このリポジトリ内でのコード・スキルの変更",
          "2. npm pack または npm publish (dry-run)",
          "3. 別のテスト用リポジトリにインストール",
          "4. pm-orchestrator install を実行",
          "5. 実際に1つタスクを回して動作確認",
          "6. 結果とログを evidence として Reporter が出力"
        ]
      }
    },
    "IMPLEMENTATION_MULTI_AGENT": {
      "description": "大規模な実装タスクを複数のチャンクに分割し、並列実行するカテゴリ",
      "keywords": [
        "大規模", "複数の機能", "複数のモジュール", "全体的な", "システム全体",
        "並列で", "同時に", "分割して", "チャンクで",
        "multiple features", "large scale", "parallel", "chunks"
      ],
      "triggerConditions": {
        "task_size": "10ファイル以上の変更が予想される、または 3時間以上の作業と推定される",
        "sub_task_count": "タスク分解で 4 個以上の独立したサブタスクが生成される",
        "independence": "サブタスク間の依存関係が最小限である",
        "user_request": "ユーザーが並列実行を明示的に要求している"
      },
      "completionRequirements": {
        "all_chunks_complete": {
          "description": "全てのチャンクが COMPLETE ステータスであること",
          "required": true,
          "evidenceType": "structured_data",
          "validationRule": "all_chunk_status_complete"
        },
        "all_dod_satisfied": {
          "description": "全チャンクの Definition of Done が満たされていること",
          "required": true,
          "evidenceType": "structured_data",
          "validationRule": "all_chunk_dod_complete"
        },
        "no_conflicts": {
          "description": "チャンク間でファイル変更の競合が発生していないこと",
          "required": true,
          "evidenceType": "structured_data",
          "validationRule": "no_file_conflicts"
        }
      },
      "requiredEvidence": {
        "chunk_plan": {
          "description": "チャンク分割計画（JSON形式）",
          "required": true,
          "format": "json_object",
          "schema": {
            "chunks": "array of chunk objects",
            "execution_plan": "wave-based execution plan"
          }
        },
        "chunk_results": {
          "description": "各チャンクの実行結果",
          "required": true,
          "format": "array_of_objects",
          "fields": [
            "chunk_id",
            "status",
            "completed_dod",
            "incomplete_dod",
            "files_changed",
            "test_results"
          ]
        },
        "integration_status": {
          "description": "統合結果（Integrator 出力）",
          "required": true,
          "format": "json_object",
          "fields": [
            "overall_status",
            "completed_chunks",
            "partial_chunks",
            "blocked_chunks",
            "conflicts_detected",
            "next_steps"
          ]
        }
      },
      "completionStatusRules": {
        "COMPLETE": "全チャンク COMPLETE、全 DoD 満たす、競合なし",
        "PARTIAL": "いずれかのチャンクが PARTIAL または BLOCKED、または一部 DoD 未達成",
        "BLOCKED": "クリティカルチャンク（例: impl-01 設計）が BLOCKED で後続実行不可"
      },
      "prohibitions": [
        "いずれかのチャンクが PARTIAL or BLOCKED の場合に COMPLETE と報告すること",
        "チャンク実行結果を待たずに推測で完了報告すること",
        "ファイル競合を無視して統合すること",
        "依存関係を無視してチャンクを実行すること"
      ],
      "workflow": {
        "phases": [
          "Phase 1: Planner - インテント確認と制約収集",
          "Phase 2: Chunk Planner - タスクをチャンクに分割",
          "Phase 3: Task Agents (parallel) - 各チャンクを並列実行（最大4並列）",
          "Phase 4: Integrator - 結果を統合",
          "Phase 5: Reporter - 最終レポート作成"
        ],
        "max_parallel_agents": 4,
        "chunk_size_guidelines": {
          "token_budget": "4,000 ~ 8,000 tokens per chunk",
          "file_count": "3 ~ 5 files per chunk",
          "time_estimate": "30 ~ 60 minutes per chunk"
        }
      },
      "subagentChain": [
        "Planner",
        "Chunk Planner",
        "Task Agents (parallel)",
        "Integrator",
        "Reporter"
      ]
    }
  },
  "defaultCategory": "CODE_CHANGE",
  "categoryDetectionPriority": [
    "IMPLEMENTATION_MULTI_AGENT",
    "BACKUP_MIGRATION",
    "PACKAGE_UPDATE",
    "CONFIG_CHANGE",
    "CODE_CHANGE"
  ]
}
