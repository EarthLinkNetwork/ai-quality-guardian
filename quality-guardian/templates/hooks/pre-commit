#!/bin/bash
# Quality Guardian pre-commit hook
# lint, test, typecheck, build を実行してコミット品質を保証
# Claude Code 痕跡を検出してブロック（MUST Rule 17）

set -e

echo "🔍 Quality Guardian pre-commit check..."

# エラーカウント
ERRORS=0

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# MUST Rule 17: Claude Code痕跡の検出（Personal Modeで重要）
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

echo ""
echo "  checking: Claude Code traces (MUST Rule 17)"

# ステージングされたファイルを取得
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -n "$STAGED_FILES" ]; then
  TRACE_FOUND=0
  TRACE_FILES=()

  # 禁止パターン
  PATTERNS=(
    "⏺"
    "Co-Authored-By: Claude"
    "Generated with Claude Code"
    "🤖 Generated with"
    "claude.com/claude-code"
    "noreply@anthropic.com"
  )

  # 除外リスト（パターン例を含むファイル）
  EXCLUDE_FILES=(
    "quality-guardian/analysis-must-rules.md"
    "quality-guardian/templates/hooks/pre-commit"
    ".claude/hooks/pre-commit"
    ".claude/hooks/user-prompt-submit.sh"
    "quality-guardian/templates/hooks/user-prompt-submit.sh"
    "quality-guardian/README.md"
  )

  # 各ファイルをチェック
  for FILE in $STAGED_FILES; do
    # 除外リストに含まれるファイルはスキップ
    SKIP=0
    for EXCLUDE in "${EXCLUDE_FILES[@]}"; do
      if [ "$FILE" = "$EXCLUDE" ]; then
        SKIP=1
        break
      fi
    done

    if [ $SKIP -eq 1 ]; then
      continue
    fi

    if [ -f "$FILE" ]; then
      for PATTERN in "${PATTERNS[@]}"; do
        if grep -qF "$PATTERN" "$FILE" 2>/dev/null; then
          TRACE_FOUND=1
          TRACE_FILES+=("$FILE: '$PATTERN'")
        fi
      done
    fi
  done

  # Claude Code痕跡が見つかった場合
  if [ $TRACE_FOUND -eq 1 ]; then
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "❌ MUST Rule 17 違反: Claude Code痕跡を検出"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "以下のファイルに Claude Code 痕跡が含まれています:"
    for TRACE in "${TRACE_FILES[@]}"; do
      echo "  • $TRACE"
    done
    echo ""
    echo "削除すべきパターン:"
    echo "  - ⏺ マーク"
    echo "  - Co-Authored-By: Claude <noreply@anthropic.com>"
    echo "  - 🤖 Generated with [Claude Code](https://claude.com/claude-code)"
    echo "  - claude.com/claude-code へのリンク"
    echo ""
    echo "修正してから再度コミットしてください。"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    exit 1
  fi

  echo "  ✅ Claude Code traces: none detected"
else
  echo "  ⏭  no staged files to check"
fi

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# MUST Rule 4: Git操作前の確認（重要ブランチへの直接コミット禁止）
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 注意: このプロジェクト（ai-quality-guardian）では main への直接コミットを許可
# 他のプロジェクトでは feature ブランチ経由を推奨

echo ""
echo "  checking: Protected branch (MUST Rule 4)"

# 現在のブランチ名を取得
CURRENT_BRANCH=$(git branch --show-current)

# このプロジェクトかどうかを判定
# quality-guardian ディレクトリの存在で判定
if [ -d "quality-guardian" ] && [ -f "quality-guardian/VERSION" ]; then
  # ai-quality-guardian プロジェクト
  # main ブランチへの直接コミットを許可
  echo "  ✅ branch check: passed (ai-quality-guardian project, current: $CURRENT_BRANCH)"
else
  # 他のプロジェクト
  # 保護対象のブランチリスト
  PROTECTED_BRANCHES=(
    "main"
    "master"
    "develop"
    "production"
    "staging"
  )

  # 現在のブランチが保護対象か確認
  BRANCH_PROTECTED=0
  for PROTECTED in "${PROTECTED_BRANCHES[@]}"; do
    if [ "$CURRENT_BRANCH" = "$PROTECTED" ]; then
      BRANCH_PROTECTED=1
      break
    fi
  done

  # 保護ブランチへの直接コミットを禁止
  if [ $BRANCH_PROTECTED -eq 1 ]; then
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "❌ MUST Rule 4 違反: 重要ブランチへの直接コミット"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "現在のブランチ: $CURRENT_BRANCH"
    echo ""
    echo "このブランチには直接コミットできません。"
    echo "featureブランチを作成してください："
    echo "  git checkout -b feature/your-feature-name"
    echo ""
    echo "その後、PRを作成してマージしてください："
    echo "  git push -u origin feature/your-feature-name"
    echo "  gh pr create --base $CURRENT_BRANCH --title \"Your PR Title\""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    exit 1
  fi

  echo "  ✅ branch check: passed (current: $CURRENT_BRANCH)"
fi

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# MUST Rule 16: テンプレート同期チェック
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

echo ""
echo "  checking: Template synchronization (MUST Rule 16)"

# .claude/hooks/ と quality-guardian/templates/hooks/ の同期確認
SYNC_ERROR=0
SYNC_FILES=()

# 比較対象のファイルリスト
HOOK_FILES=(
  "pre-commit"
)

for HOOK_FILE in "${HOOK_FILES[@]}"; do
  TEMPLATE_FILE="quality-guardian/templates/hooks/$HOOK_FILE"
  CLAUDE_FILE=".claude/hooks/$HOOK_FILE"

  # 両方のファイルが存在するか確認
  if [ -f "$TEMPLATE_FILE" ] && [ -f "$CLAUDE_FILE" ]; then
    # ファイルの差分を確認
    if ! diff -q "$TEMPLATE_FILE" "$CLAUDE_FILE" >/dev/null 2>&1; then
      SYNC_ERROR=1
      SYNC_FILES+=("$HOOK_FILE")
    fi
  fi
done

# 同期エラーがある場合
if [ $SYNC_ERROR -eq 1 ]; then
  echo ""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo "❌ MUST Rule 16 違反: テンプレートとの同期ずれ検出"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""
  echo "以下のファイルでテンプレートとの同期ずれが検出されました:"
  for FILE in "${SYNC_FILES[@]}"; do
    echo "  • $FILE"
  done
  echo ""
  echo "テンプレートを更新した場合、.claude/hooks/ にもコピーしてください："
  echo "  cp quality-guardian/templates/hooks/pre-commit .claude/hooks/pre-commit"
  echo ""
  echo "または、.claude/hooks/ を更新した場合、テンプレートにも反映してください："
  echo "  cp .claude/hooks/pre-commit quality-guardian/templates/hooks/pre-commit"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  exit 1
fi

echo "  ✅ template sync: all templates synchronized"

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 実装可能ルールの完全実装チェック
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

echo ""
echo "  checking: Rule implementation status"

# analysis-must-rules.mdが存在するか確認
if [ -f "quality-guardian/analysis-must-rules.md" ]; then
  # 未実装（[ ]）が残っていないかチェック
  UNIMPLEMENTED=$(grep -e '- \[ \]' quality-guardian/analysis-must-rules.md 2>/dev/null | wc -l | tr -d ' ')

  if [ "$UNIMPLEMENTED" -gt 0 ]; then
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "❌ 実装可能と判定したルールに未実装が残っています"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "未実装のルール:"
    grep -e '- \[ \]' quality-guardian/analysis-must-rules.md | sed 's/^/  /'
    echo ""
    echo "「実装可能」と分析したルールは、全て実装する必要があります。"
    echo "一部だけ実装して「他も実装すべきですか?」と聞くことは逃避であり、禁止されています。"
    echo ""
    echo "全て実装してから再度コミットしてください。"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    exit 1
  fi

  echo "  ✅ all analyzed rules: implemented"
else
  echo "  ⏭  analysis-must-rules.md not found, skipping"
fi

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# npm scripts チェック
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# package.jsonが存在するか確認
if [ ! -f "package.json" ]; then
  echo ""
  echo "  ⏭  package.json not found, skipping npm checks"
  echo ""
  echo "✅ All Quality Guardian checks passed!"
  exit 0
fi

echo ""

# 1. Lint実行（存在する場合）
if grep -q '"lint"' package.json 2>/dev/null; then
  echo "  running: npm run lint"
  if npm run lint 2>&1; then
    echo "  ✅ lint passed"
  else
    echo "  ❌ lint failed"
    ERRORS=$((ERRORS + 1))
  fi
else
  echo "  ⏭  lint script not found, skipping"
fi

# 2. Test実行（存在する場合）
if grep -q '"test"' package.json 2>/dev/null; then
  # "test": "echo \"Error: no test specified\" && exit 1" の場合はスキップ
  if grep -q 'Error: no test specified' package.json 2>/dev/null; then
    echo "  ⏭  test script not implemented, skipping"
  else
    echo "  running: npm test"
    if npm test 2>&1; then
      echo "  ✅ test passed"
    else
      echo "  ❌ test failed"
      ERRORS=$((ERRORS + 1))
    fi
  fi
else
  echo "  ⏭  test script not found, skipping"
fi

# 3. TypeCheck実行（存在する場合）
if grep -q '"typecheck"' package.json 2>/dev/null; then
  echo "  running: npm run typecheck"
  if npm run typecheck 2>&1; then
    echo "  ✅ typecheck passed"
  else
    echo "  ❌ typecheck failed"
    ERRORS=$((ERRORS + 1))
  fi
else
  echo "  ⏭  typecheck script not found, skipping"
fi

# 4. Build実行（存在する場合）
if grep -q '"build"' package.json 2>/dev/null; then
  echo "  running: npm run build"
  if npm run build 2>&1; then
    echo "  ✅ build passed"
  else
    echo "  ❌ build failed"
    ERRORS=$((ERRORS + 1))
  fi
else
  echo "  ⏭  build script not found, skipping"
fi

# 結果判定
if [ $ERRORS -gt 0 ]; then
  echo ""
  echo "❌ Quality Guardian: $ERRORS check(s) failed"
  echo ""
  echo "修正してから再度コミットしてください。"
  echo "または、緊急の場合は --no-verify でスキップできます（非推奨）。"
  exit 1
fi

echo ""
echo "✅ All Quality Guardian checks passed!"
exit 0
