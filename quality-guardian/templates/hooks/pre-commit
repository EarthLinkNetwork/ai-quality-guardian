#!/bin/bash
# Quality Guardian pre-commit hook
# lint, test, typecheck, build を実行してコミット品質を保証
# Claude Code 痕跡を検出してブロック（MUST Rule 17）

set -e

echo "🔍 Quality Guardian pre-commit check..."

# エラーカウント
ERRORS=0

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# MUST Rule 17: Claude Code痕跡の検出（Personal Modeで重要）
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

echo ""
echo "  checking: Claude Code traces (MUST Rule 17)"

# ステージングされたファイルを取得
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -n "$STAGED_FILES" ]; then
  TRACE_FOUND=0
  TRACE_FILES=()

  # 禁止パターン
  PATTERNS=(
    "⏺"
    "Co-Authored-By: Claude"
    "Generated with Claude Code"
    "🤖 Generated with"
    "claude.com/claude-code"
    "noreply@anthropic.com"
  )

  # 各ファイルをチェック
  for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
      for PATTERN in "${PATTERNS[@]}"; do
        if grep -qF "$PATTERN" "$FILE" 2>/dev/null; then
          TRACE_FOUND=1
          TRACE_FILES+=("$FILE: '$PATTERN'")
        fi
      done
    fi
  done

  # Claude Code痕跡が見つかった場合
  if [ $TRACE_FOUND -eq 1 ]; then
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "❌ MUST Rule 17 違反: Claude Code痕跡を検出"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "以下のファイルに Claude Code 痕跡が含まれています:"
    for TRACE in "${TRACE_FILES[@]}"; do
      echo "  • $TRACE"
    done
    echo ""
    echo "削除すべきパターン:"
    echo "  - ⏺ マーク"
    echo "  - Co-Authored-By: Claude <noreply@anthropic.com>"
    echo "  - 🤖 Generated with [Claude Code](https://claude.com/claude-code)"
    echo "  - claude.com/claude-code へのリンク"
    echo ""
    echo "修正してから再度コミットしてください。"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    exit 1
  fi

  echo "  ✅ Claude Code traces: none detected"
else
  echo "  ⏭  no staged files to check"
fi

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# npm scripts チェック
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# package.jsonが存在するか確認
if [ ! -f "package.json" ]; then
  echo ""
  echo "  ⏭  package.json not found, skipping npm checks"
  echo ""
  echo "✅ All Quality Guardian checks passed!"
  exit 0
fi

echo ""

# 1. Lint実行（存在する場合）
if grep -q '"lint"' package.json 2>/dev/null; then
  echo "  running: npm run lint"
  if npm run lint 2>&1; then
    echo "  ✅ lint passed"
  else
    echo "  ❌ lint failed"
    ERRORS=$((ERRORS + 1))
  fi
else
  echo "  ⏭  lint script not found, skipping"
fi

# 2. Test実行（存在する場合）
if grep -q '"test"' package.json 2>/dev/null; then
  # "test": "echo \"Error: no test specified\" && exit 1" の場合はスキップ
  if grep -q 'Error: no test specified' package.json 2>/dev/null; then
    echo "  ⏭  test script not implemented, skipping"
  else
    echo "  running: npm test"
    if npm test 2>&1; then
      echo "  ✅ test passed"
    else
      echo "  ❌ test failed"
      ERRORS=$((ERRORS + 1))
    fi
  fi
else
  echo "  ⏭  test script not found, skipping"
fi

# 3. TypeCheck実行（存在する場合）
if grep -q '"typecheck"' package.json 2>/dev/null; then
  echo "  running: npm run typecheck"
  if npm run typecheck 2>&1; then
    echo "  ✅ typecheck passed"
  else
    echo "  ❌ typecheck failed"
    ERRORS=$((ERRORS + 1))
  fi
else
  echo "  ⏭  typecheck script not found, skipping"
fi

# 4. Build実行（存在する場合）
if grep -q '"build"' package.json 2>/dev/null; then
  echo "  running: npm run build"
  if npm run build 2>&1; then
    echo "  ✅ build passed"
  else
    echo "  ❌ build failed"
    ERRORS=$((ERRORS + 1))
  fi
else
  echo "  ⏭  build script not found, skipping"
fi

# 結果判定
if [ $ERRORS -gt 0 ]; then
  echo ""
  echo "❌ Quality Guardian: $ERRORS check(s) failed"
  echo ""
  echo "修正してから再度コミットしてください。"
  echo "または、緊急の場合は --no-verify でスキップできます（非推奨）。"
  exit 1
fi

echo ""
echo "✅ All Quality Guardian checks passed!"
exit 0
