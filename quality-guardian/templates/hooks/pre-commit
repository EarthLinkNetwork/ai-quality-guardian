#!/bin/bash
# Quality Guardian pre-commit hook
# lint, test, typecheck, build ã‚’å®Ÿè¡Œã—ã¦ã‚³ãƒŸãƒƒãƒˆå“è³ªã‚’ä¿è¨¼

set -e

echo "ğŸ” Quality Guardian pre-commit check..."

# ã‚¨ãƒ©ãƒ¼ã‚«ã‚¦ãƒ³ãƒˆ
ERRORS=0

# package.jsonãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
if [ ! -f "package.json" ]; then
  echo "âš ï¸  package.json not found, skipping npm checks"
  exit 0
fi

# 1. Lintå®Ÿè¡Œï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
if grep -q '"lint"' package.json 2>/dev/null; then
  echo "  running: npm run lint"
  if npm run lint 2>&1; then
    echo "  âœ… lint passed"
  else
    echo "  âŒ lint failed"
    ERRORS=$((ERRORS + 1))
  fi
else
  echo "  â­  lint script not found, skipping"
fi

# 2. Testå®Ÿè¡Œï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
if grep -q '"test"' package.json 2>/dev/null; then
  # "test": "echo \"Error: no test specified\" && exit 1" ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  if grep -q 'Error: no test specified' package.json 2>/dev/null; then
    echo "  â­  test script not implemented, skipping"
  else
    echo "  running: npm test"
    if npm test 2>&1; then
      echo "  âœ… test passed"
    else
      echo "  âŒ test failed"
      ERRORS=$((ERRORS + 1))
    fi
  fi
else
  echo "  â­  test script not found, skipping"
fi

# 3. TypeCheckå®Ÿè¡Œï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
if grep -q '"typecheck"' package.json 2>/dev/null; then
  echo "  running: npm run typecheck"
  if npm run typecheck 2>&1; then
    echo "  âœ… typecheck passed"
  else
    echo "  âŒ typecheck failed"
    ERRORS=$((ERRORS + 1))
  fi
else
  echo "  â­  typecheck script not found, skipping"
fi

# 4. Buildå®Ÿè¡Œï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
if grep -q '"build"' package.json 2>/dev/null; then
  echo "  running: npm run build"
  if npm run build 2>&1; then
    echo "  âœ… build passed"
  else
    echo "  âŒ build failed"
    ERRORS=$((ERRORS + 1))
  fi
else
  echo "  â­  build script not found, skipping"
fi

# çµæœåˆ¤å®š
if [ $ERRORS -gt 0 ]; then
  echo ""
  echo "âŒ Quality Guardian: $ERRORS check(s) failed"
  echo ""
  echo "ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚"
  echo "ã¾ãŸã¯ã€ç·Šæ€¥ã®å ´åˆã¯ --no-verify ã§ã‚¹ã‚­ãƒƒãƒ—ã§ãã¾ã™ï¼ˆéæ¨å¥¨ï¼‰ã€‚"
  exit 1
fi

echo "âœ… All Quality Guardian checks passed!"
exit 0
